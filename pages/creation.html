<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Changeover Meeting Initiator - Manufacturing Excellence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        /* Login Match Styles */
        .login-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 40px 100px -12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        @keyframes blob {
            0% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            /* Safe area support for notched devices */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* Touch Optimization CSS */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        button,
        .btn,
        .btn-primary,
        .btn-secondary,
        input[type="submit"],
        select,
        .machine-card {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Ensure inputs don't trigger zoom on iOS (16px minimum) */
        input,
        select,
        textarea {
            font-size: 16px;
        }

        /* Touch-friendly target sizing */
        button,
        .btn,
        .btn-primary,
        input[type="submit"] {
            min-height: 44px;
            min-width: 44px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 32px rgba(31, 38, 135, 0.1);
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            transition: all 0.3s ease;
            transform: translateY(0);
            border: none;
            font-weight: 600;
            letter-spacing: 0.025em;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.25);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .upload-zone:hover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
            transform: translateY(-1px);
        }

        .upload-zone.dragover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.1);
            transform: scale(1.01);
        }

        .status-indicator {
            position: relative;
            overflow: hidden;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .machine-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .machine-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
            border-color: #4f46e5;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .slide-in {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .mobile-menu.active {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }

            .mobile-padding {
                padding: 1rem !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }
        }

        .gradient-text {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .highlight {
            background-color: rgba(79, 70, 229, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #4f46e5;
        }

        .machine-diff-add {
            background-color: #dcfce7;
            color: #166534;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        .machine-diff-remove {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        .smart-analysis {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(124, 58, 237, 0.05));
            border-left: 4px solid #4f46e5;
        }

        .editable-content {
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            min-height: 300px;
            transition: all 0.3s ease;
            background: white;
        }

        .editable-content:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .remarks-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .remarks-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: white;
        }

        .email-preview-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .email-header-preview {
            background-color: #f1f5f9;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .email-body-preview {
            padding: 2rem;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #374151;
        }

        .email-footer-preview {
            background-color: #f1f5f9;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #64748b;
        }

        .email-toolbar {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .email-action-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .email-action-btn:hover {
            transform: translateY(-1px);
        }

        .btn-outlook {
            background-color: #0078d4;
            color: white;
        }

        .btn-preview {
            background-color: #64748b;
            color: white;
        }

        .btn-download {
            background-color: #7c3aed;
            color: white;
        }

        .btn-copy {
            background-color: #10b981;
            color: white;
        }

        .btn-smtp {
            background-color: #d97706;
            color: white;
        }

        .machine-remarks {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.5rem;
            height: auto;
            background: #f8fafc;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #374151;
            line-height: 1.5;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
        }

        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 40;
            background: #4f46e5;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .floating-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(79, 70, 229, 0.4);
        }

        .email-signature {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #4f46e5;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #4f46e5;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .email-template-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .email-template-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
        }

        .email-template-card.selected {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 3rem;
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
        }

        .admin-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .user-management-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-management-table th,
        .user-management-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .user-management-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .activity-log-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .settings-panel {
            max-height: 500px;
            overflow-y: auto;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .smtp-config-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .smtp-test-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .smtp-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .smtp-status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .smtp-status-connected {
            background-color: #dcfce7;
            color: #166534;
        }

        .smtp-status-disconnected {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .smtp-status-testing {
            background-color: #fef3c7;
            color: #92400e;
        }

        .encryption-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .encryption-ssl {
            background-color: #d1fae5;
            color: #065f46;
        }

        .encryption-tls {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .smtp-settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .smtp-settings-row {
                grid-template-columns: 1fr;
            }
        }

        .email-management-table {
            width: 100%;
            border-collapse: collapse;
        }

        .email-management-table th,
        .email-management-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .email-management-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .email-management-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .email-role-cell {
            min-width: 150px;
            font-weight: 500;
        }

        .email-input-cell {
            min-width: 250px;
        }

        .firebase-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .firebase-connected {
            background-color: #dcfce7;
            color: #166534;
        }

        .firebase-disconnected {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .firebase-connecting {
            background-color: #fef3c7;
            color: #92400e;
        }

        .backend-url-input {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .backend-url-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .backend-test-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .backend-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .firebase-log-container {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .firebase-log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }

        .firebase-log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .firebase-log-level-info {
            color: #4f9fff;
        }

        .firebase-log-level-error {
            color: #ff4444;
        }

        .firebase-log-level-success {
            color: #44ff44;
        }

        .bulk-upload-zone {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.05);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .bulk-upload-zone:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .csv-preview {
            max-height: 200px;
            overflow-y: auto;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .csv-preview table {
            width: 100%;
            font-size: 12px;
        }

        .csv-preview th {
            background: #e2e8f0;
            padding: 4px;
            text-align: left;
        }

        .csv-preview td {
            padding: 4px;
            border-bottom: 1px solid #e2e8f0;
        }

        .attachment-container {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .attachment-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .attachment-item:hover {
            background-color: #f0f9ff;
            border-color: #3b82f6;
        }

        .attachment-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .attachment-icon {
            color: #3b82f6;
            font-size: 1.25rem;
        }

        .attachment-details {
            flex: 1;
        }

        .attachment-name {
            font-weight: 500;
            color: #1f2937;
            word-break: break-all;
        }

        .attachment-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .attachment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .attachment-remove-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .attachment-remove-btn:hover {
            background-color: #fee2e2;
        }

        .attachment-preview-btn {
            color: #3b82f6;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .attachment-preview-btn:hover {
            background-color: #dbeafe;
        }

        .attachment-dropzone {
            border: 2px dashed #60a5fa;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(96, 165, 250, 0.05);
        }

        .attachment-dropzone:hover {
            background-color: rgba(96, 165, 250, 0.1);
            border-color: #3b82f6;
        }

        .attachment-dropzone.dragover {
            background-color: rgba(96, 165, 250, 0.2);
            border-color: #2563eb;
            transform: scale(1.02);
        }

        .attachment-total-size {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
            text-align: right;
        }

        .attachment-total-size.warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .attachment-total-size.error {
            color: #ef4444;
            font-weight: 600;
        }

        .file-preview-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .file-preview-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .file-preview-body {
            padding: 1.5rem;
            overflow: auto;
            max-height: 70vh;
        }

        .file-preview-title {
            font-weight: 600;
            color: #1f2937;
        }

        .file-preview-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .file-preview-close:hover {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        .file-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .file-preview-placeholder-icon {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .home-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            color: #4f46e5;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            z-index: 10;
        }

        .home-btn:hover {
            background: #4f46e5;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .qco-highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .changeover-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .changeover-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #4f46e5;
        }

        .qco-code {
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: #4f46e5;
            background: #eef2ff;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
        }
    </style>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCayfWGQP1t3oBU9eFj-3Ww0uu7nSl3Q4g",
            authDomain: "sidneymailer.firebaseapp.com",
            projectId: "sidneymailer",
            storageBucket: "sidneymailer.firebasestorage.app",
            messagingSenderId: "911316068119",
            appId: "1:911316068119:web:ce23dbe663dc385a81f952",
            measurementId: "G-NJ0QH6DEXG"
        };

        // Backend configuration
        // Backend configuration - Dynamic for Vercel vs Local
        const BACKEND_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? "http://localhost:3000"
            : window.location.origin;
    </script>
</head>

<body class="p-4 md:p-6 lg:p-8">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4 overflow-hidden"
        style="background-color: #f8fafc;">
        <!-- Animated Background Blobs -->
        <div class="absolute inset-0 z-0 overflow-hidden">
            <div
                class="absolute top-[-10%] left-[-10%] w-[60vw] h-[60vw] bg-blue-200/30 rounded-full mix-blend-multiply filter blur-[80px] animate-blob">
            </div>
            <div
                class="absolute top-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-indigo-200/30 rounded-full mix-blend-multiply filter blur-[80px] animate-blob animation-delay-2000">
            </div>
            <div
                class="absolute bottom-[-20%] left-[20%] w-[60vw] h-[60vw] bg-pink-200/30 rounded-full mix-blend-multiply filter blur-[80px] animate-blob animation-delay-4000">
            </div>
        </div>

        <div
            class="login-card login-glass w-full max-w-md rounded-[2rem] p-12 relative z-10 transform translate-y-0 opacity-100">
            <!-- Home Button -->
            <a href="../index.html"
                class="absolute top-6 left-6 text-slate-400 hover:text-slate-600 transition-colors z-20">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>

            <div class="text-center mb-10">
                <div
                    class="logo-icon w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl mx-auto flex items-center justify-center text-white shadow-xl shadow-blue-500/20 mb-6">
                    <i class="fas fa-industry text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 mb-2">
                    QCO Portal
                </h1>
                <p class="text-slate-500 text-sm tracking-wide font-medium">Changeover Meeting Initiator</p>
            </div>

            <div class="space-y-6">
                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Password
                        Access</label>
                    <div class="relative group">
                        <input type="password" id="loginPassword"
                            class="w-full pl-5 pr-12 py-4 bg-white/50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all shadow-sm group-hover:bg-white text-lg tracking-widest"
                            placeholder="••••••••" onkeypress="if(event.key === 'Enter') authenticateUser()">
                        <button onclick="togglePasswordVisibility()"
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors p-2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div id="loginError"
                        class="text-red-500 text-sm mt-3 hidden font-medium flex items-center gap-2 pl-1">
                        <i class="fas fa-exclamation-circle text-red-500"></i> Invalid password
                    </div>
                </div>

                <button onclick="authenticateUser()"
                    class="w-full bg-slate-900 text-white font-semibold py-4 rounded-xl shadow-lg hover:shadow-2xl hover:scale-[1.02] transition-all transform relative overflow-hidden group active:scale-[0.98]">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fas fa-sign-in-alt"></i> Access System
                    </span>
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity duration-500 ease-out">
                    </div>
                </button>

                <p class="text-center text-[10px] text-slate-400 uppercase tracking-widest">
                    Authorized Personnel Only
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Notification System -->
        <div id="notificationContainer"></div>

        <!-- Floating Action Button -->
        <div class="floating-action-btn no-print" onclick="scrollToTop()">
            <i class="fas fa-chevron-up"></i>
        </div>

        <!-- Mobile Menu Button -->
        <button id="mobileMenuBtn" class="mobile-only fixed top-4 left-4 z-50 bg-white p-3 rounded-full shadow-lg">
            <i class="fas fa-bars text-gray-600"></i>
        </button>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="mobile-menu fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden">
            <div class="bg-white w-80 h-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text">Navigation</h2>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <nav class="space-y-4">
                    <a href="#uploadSection" onclick="toggleMobileMenu()"
                        class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-upload mr-3 text-blue-500"></i>Upload OB Files
                    </a>
                    <a href="#configurationSection" onclick="toggleMobileMenu()"
                        class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-cog mr-3 text-green-500"></i>Configuration
                    </a>
                    <a href="#resultsSection" onclick="toggleMobileMenu()"
                        class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-chart-bar mr-3 text-purple-500"></i>Results
                    </a>
                    <a href="#emailSection" onclick="toggleMobileMenu()"
                        class="block p-3 rounded-lg hover:bg-gray-100 transition-colors no-print">
                        <i class="fas fa-envelope mr-3 text-red-500"></i>Email Draft
                    </a>
                    <a href="#analysisSection" onclick="toggleMobileMenu()"
                        class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-brain mr-3 text-indigo-500"></i>Analysis
                    </a>
                    <!-- Admin Only Links -->
                    <div id="adminMobileLinks" class="hidden">
                        <a href="#adminSection" onclick="toggleMobileMenu()"
                            class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-users-cog mr-3 text-yellow-500"></i>User Management
                        </a>
                        <a href="#emailManagementSection" onclick="toggleMobileMenu()"
                            class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-at mr-3 text-blue-500"></i>Email ID Management
                        </a>
                        <a href="#changeoverManagementSection" onclick="toggleMobileMenu()"
                            class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-list-ol mr-3 text-purple-500"></i>Changeover Records
                        </a>
                        <a href="#activityLogSection" onclick="toggleMobileMenu()"
                            class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-history mr-3 text-orange-500"></i>Activity Log
                        </a>
                        <a href="#settingsSection" onclick="toggleMobileMenu()"
                            class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-sliders-h mr-3 text-cyan-500"></i>Settings
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center glass-panel p-6 slide-in">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-xl">
                    <i class="fas fa-industry text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Changeover Meeting Initiator</h1>
                    <p class="text-gray-600 text-sm md:text-base">Manufacturing Excellence</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-6">
                <div class="text-right">
                    <div class="text-sm text-gray-500">Logged in as</div>
                    <div id="currentUserName" class="text-gray-800 font-semibold">--</div>
                </div>
                <div class="text-right desktop-only">
                    <div class="text-sm text-gray-500">Session Started</div>
                    <div class="text-gray-800 font-semibold" id="sessionStartTime">--</div>
                </div>
                <div class="text-right">
                    <button onclick="logout()" class="btn-primary py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Admin Tabs (Visible only to Admin) -->
        <div id="adminTabs" class="hidden mb-6">
            <div class="flex space-x-2 border-b border-gray-200 overflow-x-auto">
                <button
                    class="admin-tab active px-4 py-2 text-sm font-medium text-gray-700 border-b-2 border-blue-500 whitespace-nowrap"
                    data-tab="adminSection">
                    <i class="fas fa-users-cog mr-2"></i> User Management
                </button>
                <button
                    class="admin-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap"
                    data-tab="emailManagementSection">
                    <i class="fas fa-at mr-2"></i> Email ID Management
                </button>
                <button
                    class="admin-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap"
                    data-tab="changeoverManagementSection">
                    <i class="fas fa-list-ol mr-2"></i> Changeover Records
                </button>
                <button
                    class="admin-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap"
                    data-tab="activityLogSection">
                    <i class="fas fa-history mr-2"></i> Activity Log
                </button>
                <button
                    class="admin-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap"
                    data-tab="settingsSection">
                    <i class="fas fa-sliders-h mr-2"></i> Settings
                </button>
            </div>
        </div>

        <!-- Admin Sections -->
        <div id="adminSection" class="admin-section hidden">
            <div class="glass-panel p-6 mb-6">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-users-cog mr-2 text-yellow-500"></i> User Management
                    <span class="admin-badge">Admin Only</span>
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Add User Form -->
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h3 class="font-bold mb-4 text-gray-800" id="userFormTitle">Add New User</h3>
                        <div class="space-y-4">
                            <input type="hidden" id="editUserId">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="newUserName"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password <span
                                        id="passwordHint" class="text-xs text-gray-500">(Leave blank to keep unchanged
                                        when editing)</span></label>
                                <input type="password" id="newUserPassword"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div id="confirmPasswordDiv">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                                <input type="password" id="newUserConfirmPassword"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                <select id="newUserRole" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="user">Regular User</option>
                                    <option value="planning">Planning User</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" id="newUserEmail"
                                    class="w-full p-2 border border-gray-300 rounded-lg"
                                    placeholder="username@domain.com">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveUser()" class="flex-1 btn-primary py-2 rounded-lg"
                                    id="saveUserBtn">
                                    <i class="fas fa-user-plus mr-2"></i> Add User
                                </button>
                                <button onclick="cancelEdit()"
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 hidden"
                                    id="cancelEditBtn">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User List -->
                    <div>
                        <h3 class="font-bold mb-4 text-gray-800">System Users</h3>
                        <div class="overflow-x-auto">
                            <table class="user-management-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userList">
                                    <!-- User list will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email ID Management Section (Admin Only) -->
        <div id="emailManagementSection" class="admin-section hidden">
            <div class="glass-panel p-6 mb-6">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-at mr-2 text-blue-500"></i> Email ID Management
                    <span class="admin-badge">Admin Only</span>
                    <span id="firebaseStatus" class="firebase-status firebase-disconnected">Firebase:
                        Disconnected</span>
                </h2>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-gray-800">Manage Email IDs for Personnel</h3>
                            <p class="text-sm text-gray-600">Set individual email IDs for each personnel role per line
                            </p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="refreshEmailData()"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-sync-alt mr-2"></i> Refresh
                            </button>
                            <button onclick="syncEmailData()"
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                <i class="fas fa-cloud-upload-alt mr-2"></i> Sync to Cloud
                            </button>
                            <button onclick="loadEmailDataFromLocal()"
                                class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-cloud-download-alt mr-2"></i> Load from Local
                            </button>
                        </div>
                    </div>

                    <!-- Bulk Upload Section -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 text-gray-700">Bulk Upload via CSV</h4>
                        <div class="bulk-upload-zone" onclick="document.getElementById('bulkUploadFile').click()">
                            <i class="fas fa-file-csv text-3xl text-blue-500 mb-2"></i>
                            <p class="text-gray-600">Drop CSV file here or click to browse</p>
                            <p class="text-xs text-gray-500 mt-1">Format:
                                line,supervisor,rqc,ie,lineIncharge,qam,mechIncharge,technical</p>
                            <input type="file" id="bulkUploadFile" accept=".csv" class="hidden"
                                onchange="handleBulkUpload(this)">
                        </div>
                        <div id="csvPreview" class="csv-preview hidden"></div>
                        <button id="processBulkUpload" onclick="processBulkUpload()"
                            class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 hidden">
                            <i class="fas fa-upload mr-2"></i> Process Upload
                        </button>
                    </div>

                    <div class="email-management-container">
                        <table class="email-management-table">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Supervisor</th>
                                    <th>RQC</th>
                                    <th>IE</th>
                                    <th>Line Incharge</th>
                                    <th>QAM</th>
                                    <th>Mech Incharge</th>
                                    <th>Technical</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emailManagementTable">
                                <!-- Email data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Firebase Log Hidden -->
                <div class="mt-6 hidden">
                    <h3 class="font-bold mb-2 text-gray-700">Firebase Connection Log</h3>
                    <div class="firebase-log-container" id="firebaseLog"></div>
                </div>


            </div>
        </div>

        <!-- Changeover Management Section (Admin Only) -->
        <div id="changeoverManagementSection" class="admin-section hidden">
            <div class="glass-panel p-6 mb-6">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-list-ol mr-2 text-purple-500"></i> Changeover Records Management
                    <span class="admin-badge">Admin Only</span>
                </h2>

                <div class="mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div>
                            <h3 class="font-bold text-gray-800">All Changeover Records</h3>
                            <p class="text-sm text-gray-600">View and manage all changeover plans by QCO Number</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <input type="text" id="searchQCO" placeholder="Search QCO Code..."
                                class="flex-1 md:w-64 p-2 border border-gray-300 rounded-lg"
                                oninput="filterChangeovers()">
                            <select id="filterLine" class="p-2 border border-gray-300 rounded-lg"
                                onchange="filterChangeovers()">
                                <option value="">All Lines</option>
                                <option value="1">Line 1</option>
                                <option value="1A">Line 1A</option>
                                <option value="2">Line 2</option>
                                <option value="3">Line 3</option>
                                <option value="6+17">Line 6+17</option>
                                <option value="7">Line 7</option>
                                <option value="7A">Line 7A</option>
                                <option value="8+5">Line 8+5</option>
                                <option value="9">Line 9</option>
                                <option value="10">Line 10</option>
                                <option value="11+15">Line 11+15</option>
                                <option value="12">Line 12</option>
                                <option value="13/21">Line 13/21</option>
                                <option value="14">Line 14</option>
                                <option value="16">Line 16</option>
                                <option value="16A">Line 16A</option>
                                <option value="18">Line 18</option>
                                <option value="19">Line 19</option>
                                <option value="20">Line 20</option>
                                <option value="22">Line 22</option>
                                <option value="23">Line 23</option>
                                <option value="24">Line 24</option>
                                <option value="25">Line 25</option>
                                <option value="26/4">Line 26/4</option>
                                <option value="28">Line 28</option>
                                <option value="29">Line 29</option>
                                <option value="30">Line 30</option>
                                <option value="31">Line 31</option>
                                <option value="32">Line 32</option>
                            </select>
                            <button onclick="refreshChangeoverData()"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div id="changeoverList" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Changeover records will be populated here -->
                    </div>

                    <div id="noChangeovers" class="hidden text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>No changeover records found</p>
                    </div>
                </div>


            </div>
        </div>

        <!-- Changeover Detail Modal -->
        <div id="changeoverModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Changeover Details</h3>
                        <p class="text-sm text-gray-500" id="modalQCOCode">L-XXXX-XXXX-XX</p>
                    </div>
                    <button onclick="closeChangeoverModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 uppercase">Current Style</p>
                            <p class="font-bold text-lg" id="modalCurrentStyle">-</p>
                            <p class="text-sm text-gray-600">SMV: <span id="modalCurrentSMV">-</span></p>
                            <p class="text-sm text-gray-600">Target: <span id="modalCurrentTarget">-</span></p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 uppercase">Upcoming Style</p>
                            <p class="font-bold text-lg" id="modalUpcomingStyle">-</p>
                            <p class="text-sm text-gray-600">SMV: <span id="modalUpcomingSMV">-</span></p>
                            <p class="text-sm text-gray-600">Target: <span id="modalUpcomingTarget">-</span></p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-700">Line Number</p>
                            <p class="text-gray-900" id="modalLine">-</p>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-700">Created Date</p>
                            <p class="text-gray-900" id="modalCreatedDate">-</p>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-700">Email Sent</p>
                            <p class="text-gray-900" id="modalEmailSent">-</p>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">Machine Changes Summary</p>
                        <div id="modalMachineSummary" class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                            -
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                    <div class="flex gap-2">
                        <div id="modalAdminActions" class="hidden flex gap-2">
                            <button onclick="editCurrentChangeover()"
                                class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 shadow-sm transition-colors duration-200 flex items-center">
                                <i class="fas fa-edit mr-2"></i> Edit
                            </button>
                            <button onclick="deleteCurrentChangeover()"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 shadow-sm transition-colors duration-200 flex items-center">
                                <i class="fas fa-trash mr-2"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div id="modalUserActions" class="flex gap-2">
                            <!-- User dynamic buttons injected here -->
                        </div>
                        <button onclick="closeChangeoverModal()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 shadow-sm transition-colors duration-200 font-medium">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log Section (Admin Only) -->
        <div id="activityLogSection" class="admin-section hidden">
            <div class="glass-panel p-6 mb-6">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-history mr-2 text-orange-500"></i> Activity Log
                    <span class="admin-badge">Admin Only</span>
                </h2>

                <div class="activity-log-container">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-500">
                            <span id="totalActivities">0</span> activities recorded
                        </div>
                        <button onclick="clearActivityLog()" class="text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-trash-alt mr-1"></i> Clear Log
                        </button>
                    </div>

                    <div class="timeline" id="activityTimeline">
                        <!-- Activities will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="admin-section hidden">
            <div class="glass-panel p-6 mb-6 settings-panel">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-sliders-h mr-2 text-cyan-500"></i> Application Settings
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Email Settings -->
                    <div class="bg-blue-50 p-5 rounded-lg border border-blue-100">
                        <h3 class="font-bold mb-3 text-blue-800">Email Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default CC Addresses</label>
                                <input type="text" id="defaultCC" class="w-full p-2 border border-gray-300 rounded-lg"
                                    placeholder="shantanu.guin281203@gmail.com" onchange="saveSettings()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Meeting Time</label>
                                <input type="time" id="defaultMeetingTime"
                                    class="w-full p-2 border border-gray-300 rounded-lg" onchange="saveSettings()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Backend API URL</label>
                                <input type="text" id="backendUrl"
                                    class="w-full p-2 border border-gray-300 rounded-lg backend-url-input"
                                    onchange="saveSettings()">
                                <p class="text-xs text-gray-500 mt-1">URL of your Nodemailer backend server</p>
                            </div>
                        </div>
                    </div>

                    <!-- Backend SMTP Configuration -->
                    <div class="smtp-config-panel">
                        <h3 class="font-bold mb-3 text-blue-800 flex items-center">
                            <i class="fas fa-server mr-2"></i> Backend SMTP Configuration
                            <span id="smtpStatus"
                                class="smtp-status-indicator smtp-status-disconnected ml-2">Disconnected</span>
                        </h3>
                        <div class="mb-4">
                            <p class="text-sm text-gray-700 mb-3">SMTP settings are configured on the server. Use the
                                test button to verify the connection.</p>
                            <div class="flex space-x-3">
                                <button onclick="testNodemailerConnection()" class="backend-test-btn">
                                    <i class="fas fa-plug mr-2"></i> Test Backend Connection
                                </button>
                            </div>
                        </div>
                        <div id="smtpTestResult" class="mt-3 text-sm hidden"></div>
                    </div>

                    <!-- Application Settings -->
                    <div class="bg-green-50 p-5 rounded-lg border border-green-100">
                        <h3 class="font-bold mb-3 text-green-800">Application Preferences</h3>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="autoSaveEnabled" class="mr-2" checked
                                    onchange="saveSettings()">
                                <label class="text-sm text-gray-700">Auto-save changes</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="notificationsEnabled" class="mr-2" checked
                                    onchange="saveSettings()">
                                <label class="text-sm text-gray-700">Enable notifications</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="autoGenerateEmailEnabled" class="mr-2" checked
                                    onchange="saveSettings()">
                                <label class="text-sm text-gray-700">Auto-generate email on analysis</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="darkModeEnabled" class="mr-2" onchange="toggleDarkMode()">
                                <label class="text-sm text-gray-700">Dark mode</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="includeOriginalFiles" class="mr-2" checked
                                    onchange="saveSettings()">
                                <label class="text-sm text-gray-700">Include uploaded OB files as attachments</label>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-red-50 p-5 rounded-lg border border-red-100">
                        <h3 class="font-bold mb-3 text-red-800">Data Management</h3>
                        <div class="space-y-3">
                            <button onclick="exportAllData()"
                                class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-download mr-2"></i> Export All Data
                            </button>
                            <button onclick="importData()"
                                class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                <i class="fas fa-upload mr-2"></i> Import Data
                            </button>
                            <button onclick="clearLocalData()"
                                class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash-alt mr-2"></i> Clear Local Data
                            </button>
                        </div>
                    </div>

                    <!-- System Info -->
                    <div class="bg-purple-50 p-5 rounded-lg border border-purple-100">
                        <h3 class="font-bold mb-3 text-purple-800">System Information</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Version:</span>
                                <span class="font-medium">2.6.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Last Updated:</span>
                                <span id="appLastUpdated" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Active Users:</span>
                                <span id="activeUsersCount" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Activities:</span>
                                <span id="systemActivitiesCount" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Backend Status:</span>
                                <span id="backendStatus" class="font-medium">Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <button onclick="resetToDefaults()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        <i class="fas fa-undo mr-2"></i> Reset to Defaults
                    </button>
                    <button onclick="saveSettings()" class="ml-4 px-4 py-2 btn-primary rounded-lg">
                        <i class="fas fa-save mr-2"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- File Upload Section -->
                <div class="glass-panel p-6" id="uploadSection">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-file-upload mr-2 text-blue-500"></i> Upload OB Files
                    </h2>

                    <!-- Current Style Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            Current Running Style (OB)
                            <span class="text-red-500 ml-1">*</span>
                            <span class="tooltip ml-2">
                                <i class="fas fa-info-circle text-gray-400"></i>
                                <span class="tooltip-text">Upload the current style's Operation Bulletin file</span>
                            </span>
                        </label>
                        <div id="currentFileDropZone" class="upload-zone p-6 rounded-xl text-center cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Drop current OB file here or click to browse</p>
                            <p class="text-xs text-gray-500 mt-2">Supports: .xlsx, .xls, .csv</p>
                            <input type="file" id="currentFile" accept=".xlsx,.xls,.csv" class="hidden">
                        </div>
                        <div id="currentFileInfo" class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100 hidden">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    <div>
                                        <span id="currentFileName" class="font-medium"></span>
                                        <div class="text-xs text-gray-500" id="currentFileSize"></div>
                                    </div>
                                </div>
                                <button id="removeCurrentFile" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Style Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            Upcoming Style (OB)
                            <span class="text-red-500 ml-1">*</span>
                            <span class="tooltip ml-2">
                                <i class="fas fa-info-circle text-gray-400"></i>
                                <span class="tooltip-text">Upload the upcoming style's Operation Bulletin file</span>
                            </span>
                        </label>
                        <div id="upcomingFileDropZone" class="upload-zone p-6 rounded-xl text-center cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Drop upcoming OB file here or click to browse</p>
                            <p class="text-xs text-gray-500 mt-2">Supports: .xlsx, .xls, .csv</p>
                            <input type="file" id="upcomingFile" accept=".xlsx,.xls,.csv" class="hidden">
                        </div>
                        <div id="upcomingFileInfo"
                            class="mt-3 p-3 bg-green-50 rounded-lg border border-green-100 hidden">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    <div>
                                        <span id="upcomingFileName" class="font-medium"></span>
                                        <div class="text-xs text-gray-500" id="upcomingFileSize"></div>
                                    </div>
                                </div>
                                <button id="removeUpcomingFile" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Line Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Select Sew Number / Line
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="lineSelect"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">Choose a line...</option>
                            <option value="1">Line 1 - ADIDAS</option>
                            <option value="1A">Line 1A - TNF</option>
                            <option value="2">Line 2 - LULU</option>
                            <option value="3">Line 3 - ADIDAS</option>
                            <option value="6+17">Line 6+17 - ADIDAS</option>
                            <option value="7">Line 7 - TNF</option>
                            <option value="7A">Line 7A - ADIDAS</option>
                            <option value="8+5">Line 8+5 - ADIDAS</option>
                            <option value="9">Line 9 - ALO</option>
                            <option value="10">Line 10 - TNF</option>
                            <option value="11+15">Line 11+15 - ADIDAS</option>
                            <option value="12">Line 12 - ADIDAS</option>
                            <option value="13/21">Line 13/21 - WALLMART</option>
                            <option value="14">Line 14 - TNF</option>
                            <option value="16">Line 16 - ALO</option>
                            <option value="16A">Line 16A - ALO</option>
                            <option value="18">Line 18 - ALO</option>
                            <option value="19">Line 19 - ADIDAS</option>
                            <option value="20">Line 20 - ADIDAS</option>
                            <option value="22">Line 22 - ADIDAS</option>
                            <option value="23">Line 23 - TNF</option>
                            <option value="24">Line 24 - ADIDAS</option>
                            <option value="25">Line 25 - ADIDAS</option>
                            <option value="26/4">Line 26/4 - ADIDAS</option>
                            <option value="28">Line 28 - TNF</option>
                            <option value="29">Line 29 - ADIDAS</option>
                            <option value="30">Line 30 - TNF</option>
                            <option value="31">Line 31 - ADIDAS</option>
                            <option value="32">Line 32 - ALO</option>
                        </select>
                        <div id="subLineContainer" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <label class="block text-sm font-medium text-blue-800 mb-2">Select Exact Line Number <span
                                    class="text-red-500">*</span></label>
                            <div class="flex space-x-6" id="subLineOptions">
                                <!-- Radio buttons will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Processing Options -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Processing Options</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="autoDetectMachines" class="mr-2 rounded" checked>
                                <span class="text-sm text-gray-700">Auto-detect machine types</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeSpecialMachines" class="mr-2 rounded" checked>
                                <span class="text-sm text-gray-700">Include special machines</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="calculateEfficiency" class="mr-2 rounded" checked>
                                <span class="text-sm text-gray-700">Calculate efficiency impact</span>
                            </label>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn" onclick="processFiles()"
                        class="w-full btn-primary py-4 rounded-xl font-semibold shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                        disabled>
                        <i class="fas fa-cogs mr-2"></i> Generate Changeover Plan
                    </button>

                    <!-- Progress Bar -->
                    <div id="progressContainer" class="mt-4 hidden">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Processing...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-100">
                            <div class="text-2xl font-bold text-blue-600" id="totalComparisons">0</div>
                            <div class="text-xs text-blue-500">Comparisons Made</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center border border-green-100">
                            <div class="text-2xl font-bold text-green-600" id="totalMachines">0</div>
                            <div class="text-xs text-green-500">Machines Analyzed</div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Section -->
                <div class="glass-panel p-6" id="configurationSection">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-users-cog mr-2 text-green-500"></i> Line Configuration
                    </h2>
                    <p class="text-xs text-gray-500 mb-4">Personnel mapping based on Sew Number allocation</p>

                    <div id="personnelInfo" class="mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                            <span class="font-medium text-yellow-800">Personnel Information</span>
                        </div>
                        <div id="personnelDetails" class="text-sm text-yellow-700"></div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">Supervisor:</label>
                            <input type="text" id="supervisorName"
                                class="flex-1 border p-2 rounded-lg text-sm bg-gray-50" readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">RQC:</label>
                            <input type="text" id="rqcName" class="flex-1 border p-2 rounded-lg text-sm bg-gray-50"
                                readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">IE:</label>
                            <input type="text" id="ieName" class="flex-1 border p-2 rounded-lg text-sm bg-gray-50"
                                readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">Line Incharge:</label>
                            <input type="text" id="lineIncharge" class="flex-1 border p-2 rounded-lg text-sm bg-gray-50"
                                readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">QAM:</label>
                            <input type="text" id="qamName" class="flex-1 border p-2 rounded-lg text-sm bg-gray-50"
                                readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">Mech Incharge:</label>
                            <input type="text" id="mechIncharge" class="flex-1 border p-2 rounded-lg text-sm bg-gray-50"
                                readonly>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="w-1/3 text-sm font-medium text-gray-700">Technical:</label>
                            <input type="text" id="technicalName"
                                class="flex-1 border p-2 rounded-lg text-sm bg-gray-50" readonly>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Email Configuration</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="includeMaintenance" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Include Maintenance Department</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeManagement" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Include Management</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoGenerateEmail" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Auto-generate email</span>
                            </label>
                        </div>
                    </div>

                    <!-- Email Recipients -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Recipients</label>
                        <select id="additionalRecipients" class="w-full" multiple="multiple">
                            <option value="production@sidneyapparel.com">Production Department</option>
                            <option value="planning@sidneyapparel.com">Planning Department</option>
                            <option value="ie@sidneyapparel.com">IE Department</option>
                            <option value="quality@sidneyapparel.com">Quality Department</option>
                            <option value="maintenance@sidneyapparel.com">Maintenance Department</option>
                        </select>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-panel p-6 hidden desktop-only" id="recentActivity">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-purple-500"></i> Recent Activity
                    </h2>
                    <div class="space-y-3">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="text-sm font-medium">System initialized</div>
                                <div class="text-xs text-gray-500">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Results Area -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Results Section -->
                <div class="space-y-6 hidden" id="resultsSection">
                    <!-- QCO Number Display -->
                    <div
                        class="glass-panel p-6 border-l-4 border-indigo-500 slide-in bg-gradient-to-r from-indigo-50 to-purple-50">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Changeover
                                    Reference Number</h3>
                                <div class="qco-highlight" id="qcoNumberDisplay">S-X-XXX-XXX-XX</div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Created by</p>
                                <p class="font-semibold text-gray-800" id="qcoCreatedBy">--</p>
                                <p class="text-xs text-gray-500 mt-1" id="qcoCreatedDate">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Style Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-6 border-l-4 border-blue-500 slide-in">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Current Style</h3>
                                <span class="badge badge-success">Running</span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800 mb-2" id="currStyleName">--</div>
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">SMV</div>
                                    <div class="font-mono font-bold text-lg" id="currSMV">--</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">Target</div>
                                    <div class="font-mono font-bold text-lg" id="currTarget">--</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">Machines</div>
                                    <div class="font-mono font-bold text-lg" id="currTotalMachines">--</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Last Updated:</span>
                                    <span class="font-medium" id="currLastUpdated">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 border-l-4 border-green-500 slide-in">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Upcoming Style</h3>
                                <span class="badge badge-warning">Planned</span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800 mb-2" id="nextStyleName">--</div>
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">SMV</div>
                                    <div class="font-mono font-bold text-lg" id="nextSMV">--</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">Target</div>
                                    <div class="font-mono font-bold text-lg" id="nextTarget">--</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border">
                                    <div class="text-gray-500">Machines</div>
                                    <div class="font-mono font-bold text-lg" id="nextTotalMachines">--</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Change Date:</span>
                                    <span class="font-medium" id="nextChangeDate">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Change Summary -->
                    <div class="glass-panel p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-exchange-alt mr-2 text-purple-500"></i> Change Summary
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-red-600 text-sm font-medium">SMV Change</div>
                                        <div class="text-xl font-bold text-red-700" id="smvChange">--</div>
                                    </div>
                                    <i class="fas fa-chart-line text-red-500 text-xl"></i>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-blue-600 text-sm font-medium">Target Change</div>
                                        <div class="text-xl font-bold text-blue-700" id="targetChange">--</div>
                                    </div>
                                    <i class="fas fa-bullseye text-blue-500 text-xl"></i>
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-green-600 text-sm font-medium">Efficiency Impact</div>
                                        <div class="text-xl font-bold text-green-700" id="efficiencyImpact">--</div>
                                    </div>
                                    <i class="fas fa-percentage text-green-500 text-xl"></i>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-purple-600 text-sm font-medium">Machine Delta</div>
                                        <div class="text-xl font-bold text-purple-700" id="machineDelta">--</div>
                                    </div>
                                    <i class="fas fa-cogs text-purple-500 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Machine Requirement Analysis -->
                    <div class="glass-panel overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <h2 class="font-bold text-lg mb-2 md:mb-0">Machine Requirement Analysis</h2>
                                <div class="flex items-center space-x-4">
                                    <span class="text-sm bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                        Total Delta: <span id="totalDelta" class="font-bold">0</span> machines
                                    </span>
                                    <div class="flex space-x-2">
                                        <button onclick="exportResults()"
                                            class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors flex items-center">
                                            <i class="fas fa-download mr-1"></i> Export
                                        </button>
                                        <button onclick="toggleRemarks()"
                                            class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors flex items-center">
                                            <i class="fas fa-edit mr-1"></i> Remarks
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left font-medium">Machine Type</th>
                                        <th class="px-6 py-4 text-center font-medium">Current</th>
                                        <th class="px-6 py-4 text-center font-medium">Required</th>
                                        <th class="px-6 py-4 text-center font-medium">Delta</th>
                                        <th class="px-6 py-4 text-center font-medium">Status</th>
                                        <th class="px-6 py-4 text-center font-medium">Priority</th>
                                        <th class="px-6 py-4 text-left font-medium">Remarks/Action</th>
                                    </tr>
                                </thead>
                                <tbody id="machineTableBody" class="divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Detailed Machine Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="machineCards">
                    </div>
                </div>

                <!-- Email Section -->
                <div class="lg:col-span-2 space-y-6 hidden no-print" id="emailSection">
                    <div class="glass-panel p-6">
                        <div
                            class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 space-y-4 md:space-y-0">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-2">Changeover Meeting Email</h2>
                                <p class="text-sm text-gray-600">Auto-generated based on machine analysis and personnel
                                    allocation</p>
                                <div class="mt-2 qco-highlight" id="emailQCONumber">S-X-XXX-XXX-XX</div>
                            </div>
                            <div class="flex space-x-3 flex-wrap gap-2">
                                <button onclick="sendEmailSMTP()" class="email-action-btn btn-smtp">
                                    <i class="fas fa-envelope mr-2"></i> Send via Nodemailer
                                </button>
                                <button onclick="printEmail()" class="email-action-btn bg-gray-600 text-white">
                                    <i class="fas fa-print mr-2"></i> Print
                                </button>
                            </div>
                        </div>

                        <!-- Email Templates -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">Email Template</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="email-template-card p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                    onclick="selectTemplate('standard')">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                        <h4 class="font-medium">Standard Template</h4>
                                    </div>
                                    <p class="text-xs text-gray-600">Comprehensive changeover meeting invitation with
                                        all details</p>
                                </div>
                                <div class="email-template-card p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                    onclick="selectTemplate('urgent')">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                        <h4 class="font-medium">Urgent Template</h4>
                                    </div>
                                    <p class="text-xs text-gray-600">Quick notification for urgent changeovers</p>
                                </div>
                                <div class="email-template-card p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                    onclick="selectTemplate('detailed')">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-list-alt text-green-500 mr-2"></i>
                                        <h4 class="font-medium">Detailed Template</h4>
                                    </div>
                                    <p class="text-xs text-gray-600">Detailed analysis with timeline and
                                        responsibilities</p>
                                </div>
                            </div>
                        </div>

                        <!-- Email Configuration -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CC</label>
                                <input type="text" id="emailCC"
                                    class="w-full border border-gray-300 rounded-lg p-2 text-sm"
                                    placeholder="cc@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">BCC</label>
                                <input type="text" id="emailBCC"
                                    class="w-full border border-gray-300 rounded-lg p-2 text-sm"
                                    placeholder="bcc@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meeting Date</label>
                                <input type="date" id="meetingDate"
                                    class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            </div>
                        </div>

                        <!-- Attachment Section -->
                        <div class="mb-6 attachment-container">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-medium text-gray-700 flex items-center">
                                    <i class="fas fa-paperclip mr-2"></i> Email Attachments
                                </h3>
                                <button type="button" onclick="clearAllAttachments()"
                                    class="text-xs text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash-alt mr-1"></i> Clear All
                                </button>
                            </div>

                            <!-- Attachment Dropzone -->
                            <div id="attachmentDropzone" class="attachment-dropzone mb-3"
                                onclick="document.getElementById('attachmentFiles').click()">
                                <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                                <p class="text-gray-600 font-medium">Drop files here or click to browse</p>
                                <p class="text-xs text-gray-500 mt-2">Supports: .xlsx, .xls, .csv, .pdf, .doc, .docx,
                                    .txt, .png, .jpg, .jpeg</p>
                                <p class="text-xs text-gray-500">Max file size: 10MB per file</p>
                                <input type="file" id="attachmentFiles" multiple
                                    accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" class="hidden">
                            </div>

                            <!-- Attachment List -->
                            <div class="attachment-list" id="attachmentList">
                                <!-- Attachments will appear here -->
                            </div>

                            <!-- Total Size Indicator -->
                            <div class="attachment-total-size" id="attachmentTotalSize">
                                Total size: 0 MB
                            </div>
                        </div>

                        <!-- Email Preview -->
                        <div class="email-preview-container">
                            <div class="email-toolbar">
                                <div class="flex items-center space-x-4">
                                    <span class="text-sm text-gray-600">Preview Mode:</span>
                                    <div class="flex space-x-2">
                                        <button onclick="toggleEmailPreviewMode('html')"
                                            class="px-3 py-1 text-xs rounded border bg-white">HTML</button>
                                        <button onclick="toggleEmailPreviewMode('text')"
                                            class="px-3 py-1 text-xs rounded border bg-white">Plain Text</button>
                                    </div>
                                </div>
                            </div>

                            <!-- HTML Email Preview -->
                            <div id="htmlEmailPreview">
                                <div class="email-header-preview">
                                    <div class="space-y-1">
                                        <div class="flex">
                                            <span class="text-gray-600 w-16">From:</span>
                                            <span class="font-medium">management.trainee@sidneyapparels.com</span>
                                        </div>
                                        <div class="flex">
                                            <span class="text-gray-600 w-16">To:</span>
                                            <span class="font-medium" id="previewRecipients">--</span>
                                        </div>
                                        <div class="flex">
                                            <span class="text-gray-600 w-16">Subject:</span>
                                            <span class="font-medium" id="previewSubject">--</span>
                                        </div>
                                        <div class="flex">
                                            <span class="text-gray-600 w-16">Attachments:</span>
                                            <span class="font-medium" id="previewAttachments">None</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="email-body-preview" id="emailPreviewContent">
                                    <!-- Email content will be inserted here -->
                                </div>
                                <div class="email-footer-preview">
                                    <p>Changeover Meeting Initiator System - Manufacturing Excellence Tool</p>
                                </div>
                            </div>

                            <!-- Plain Text Email Editor -->
                            <div id="textEmailEditor" class="hidden">
                                <div class="p-4">
                                    <textarea id="plainTextEmail"
                                        class="w-full h-96 p-3 border rounded-lg font-mono text-sm"
                                        placeholder="Email content will appear here..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md mx-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">Processing OB files...</p>
            <p class="text-sm text-gray-500 mt-2" id="loadingStatus">Analyzing machine requirements</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                <div id="loadingProgressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal hidden">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <h3 class="file-preview-title" id="filePreviewTitle">File Preview</h3>
                <button onclick="closeFilePreview()" class="file-preview-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="file-preview-body" id="filePreviewBody">
                <!-- File preview content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- SMTP Send Modal -->
    <div id="smtpModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg mx-4 w-full">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-envelope mr-2 text-orange-500"></i> Send Email via Nodemailer
            </h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sender Email</label>
                <input type="email" id="modalSenderEmail"
                    class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                    placeholder="your-email@sidneyapparels.co" value="management.trainee@sidneyapparels.com" readonly>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Recipients</label>
                <input type="text" id="modalRecipients" class="w-full p-2 border border-gray-300 rounded-lg" readonly>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                <input type="text" id="modalSubject" class="w-full p-2 border border-gray-300 rounded-lg" readonly>
            </div>

            <!-- Attachment Preview in Modal -->
            <div class="mb-6 attachment-container">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                        <i class="fas fa-paperclip mr-2"></i> Attachments to Send
                    </h3>
                    <span class="text-xs text-gray-500" id="modalAttachmentCount">0 files</span>
                </div>
                <div class="attachment-list" id="modalAttachmentList">
                    <!-- Attachments will appear here -->
                </div>
                <div class="attachment-total-size" id="modalAttachmentTotalSize">
                    Total size: 0 MB
                </div>
            </div>

            <div class="flex space-x-3">
                <button onclick="sendEmailViaNodemailer()" class="flex-1 btn-smtp py-2 rounded-lg">
                    <i class="fas fa-paper-plane mr-2"></i> Send Email
                </button>
                <button onclick="testSMTPConnection()"
                    class="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200">
                    <i class="fas fa-server mr-2"></i> Test Server
                </button>
                <button onclick="closeSmtpModal()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>
            </div>

            <div id="smtpSendStatus" class="mt-4 text-sm hidden"></div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION - FIXED VERSION
        // ============================================

        // Initialize Firebase
        let firebaseApp;
        let db;
        let auth;
        let emailData = {};
        let isFirebaseConnected = false;
        let firebaseInitialized = false;
        let bulkUploadData = null;
        let currentQCONumber = null;
        let currentChangeoverId = null;
        let allChangeovers = [];

        // Firebase log system
        const firebaseLogs = [];
        const MAX_LOGS = 50;

        function addFirebaseLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                level
            };

            firebaseLogs.unshift(logEntry);
            if (firebaseLogs.length > MAX_LOGS) {
                firebaseLogs.pop();
            }

            // Update log display if visible
            updateFirebaseLogDisplay();

            console.log(`[Firebase ${level.toUpperCase()}] ${message}`);
        }

        function updateFirebaseLogDisplay() {
            const logContainer = document.getElementById('firebaseLog');
            if (!logContainer) return;

            logContainer.innerHTML = '';
            firebaseLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = 'firebase-log-entry';
                logElement.innerHTML = `
                    <span class="firebase-log-timestamp">[${log.timestamp}]</span>
                    <span class="firebase-log-level-${log.level}">${log.message}</span>
                `;
                logContainer.appendChild(logElement);
            });
        }

        async function initializeFirebase() {
            try {
                addFirebaseLog('Initializing Firebase...', 'info');

                // Check if Firebase is already initialized
                if (firebase.apps.length > 0 && firebase.apps[0] !== null) {
                    firebaseApp = firebase.apps[0];
                    addFirebaseLog('Using existing Firebase app', 'info');
                } else {
                    // Initialize Firebase
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    addFirebaseLog('Firebase app initialized', 'success');
                }

                // Initialize Firestore
                db = firebase.firestore();
                addFirebaseLog('Firestore initialized', 'info');

                // Initialize Authentication
                auth = firebase.auth();
                addFirebaseLog('Authentication initialized', 'info');

                // Test connection
                addFirebaseLog('Testing Firebase connection...', 'info');

                // Use a simple read operation to test connection
                const testDocRef = db.collection('system').doc('connection-test');

                try {
                    await testDocRef.set({
                        test: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        message: 'Connection test from Changeover Meeting Initiator'
                    }, { merge: true });

                    addFirebaseLog('Firebase write test successful', 'success');

                    // Now try to read it back
                    const doc = await testDocRef.get();
                    if (doc.exists) {
                        isFirebaseConnected = true;
                        updateFirebaseStatus('connected');
                        addFirebaseLog('Firebase connection established successfully!', 'success');

                        // Initialize collections if they don't exist
                        await initializeFirebaseCollections();

                        // Load email data from Firebase
                        await loadEmailDataFromFirebase();
                    } else {
                        throw new Error('Document not found after write');
                    }
                } catch (error) {
                    addFirebaseLog(`Firebase connection failed: ${error.message}`, 'error');
                    isFirebaseConnected = false;
                    updateFirebaseStatus('disconnected');

                    // Load email data from local storage as fallback
                    loadEmailDataFromLocal();
                }

                // Set up connection state listener
                db.enableNetwork().then(() => {
                    isFirebaseConnected = true;
                    updateFirebaseStatus('connected');
                    addFirebaseLog('Firebase network enabled', 'success');
                }).catch(error => {
                    isFirebaseConnected = false;
                    updateFirebaseStatus('disconnected');
                    addFirebaseLog(`Firebase network error: ${error.message}`, 'error');
                });

                firebaseInitialized = true;

            } catch (error) {
                addFirebaseLog(`Firebase initialization error: ${error.message}`, 'error');
                isFirebaseConnected = false;
                updateFirebaseStatus('disconnected');
                firebaseInitialized = false;

                // Load email data from local storage
                loadEmailDataFromLocal();
            }
        }

        async function initializeFirebaseCollections() {
            try {
                addFirebaseLog('Initializing Firebase collections...', 'info');

                // Check if emailData collection exists
                const emailDocRef = db.collection('emailData').doc('lines');
                const emailDoc = await emailDocRef.get();

                if (!emailDoc.exists) {
                    // Create initial email data structure
                    const defaultEmailData = {};
                    const lines = ["1", "1A", "2", "3", "6+17", "7", "7A", "8+5", "9", "10", "11+15", "12", "13/21", "14", "16", "16A", "18", "19", "20", "22", "23", "24", "25", "26/4", "28", "29", "30", "31", "32"];

                    lines.forEach(line => {
                        defaultEmailData[line] = {
                            supervisor: "",
                            rqc: "",
                            ie: "",
                            lineIncharge: "",
                            qam: "",
                            mechIncharge: "",
                            technical: "",
                            planning: "",
                            production: "",
                            fabric: "",
                            cutting: "",
                            maintenance: "",
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        };
                    });

                    await emailDocRef.set(defaultEmailData);
                    addFirebaseLog('Created initial emailData collection', 'success');
                }

                // Check if users collection exists
                const usersCollectionRef = db.collection('users');
                const usersSnapshot = await usersCollectionRef.limit(1).get();

                if (usersSnapshot.empty) {
                    // Create default users
                    const defaultUsers = [
                        {
                            id: "admin1",
                            name: "Mr. Shantanu",
                            password: "welcome@123", // Note: In production, hash passwords
                            role: "admin",
                            email: "shantanu@sidneyapparels.co",
                            lastLogin: null,
                            created: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            id: "user1",
                            name: "Mr. Tharun",
                            password: "tharun123",
                            role: "user",
                            email: "tharun@sidneyapparels.co",
                            lastLogin: null,
                            created: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];

                    for (const user of defaultUsers) {
                        await usersCollectionRef.doc(user.id).set(user);
                    }

                    addFirebaseLog('Created initial users collection', 'success');
                }

                // Check if activityLog collection exists
                const activityLogRef = db.collection('activityLog').doc('initialized');
                const activityLogDoc = await activityLogRef.get();

                if (!activityLogDoc.exists) {
                    await activityLogRef.set({
                        initialized: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    addFirebaseLog('Created activityLog collection', 'success');
                }

                // Check if changeovers collection exists
                const qcoSettingsRef = db.collection('system').doc('qcoSettings');
                const qcoSettingsDoc = await qcoSettingsRef.get();
                if (!qcoSettingsDoc.exists) {
                    await qcoSettingsRef.set({
                        lastNumber: 10000,
                        availableNumbers: [],
                        initialized: true
                    });
                    addFirebaseLog('Created QCO settings', 'success');
                }

                addFirebaseLog('Firebase collections initialized successfully', 'success');

            } catch (error) {
                addFirebaseLog(`Error initializing collections: ${error.message}`, 'error');
            }
        }

        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = `Firebase: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
                statusElement.className = `firebase-status firebase-${status}`;
            }
        }

        // QCO Number Management
        // QCO Number Management
        async function getNextQCONumber(lineNumber, currentStyle, upcomingStyle) {
            const cleanLine = lineNumber ? lineNumber.toString().replace(/[^0-9A-Z]/gi, '') : "0";
            const curLast3 = currentStyle ? (currentStyle.length > 3 ? currentStyle.slice(-3) : currentStyle.padStart(3, '0')) : "000";
            const nextLast3 = upcomingStyle ? (upcomingStyle.length > 3 ? upcomingStyle.slice(-3) : upcomingStyle.padStart(3, '0')) : "000";

            if (isFirebaseConnected) {
                try {
                    addFirebaseLog('Generating QCO number via Firebase transaction...', 'info');

                    // Construct the Unique Key for this specific combo
                    const uniqueKey = `S${cleanLine}-${curLast3}-${nextLast3}`;
                    const sequenceRef = db.collection('qco_sequences').doc(uniqueKey);

                    const nextSeq = await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(sequenceRef);
                        let seq = 1;

                        if (doc.exists) {
                            seq = (doc.data().count || 0) + 1;
                        }

                        transaction.set(sequenceRef, {
                            count: seq,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        return seq;
                    });

                    // Format: S-Line-Cur3-Next3-Seq (01, 02... 99, 100...)
                    const seqStr = nextSeq.toString().padStart(2, '0');
                    const newId = `S-${cleanLine}-${curLast3}-${nextLast3}-${seqStr}`;

                    addFirebaseLog(`Generated synced QCO number: ${newId}`, 'success');
                    return newId;

                } catch (error) {
                    addFirebaseLog(`Error in QCO sync transaction: ${error.message}`, 'error');
                    // Fallback to querying changeovers if transaction fails
                    // Try to count existing changeovers for this specific combination
                    const prefix = `S-${cleanLine}-${curLast3}-${nextLast3}-`;
                    /* 
                       Note: A true "startsWith" query in Firestore requires a range query.
                       We query for IDs >= prefix and < prefix + last_char_increment
                    */
                    try {
                        const endPrefix = prefix + '\uf8ff';
                        const snapshot = await db.collection('changeovers')
                            .where('qcoNumber', '>=', prefix)
                            .where('qcoNumber', '<=', endPrefix)
                            .get();

                        const nextSeq = (snapshot.size + 1).toString().padStart(2, '0');
                        return `${prefix}${nextSeq}`;
                    } catch (fallbackError) {
                        // Ultimate fallback if query fails
                        return `${prefix}01`;
                    }
                }
            } else {
                // Offline fallback - use localStorage per combo
                const uniqueKey = `qco_seq_S${cleanLine}-${curLast3}-${nextLast3}`;
                const localSeq = localStorage.getItem(uniqueKey) || 0;
                const next = parseInt(localSeq) + 1;
                localStorage.setItem(uniqueKey, next);
                const seqStr = next.toString().padStart(2, '0');
                return `S-${cleanLine}-${curLast3}-${nextLast3}-${seqStr}`;
            }
        }

        async function deleteQCONumber(qcoNumber) {
            const num = parseInt(qcoNumber.replace(/[^0-9]/g, ''));

            if (isFirebaseConnected) {
                try {
                    await db.collection('system').doc('qcoSettings').update({
                        availableNumbers: firebase.firestore.FieldValue.arrayUnion(num)
                    });
                    addFirebaseLog(`QCO number ${qcoNumber} marked for reuse`, 'info');
                } catch (error) {
                    addFirebaseLog(`Error recycling QCO number: ${error.message}`, 'error');
                }
            }
        }

        async function saveChangeoverToFirebase(qcoData) {
            if (!isFirebaseConnected) {
                // Save to local storage
                const localChangeovers = JSON.parse(localStorage.getItem('changeovers') || '[]');
                localChangeovers.push(qcoData);
                localStorage.setItem('changeovers', JSON.stringify(localChangeovers));
                return;
            }

            try {
                await db.collection('changeovers').doc(qcoData.qcoNumber).set(qcoData);
                addFirebaseLog(`Changeover ${qcoData.qcoNumber} saved to Firebase`, 'success');
            } catch (error) {
                addFirebaseLog(`Error saving changeover: ${error.message}`, 'error');
                // Fallback to local
                const localChangeovers = JSON.parse(localStorage.getItem('changeovers') || '[]');
                localChangeovers.push(qcoData);
                localStorage.setItem('changeovers', JSON.stringify(localChangeovers));
            }
        }

        async function loadChangeoversFromFirebase() {
            if (!isFirebaseConnected) {
                return JSON.parse(localStorage.getItem('changeovers') || '[]');
            }

            try {
                const snapshot = await db.collection('changeovers')
                    .orderBy('createdAt', 'desc')
                    .get();

                const changeovers = [];
                snapshot.forEach(doc => {
                    changeovers.push(doc.data());
                });

                allChangeovers = changeovers;
                return changeovers;
            } catch (error) {
                addFirebaseLog(`Error loading changeovers: ${error.message}`, 'error');
                return JSON.parse(localStorage.getItem('changeovers') || '[]');
            }
        }

        async function refreshChangeoverData() {
            const changeovers = await loadChangeoversFromFirebase();
            renderChangeoverList(changeovers);
            showNotification('Changeover records refreshed', 'success');
        }

        function renderChangeoverList(changeovers) {
            const container = document.getElementById('changeoverList');
            const noData = document.getElementById('noChangeovers');

            if (!changeovers || changeovers.length === 0) {
                container.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            container.innerHTML = '';

            container.innerHTML = '';

            changeovers.forEach((co, index) => {
                const card = document.createElement('div');
                card.className = 'changeover-card';
                card.onclick = () => openChangeoverModal(co);

                const createdDate = co.createdAt ? new Date(co.createdAt).toLocaleDateString() : 'Unknown';
                const emailSent = co.emailSent ? new Date(co.emailSent).toLocaleDateString() : 'Not sent';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="qco-code">#${changeovers.length - index} | ${co.qcoNumber}</span>
                            <p class="mt-2 font-semibold text-gray-800">Line ${co.lineNumber || 'Unknown'}</p>
                            <p class="text-sm text-gray-600">${co.currentStyle || 'Unknown'} → ${co.upcomingStyle || 'Unknown'}</p>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p><i class="fas fa-calendar mr-1"></i> ${createdDate}</p>
                            <p class="mt-1"><i class="fas fa-envelope mr-1"></i> ${emailSent}</p>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function filterChangeovers() {
            const search = document.getElementById('searchQCO').value.toLowerCase();
            const lineFilter = document.getElementById('filterLine').value;

            let filtered = allChangeovers;

            if (search) {
                filtered = filtered.filter(co =>
                    co.qcoNumber.toLowerCase().includes(search) ||
                    (co.currentStyle && co.currentStyle.toLowerCase().includes(search)) ||
                    (co.upcomingStyle && co.upcomingStyle.toLowerCase().includes(search))
                );
            }

            if (lineFilter) {
                filtered = filtered.filter(co => co.lineNumber === lineFilter);
            }

            renderChangeoverList(filtered);
        }

        function openChangeoverModal(changeover) {
            currentChangeoverId = changeover.qcoNumber;

            document.getElementById('modalQCOCode').textContent = changeover.qcoNumber;
            document.getElementById('modalCurrentStyle').textContent = changeover.currentStyle || 'N/A';
            document.getElementById('modalCurrentSMV').textContent = changeover.currentSMV || 'N/A';
            document.getElementById('modalCurrentTarget').textContent = changeover.currentTarget || 'N/A';
            document.getElementById('modalUpcomingStyle').textContent = changeover.upcomingStyle || 'N/A';
            document.getElementById('modalUpcomingSMV').textContent = changeover.upcomingSMV || 'N/A';
            document.getElementById('modalUpcomingTarget').textContent = changeover.upcomingTarget || 'N/A';
            document.getElementById('modalLine').textContent = changeover.lineNumber || 'N/A';
            document.getElementById('modalCreatedDate').textContent = changeover.createdAt ? new Date(changeover.createdAt).toLocaleString() : 'N/A';
            document.getElementById('modalEmailSent').textContent = changeover.emailSent ? new Date(changeover.emailSent).toLocaleString() : 'Not sent';

            // Machine summary
            const summary = document.getElementById('modalMachineSummary');
            if (changeover.machineSummary) {
                const needed = changeover.machineSummary.filter(m => m.required > 0).length;
                const surplus = changeover.machineSummary.filter(m => m.surplus > 0).length;
                summary.innerHTML = `<span class="text-red-600 font-medium">${needed} machines needed</span> | <span class="text-green-600 font-medium">${surplus} machines surplus</span>`;
            } else {
                summary.textContent = 'No machine data available';
            }

            // Show admin actions only for admin
            const adminActions = document.getElementById('modalAdminActions');
            if (currentUser && currentUser.role === 'admin') {
                adminActions.classList.remove('hidden');
                adminActions.classList.add('flex');
            } else {
                adminActions.classList.add('hidden');
                adminActions.classList.remove('flex');
            }

            document.getElementById('changeoverModal').classList.remove('hidden');
        }

        function closeChangeoverModal() {
            document.getElementById('changeoverModal').classList.add('hidden');
            currentChangeoverId = null;
        }

        async function deleteCurrentChangeover() {
            if (!currentChangeoverId) return;

            if (!confirm(`Are you sure you want to delete ${currentChangeoverId}? This cannot be undone.`)) {
                return;
            }

            // Recycle the number
            await deleteQCONumber(currentChangeoverId);

            // Delete from Firebase
            if (isFirebaseConnected) {
                try {
                    await db.collection('changeovers').doc(currentChangeoverId).delete();
                } catch (error) {
                    console.error('Error deleting from Firebase:', error);
                }
            }

            // Delete from local
            let localChangeovers = JSON.parse(localStorage.getItem('changeovers') || '[]');
            localChangeovers = localChangeovers.filter(co => co.qcoNumber !== currentChangeoverId);
            localStorage.setItem('changeovers', JSON.stringify(localChangeovers));

            logActivity(`${currentUser.name} deleted changeover ${currentChangeoverId}`, 'changeover_delete');
            showNotification('Changeover deleted successfully', 'success');

            closeChangeoverModal();
            refreshChangeoverData();
        }

        function editCurrentChangeover() {
            showNotification('Edit functionality - Load data into main form', 'info');
            // Implementation would load the changeover data back into the main form for editing
            closeChangeoverModal();
        }

        // ============================================
        // ATTACHMENT MANAGEMENT SYSTEM
        // ============================================

        let attachments = [];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB per file
        const MAX_TOTAL_SIZE = 25 * 1024 * 1024; // 25MB total

        function initializeAttachmentSystem() {
            const dropzone = document.getElementById('attachmentDropzone');
            const fileInput = document.getElementById('attachmentFiles');

            // Click handler for dropzone
            dropzone.addEventListener('click', () => fileInput.click());

            // Drag and drop handlers
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleAttachmentFiles(files);
                }
            });

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleAttachmentFiles(e.target.files);
                }
            });
        }

        function handleAttachmentFiles(fileList) {
            const newAttachments = Array.from(fileList);
            let errors = [];

            // Validate each file
            newAttachments.forEach((file, index) => {
                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    errors.push(`"${file.name}" exceeds 10MB limit`);
                    return;
                }

                // Check file type
                const validExtensions = ['.xlsx', '.xls', '.csv', '.pdf', '.doc', '.docx', '.txt', '.png', '.jpg', '.jpeg'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    errors.push(`"${file.name}" has unsupported file type`);
                    return;
                }

                // Check if file already exists
                const existingFile = attachments.find(att => att.name === file.name && att.size === file.size);
                if (existingFile) {
                    errors.push(`"${file.name}" is already added`);
                    return;
                }

                // Calculate total size if this file is added
                const currentTotalSize = attachments.reduce((sum, att) => sum + att.size, 0);
                if (currentTotalSize + file.size > MAX_TOTAL_SIZE) {
                    errors.push(`Adding "${file.name}" would exceed total size limit of 25MB`);
                    return;
                }
            });

            // Show errors if any
            if (errors.length > 0) {
                showNotification(errors.join('<br>'), 'error');
                return;
            }

            // Add valid files to attachments
            newAttachments.forEach(file => {
                if (file.size <= MAX_FILE_SIZE) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const attachment = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: e.target.result.split(',')[1], // Base64 without prefix
                            file: file
                        };
                        attachments.push(attachment);
                        updateAttachmentList();
                        updateAttachmentPreview();
                        showNotification(`Added attachment: ${file.name}`, 'success');
                        logActivity(`${currentUser.name} added attachment: ${file.name}`, 'attachment');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Clear file input
            document.getElementById('attachmentFiles').value = '';
        }

        function updateAttachmentList() {
            const container = document.getElementById('attachmentList');
            const totalSizeElement = document.getElementById('attachmentTotalSize');
            const modalContainer = document.getElementById('modalAttachmentList');
            const modalTotalSizeElement = document.getElementById('modalAttachmentTotalSize');
            const modalCountElement = document.getElementById('modalAttachmentCount');

            // Update main attachment list
            container.innerHTML = '';

            if (attachments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No attachments added</p>';
            } else {
                attachments.forEach((attachment, index) => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item';
                    item.innerHTML = `
                        <div class="attachment-info">
                            <i class="fas ${getFileIcon(attachment.name)} attachment-icon"></i>
                            <div class="attachment-details">
                                <div class="attachment-name">${attachment.name}</div>
                                <div class="attachment-size">${formatFileSize(attachment.size)}</div>
                            </div>
                        </div>
                        <div class="attachment-actions">
                            <button onclick="previewAttachment(${index})" class="attachment-preview-btn" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="removeAttachment(${index})" class="attachment-remove-btn" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            // Update total size
            const totalSize = attachments.reduce((sum, att) => sum + att.size, 0);
            totalSizeElement.textContent = `Total size: ${formatFileSize(totalSize)}`;

            if (totalSize > MAX_TOTAL_SIZE * 0.8) {
                totalSizeElement.className = 'attachment-total-size warning';
            } else {
                totalSizeElement.className = 'attachment-total-size';
            }

            // Update modal attachment list
            if (modalContainer) {
                modalContainer.innerHTML = '';
                if (attachments.length === 0) {
                    modalContainer.innerHTML = '<p class="text-gray-500 text-center py-2 text-sm">No attachments</p>';
                } else {
                    attachments.forEach((attachment, index) => {
                        const item = document.createElement('div');
                        item.className = 'attachment-item';
                        item.innerHTML = `
                            <div class="attachment-info">
                                <i class="fas ${getFileIcon(attachment.name)} attachment-icon"></i>
                                <div class="attachment-details">
                                    <div class="attachment-name">${attachment.name}</div>
                                    <div class="attachment-size">${formatFileSize(attachment.size)}</div>
                                </div>
                            </div>
                        `;
                        modalContainer.appendChild(item);
                    });
                }

                modalTotalSizeElement.textContent = `Total size: ${formatFileSize(totalSize)}`;
                modalCountElement.textContent = `${attachments.length} file${attachments.length !== 1 ? 's' : ''}`;
            }

            // Update email preview
            updateEmailAttachmentPreview();
        }

        function getFileIcon(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            switch (extension) {
                case 'xlsx':
                case 'xls':
                case 'csv':
                    return 'fa-file-excel';
                case 'pdf':
                    return 'fa-file-pdf';
                case 'doc':
                case 'docx':
                    return 'fa-file-word';
                case 'txt':
                    return 'fa-file-alt';
                case 'png':
                case 'jpg':
                case 'jpeg':
                    return 'fa-file-image';
                default:
                    return 'fa-file';
            }
        }

        function removeAttachment(index) {
            if (index >= 0 && index < attachments.length) {
                const attachment = attachments[index];
                attachments.splice(index, 1);
                updateAttachmentList();
                updateAttachmentPreview();
                showNotification(`Removed attachment: ${attachment.name}`, 'info');
                logActivity(`${currentUser.name} removed attachment: ${attachment.name}`, 'attachment');
            }
        }

        function clearAllAttachments() {
            if (attachments.length === 0) return;

            if (confirm(`Remove all ${attachments.length} attachments?`)) {
                attachments = [];
                updateAttachmentList();
                updateAttachmentPreview();
                showNotification('All attachments removed', 'info');
                logActivity(`${currentUser.name} cleared all attachments`, 'attachment');
            }
        }

        function previewAttachment(index) {
            if (index < 0 || index >= attachments.length) return;

            const attachment = attachments[index];
            const modal = document.getElementById('filePreviewModal');
            const title = document.getElementById('filePreviewTitle');
            const body = document.getElementById('filePreviewBody');

            title.textContent = attachment.name;
            body.innerHTML = '';

            // Show loading
            body.innerHTML = `
                <div class="file-preview-placeholder">
                    <i class="fas fa-spinner fa-spin file-preview-placeholder-icon"></i>
                    <p>Loading preview...</p>
                </div>
            `;

            modal.classList.remove('hidden');

            // Handle different file types
            const extension = attachment.name.split('.').pop().toLowerCase();

            switch (extension) {
                case 'txt':
                    // For text files, display content
                    const text = atob(attachment.data);
                    body.innerHTML = `
                        <pre class="whitespace-pre-wrap font-mono text-sm p-4 bg-gray-50 rounded">${escapeHtml(text)}</pre>
                    `;
                    break;

                case 'png':
                case 'jpg':
                case 'jpeg':
                    // For images, display image
                    const img = document.createElement('img');
                    img.src = `data:${attachment.type};base64,${attachment.data}`;
                    img.alt = attachment.name;
                    img.className = 'max-w-full h-auto mx-auto';
                    body.innerHTML = '';
                    body.appendChild(img);
                    break;

                case 'pdf':
                    // For PDF, show download link
                    body.innerHTML = `
                        <div class="file-preview-placeholder">
                            <i class="fas fa-file-pdf text-red-500 file-preview-placeholder-icon"></i>
                            <p class="mb-4">PDF files cannot be previewed directly</p>
                            <button onclick="downloadAttachment(${index})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-download mr-2"></i> Download PDF
                            </button>
                        </div>
                    `;
                    break;

                case 'xlsx':
                case 'xls':
                case 'csv':
                case 'doc':
                case 'docx':
                    // For office files, show download link
                    const icon = getFileIcon(attachment.name);
                    body.innerHTML = `
                        <div class="file-preview-placeholder">
                            <i class="fas ${icon} text-blue-500 file-preview-placeholder-icon"></i>
                            <p class="mb-4">${extension.toUpperCase()} files cannot be previewed directly</p>
                            <button onclick="downloadAttachment(${index})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-download mr-2"></i> Download File
                            </button>
                        </div>
                    `;
                    break;

                default:
                    body.innerHTML = `
                        <div class="file-preview-placeholder">
                            <i class="fas fa-file file-preview-placeholder-icon"></i>
                            <p class="mb-4">Preview not available for this file type</p>
                            <button onclick="downloadAttachment(${index})" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                <i class="fas fa-download mr-2"></i> Download File
                            </button>
                        </div>
                    `;
            }
        }

        function closeFilePreview() {
            document.getElementById('filePreviewModal').classList.add('hidden');
        }

        function downloadAttachment(index) {
            if (index < 0 || index >= attachments.length) return;

            const attachment = attachments[index];
            const link = document.createElement('a');
            link.href = `data:${attachment.type};base64,${attachment.data}`;
            link.download = attachment.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            logActivity(`${currentUser.name} downloaded attachment: ${attachment.name}`, 'attachment');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateEmailAttachmentPreview() {
            const previewElement = document.getElementById('previewAttachments');
            if (!previewElement) return;

            if (attachments.length === 0) {
                previewElement.textContent = 'None';
            } else {
                previewElement.textContent = `${attachments.length} file${attachments.length !== 1 ? 's' : ''} (${formatFileSize(attachments.reduce((sum, att) => sum + att.size, 0))})`;
            }
        }

        function updateAttachmentPreview() {
            updateEmailAttachmentPreview();

            // Update modal preview if open
            if (!document.getElementById('smtpModal').classList.contains('hidden')) {
                updateAttachmentList();
            }
        }

        // ============================================
        // AUTHENTICATION AND USER MANAGEMENT SYSTEM
        // ============================================

        // Global variables
        let currentUser = null;
        let currentOBData = null;
        let upcomingOBData = null;
        let comparisonResults = null;
        let selectedLine = null;
        let emailTemplate = 'standard';
        let previewMode = 'html';
        let sessionStartTime = null;
        let currentFile = null;
        let upcomingFile = null;
        let isEditingUser = false;
        let currentEmailData = null;
        let currentReviewQCOId = null; // Track which QCO is being reviewed for email

        // Default users (will be saved to localStorage as fallback)
        const defaultUsers = [
            {
                id: 1,
                name: "Mr. Shantanu",
                password: "welcome@123",
                role: "admin",
                email: "shantanu@sidneyapparels.co",
                lastLogin: null,
                created: new Date().toISOString()
            },
            {
                id: 2,
                name: "Mr. Tharun",
                password: "tharun123",
                role: "user",
                email: "tharun@sidneyapparels.co",
                lastLogin: null,
                created: new Date().toISOString()
            },
            {
                id: 3,
                name: "Mr. Mubashir",
                password: "mubashir123",
                role: "user",
                email: "mubashir@sidneyapparels.co",
                lastLogin: null,
                created: new Date().toISOString()
            },
            {
                id: 4,
                name: "Ms Sampreeti",
                password: "kangaroo",
                role: "user",
                email: "sampreeti@sidneyapparels.co",
                lastLogin: null,
                created: new Date().toISOString()
            }
        ];

        // Default application settings
        const defaultSettings = {
            defaultCC: "planning@sidneyapparels.co, production@sidneyapparels.co",
            defaultMeetingTime: "09:00",
            autoSaveEnabled: true,
            notificationsEnabled: true,
            autoGenerateEmailEnabled: true,
            darkModeEnabled: false,
            backendUrl: BACKEND_URL,
            includeOriginalFiles: true,
            appLastUpdated: new Date().toISOString()
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function () {
            // Navigation Guard for Planning Role
            const localUser = JSON.parse(localStorage.getItem('qcoCurrentUser') || '{}');
            if (localUser.role === 'planning') {
                window.location.replace('schedule.html');
                return;
            }

            // Initialize Firebase first
            await initializeFirebase();

            // Initialize data storage
            initializeStorage();

            // Initialize attachment system
            initializeAttachmentSystem();

            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            const sessionActive = localStorage.getItem('sessionActive');

            if (savedUser && sessionActive === 'true') {
                // Auto-login if session is still active
                try {
                    currentUser = JSON.parse(savedUser);
                    startUserSession();
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    showLoginScreen();
                }
            } else {
                // Show login screen
                showLoginScreen();
            }

            // Initialize event listeners for both login and main app
            initializeEventListeners();
            setDefaultMeetingDate();

            // Update system info
            updateSystemInfo();

            // Check backend connection on startup
            setTimeout(checkBackendConnection, 1000);

            // Update Firebase log display
            updateFirebaseLogDisplay();

            // Close preview modal when clicking outside
            document.getElementById('filePreviewModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeFilePreview();
                }
            });

            // Close changeover modal on outside click
            document.getElementById('changeoverModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeChangeoverModal();
                }
            });
        });

        function initializeStorage() {
            // Initialize users if not exists
            if (!localStorage.getItem('systemUsers')) {
                localStorage.setItem('systemUsers', JSON.stringify(defaultUsers));
            }

            // Initialize activity log if not exists
            if (!localStorage.getItem('activityLog')) {
                localStorage.setItem('activityLog', JSON.stringify([]));
            }

            // Initialize settings if not exists
            if (!localStorage.getItem('appSettings')) {
                localStorage.setItem('appSettings', JSON.stringify(defaultSettings));
            }

            // Initialize email data if not exists
            if (!localStorage.getItem('emailData')) {
                // Create default email data structure
                const defaultEmailData = {};
                const lines = ["1", "1A", "2", "3", "6+17", "7", "7A", "8+5", "9", "10", "11+15", "12", "13/21", "14", "16", "16A", "18", "19", "20", "22", "23", "24", "25", "26/4", "28", "29", "30", "31", "32"];

                lines.forEach(line => {
                    defaultEmailData[line] = {
                        supervisor: "",
                        rqc: "",
                        ie: "",
                        lineIncharge: "",
                        qam: "",
                        mechIncharge: "",
                        technical: "",
                        lastUpdated: new Date().toISOString()
                    };
                });

                localStorage.setItem('emailData', JSON.stringify(defaultEmailData));
            }

            // Initialize QCO counter if not exists
            if (!localStorage.getItem('qcoCounter')) {
                localStorage.setItem('qcoCounter', '10000');
            }

            // Initialize changeovers if not exists
            if (!localStorage.getItem('changeovers')) {
                localStorage.setItem('changeovers', JSON.stringify([]));
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('fade-in');

            // Update UI based on user role
            updateUIForUser();

            // Load settings
            loadSettings();
        }

        async function authenticateUser() {
            const passwordInput = document.getElementById('loginPassword');
            const password = passwordInput.value.trim();
            const errorElement = document.getElementById('loginError');

            if (!password) {
                errorElement.textContent = "Please enter a password";
                errorElement.classList.remove('hidden');
                passwordInput.classList.add('shake');
                setTimeout(() => passwordInput.classList.remove('shake'), 500);
                return;
            }

            addFirebaseLog(`Attempting user authentication...`, 'info');

            if (isFirebaseConnected) {
                // Try Firebase authentication first
                try {
                    const usersCollection = db.collection('users');
                    const querySnapshot = await usersCollection.where('password', '==', password).get();

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const user = userDoc.data();
                        user.id = userDoc.id;

                        // Update last login in Firebase
                        const now = firebase.firestore.FieldValue.serverTimestamp();
                        await usersCollection.doc(user.id).update({
                            lastLogin: now
                        });

                        // Also update locally for immediate display
                        user.lastLogin = new Date().toISOString();

                        currentUser = user;
                        addFirebaseLog(`User authenticated via Firebase: ${user.name}`, 'success');

                        // Log activity
                        logActivity(`${user.name} logged in`, 'login');

                        // Start session
                        startUserSession();

                        // Clear password field
                        passwordInput.value = '';
                        errorElement.classList.add('hidden');

                        // Show success notification
                        showNotification(`Welcome, ${user.name}!`, 'success');
                        return;
                    }
                } catch (firebaseError) {
                    addFirebaseLog(`Firebase auth failed, falling back to local: ${firebaseError.message}`, 'error');
                }
            }

            // Fallback to local authentication
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            const user = users.find(u => u.password === password);

            if (user) {
                // Update last login
                user.lastLogin = new Date().toISOString();
                localStorage.setItem('systemUsers', JSON.stringify(users));

                // Set current user
                currentUser = user;
                addFirebaseLog(`User authenticated locally: ${user.name}`, 'info');

                // Log activity
                logActivity(`${user.name} logged in`, 'login');

                // Start session
                startUserSession();

                // Clear password field
                passwordInput.value = '';
                errorElement.classList.add('hidden');

                // Check for Planning Role - Strict Redirect
                if (user.role === 'planning') {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    localStorage.setItem('sessionActive', 'true');
                    window.location.replace('schedule.html');
                    return;
                }

                // Show success notification
                showNotification(`Welcome, ${user.name}!`, 'success');
            } else {
                errorElement.textContent = "Invalid password. Please try again.";
                errorElement.classList.remove('hidden');
                passwordInput.classList.add('shake');
                setTimeout(() => passwordInput.classList.remove('shake'), 500);
                addFirebaseLog(`Authentication failed for password: ${password}`, 'error');
            }
        }

        function startUserSession() {
            // Save current user to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('sessionActive', 'true');

            // Set session start time
            sessionStartTime = new Date();
            document.getElementById('sessionStartTime').textContent = sessionStartTime.toLocaleTimeString();
            document.getElementById('currentUserName').textContent = currentUser.name;

            // Show main application
            showMainApp();

            // Log session start
            logActivity(`Session started for ${currentUser.name}`, 'session');
        }

        async function logout() {
            if (currentUser) {
                // Log activity
                logActivity(`${currentUser.name} logged out`, 'logout');

                // Calculate session duration
                const sessionEnd = new Date();
                const sessionDuration = Math.round((sessionEnd - sessionStartTime) / 1000 / 60); // in minutes
                logActivity(`Session ended for ${currentUser.name} (Duration: ${sessionDuration} minutes)`, 'session');
            }

            // Clear session
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.setItem('sessionActive', 'false');

            // Clear current data
            clearUserData();

            // Show login screen
            showLoginScreen();

            // Show notification
            showNotification('You have been logged out successfully', 'info');
        }

        function clearUserData() {
            // Clear any user-specific data from the interface
            currentOBData = null;
            upcomingOBData = null;
            comparisonResults = null;
            selectedLine = null;
            currentFile = null;
            upcomingFile = null;
            attachments = [];
            currentQCONumber = null;

            // Reset UI elements
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('emailSection').classList.add('hidden');

            // Reset file uploads
            document.getElementById('currentFile').value = '';
            document.getElementById('upcomingFile').value = '';
            document.getElementById('currentFileInfo').classList.add('hidden');
            document.getElementById('upcomingFileInfo').classList.add('hidden');

            // Reset line selection
            document.getElementById('lineSelect').value = '';

            // Reset personnel info
            document.getElementById('personnelInfo').classList.add('hidden');
            ['supervisorName', 'rqcName', 'ieName', 'lineIncharge', 'qamName', 'mechIncharge', 'technicalName'].forEach(id => {
                document.getElementById(id).value = '';
            });

            // Reset attachments
            updateAttachmentList();

            // Reset user form
            cancelEdit();
        }

        function updateUIForUser() {
            const isAdmin = currentUser && currentUser.role === 'admin';

            // ALWAYS show the tabs container, but selectively hide/show tabs
            const tabsContainer = document.getElementById('adminTabs');
            if (tabsContainer) {
                tabsContainer.classList.remove('hidden');

                // Process each tab button
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    const tabId = tab.getAttribute('data-tab');

                    if (tabId === 'changeoverManagementSection') {
                        // Changeover records visible to ALL
                        tab.classList.remove('hidden');
                        tab.style.display = ''; // Ensure display isn't none
                    } else {
                        // Other tabs only for Admin
                        if (isAdmin) {
                            tab.classList.remove('hidden');
                            tab.style.display = '';
                        } else {
                            tab.classList.add('hidden');
                            tab.style.display = 'none'; // Force hide
                        }
                    }
                });
            }

            // Mobile Links handling
            const adminMobileLinks = document.getElementById('adminMobileLinks');
            if (adminMobileLinks) {
                adminMobileLinks.classList.remove('hidden');

                // We need to manage individual mobile links significantly if they are just <a> tags
                // For now, let's just show the container but hide children if needed
                const links = adminMobileLinks.querySelectorAll('a');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href === '#changeoverManagementSection') {
                        link.classList.remove('hidden');
                        link.style.display = 'block';
                    } else {
                        if (isAdmin) {
                            link.classList.remove('hidden');
                            link.style.display = 'block';
                        } else {
                            link.classList.add('hidden');
                            link.style.display = 'none';
                        }
                    }
                });
            }

            // Update user badge if admin
            if (isAdmin) {
                const nameEl = document.getElementById('currentUserName');
                if (nameEl) {
                    nameEl.innerHTML = `${currentUser.name} <span class="ml-2 badge badge-warning">Admin</span>`;
                }
            }

            // If not admin and Changeover tab is available, make it active by default 
            // if we are landing here and no other tab is active
            if (!isAdmin) {
                // If they are on an admin section that is hidden, switch to changeover or hide sections
                // This logic is handled by the tabs click, but let's ensure Changeover is the default view if they click a tab
            }
        }

        function switchToAdminTab(tabId) {
            // Hide all admin sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            document.getElementById(tabId).classList.remove('hidden');

            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active', 'text-gray-700', 'border-blue-500');
                tab.classList.add('text-gray-500');
            });

            // Activate clicked tab
            const activeTab = document.querySelector(`.admin-tab[data-tab="${tabId}"]`);
            if (activeTab) {
                activeTab.classList.add('active', 'text-gray-700', 'border-blue-500');
                activeTab.classList.remove('text-gray-500');
            }

            // Save active tab for admin
            if (currentUser && currentUser.role === 'admin') {
                localStorage.setItem('activeAdminTab', tabId);
            }

            // Load specific content for tab
            if (tabId === 'adminSection') {
                loadUserManagement();
            } else if (tabId === 'emailManagementSection') {
                loadEmailManagement();
            } else if (tabId === 'changeoverManagementSection') {
                loadChangeoverManagement();
            } else if (tabId === 'activityLogSection') {
                loadActivityLog();
            } else if (tabId === 'settingsSection') {
                loadSettingsUI();
            }
        }

        function loadChangeoverManagement() {
            refreshChangeoverData();
        }

        let currentModalChangeoverId = null;

        async function refreshChangeoverData() {
            let changeovers = [];
            const listContainer = document.getElementById('changeoverList');
            const noDataMsg = document.getElementById('noChangeovers');

            listContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-gray-500">Loading records...</p></div>';
            noDataMsg.classList.add('hidden');

            if (isFirebaseConnected) {
                try {
                    const changeoversCollection = db.collection('changeovers');
                    const querySnapshot = await changeoversCollection
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .get();

                    changeovers = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data
                        };
                    });
                    addFirebaseLog(`Loaded ${changeovers.length} changeovers from Firebase`, 'success');
                } catch (error) {
                    addFirebaseLog(`Error loading changeovers from Firebase: ${error.message}`, 'error');
                    // Fallback to local storage
                    changeovers = JSON.parse(localStorage.getItem('changeovers')) || [];
                }
            } else {
                changeovers = JSON.parse(localStorage.getItem('changeovers')) || [];
            }

            // Client-side filtering
            const searchQCO = document.getElementById('searchQCO').value.toLowerCase();
            const filterLine = document.getElementById('filterLine').value;

            const filteredChangeovers = changeovers.filter(co => {
                const matchesSearch = (co.qcoNumber || '').toLowerCase().includes(searchQCO) ||
                    (co.currentStyle || '').toLowerCase().includes(searchQCO) ||
                    (co.upcomingStyle || '').toLowerCase().includes(searchQCO);
                const matchesLine = filterLine ? (co.lineNumber === filterLine) : true;
                return matchesSearch && matchesLine;
            });

            listContainer.innerHTML = '';

            if (filteredChangeovers.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            }

            filteredChangeovers.forEach(co => {
                const card = document.createElement('div');
                card.className = 'changeover-card p-4 hover:bg-gray-50 cursor-pointer transition-colors';

                const createdDate = co.createdAt ? new Date(co.createdAt).toLocaleDateString() : 'N/A';
                const emailStatus = co.emailSent ? '<span class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i> Email Sent</span>' : '<span class="text-gray-400 font-bold text-xs"><i class="fas fa-clock"></i> Draft</span>';

                // Determine if user can edit (Admin only) or verify (All)
                // We show "View" for everyone

                card.onclick = () => viewChangeover(co.id);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="qco-code text-sm">${co.qcoNumber || 'N/A'}</span>
                            <span class="ml-2 text-xs font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded">Line ${co.lineNumber}</span>
                        </div>
                        <div>${emailStatus}</div>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-700 mb-1">
                        <span class="font-medium">${co.currentStyle || '?'}</span>
                        <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
                        <span class="font-medium">${co.upcomingStyle || '?'}</span>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-user mr-1"></i> ${co.createdBy || 'System'}
                            <span class="mx-1">•</span>
                            <i class="fas fa-calendar mr-1"></i> ${createdDate}
                        </div>
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="event.stopPropagation(); viewChangeover('${co.id}')">
                            View Details
                        </button>
                    </div>
                `;

                listContainer.appendChild(card);
            });
        }

        async function viewChangeover(id) {
            currentModalChangeoverId = id;

            // Find the record
            let record = null;
            if (isFirebaseConnected) {
                try {
                    const doc = await db.collection('changeovers').doc(id).get();
                    if (doc.exists) {
                        record = { id: doc.id, ...doc.data() };
                    }
                } catch (e) {
                    console.error("Error fetching record", e);
                }
            }

            // Fallback to local filtering if not found or no firebase
            if (!record) {
                const localData = JSON.parse(localStorage.getItem('changeovers')) || [];
                record = localData.find(r => r.id === id);
            }

            if (!record) {
                showNotification("Record not found", "error");
                return;
            }

            // Populate Modal
            document.getElementById('modalQCOCode').textContent = record.qcoNumber || 'N/A';
            document.getElementById('modalLine').textContent = record.lineNumber || '-';

            document.getElementById('modalCurrentStyle').textContent = record.currentStyle || '-';
            document.getElementById('modalCurrentSMV').textContent = record.currentSMV || '-';
            document.getElementById('modalCurrentTarget').textContent = record.currentTarget || '-';

            document.getElementById('modalUpcomingStyle').textContent = record.upcomingStyle || '-';
            document.getElementById('modalUpcomingSMV').textContent = record.upcomingSMV || '-';
            document.getElementById('modalUpcomingTarget').textContent = record.upcomingTarget || '-';

            document.getElementById('modalCreatedDate').textContent = record.createdAt ? new Date(record.createdAt).toLocaleString() : '-';
            document.getElementById('modalEmailSent').textContent = record.emailSent ? new Date(record.emailSent).toLocaleString() : 'Not Sent';

            // Machine Summary
            if (record.machineSummary && record.machineSummary.length > 0) {
                const summaryHtml = record.machineSummary.map(m =>
                    `<div class="flex justify-between text-xs py-1 border-b last:border-0 border-gray-200">
                        <span>${m.machine}</span>
                        <span class="${m.surplus > 0 ? 'text-green-600' : 'text-red-600'} font-bold">
                            ${m.surplus > 0 ? '-' + m.surplus : '+' + m.required}
                        </span>
                      </div>`
                ).join('');
                document.getElementById('modalMachineSummary').innerHTML = summaryHtml || 'No machine changes.';
            } else {
                document.getElementById('modalMachineSummary').textContent = 'No machine data available.';
            }

            // Show Admin Actions only for Admin
            const adminActions = document.getElementById('modalAdminActions');
            if (currentUser && currentUser.role === 'admin') {
                adminActions.classList.remove('hidden');
            } else {
                adminActions.classList.add('hidden');
            }

            // Verify Email Button Logic (User Actions)
            const userActionsContainer = document.getElementById('modalUserActions');
            userActionsContainer.innerHTML = ''; // Clear previous

            // Only show Review button if email exists AND hasn't been sent yet
            if (record.emailBodyHtml && !record.emailSent) {
                userActionsContainer.innerHTML = `
                    <button onclick="reviewSavedEmail('${record.id}')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition-colors duration-200 flex items-center">
                        <i class="fas fa-envelope-open-text mr-2"></i> Review Saved Email
                    </button>
                `;
            } else if (record.emailSent) {
                // Optional: visual indicator in footer? 
                // The user said "then you see that the email has been sent for this too"
                // The main modal body already receives 'modalEmailSent' update.
                // We can add a "Sent" badge here too if desired, but hiding the button handles the main request.
                userActionsContainer.innerHTML = `
                    <span class="text-green-600 font-medium px-3 py-2 flex items-center bg-green-50 rounded-lg border border-green-200">
                        <i class="fas fa-check-circle mr-2"></i> Sent
                    </span>
                `;
            }

            // Show Modal
            document.getElementById('changeoverModal').classList.remove('hidden');
        }

        // Removed createEmailActionsContainer as it's no longer needed (in HTML now)

        async function reviewSavedEmail(id) {
            currentReviewQCOId = id; // Track tracking ID

            // Fetch record again to be sure (or use cached if reliable)
            let record = null;
            if (currentModalChangeoverId === id) {
                // We likely have it, but viewChangeover scope is closed. 
                // Re-fetch to be safe and simple
            }

            if (isFirebaseConnected) {
                const doc = await db.collection('changeovers').doc(id).get();
                if (doc.exists) record = { id: doc.id, ...doc.data() };
            }

            if (!record) {
                const localData = JSON.parse(localStorage.getItem('changeovers')) || [];
                record = localData.find(r => r.id === id);
            }

            if (!record || !record.emailBodyHtml) {
                showNotification("No saved email found for this record.", "error");
                return;
            }

            // Populate SMTP Modal
            document.getElementById('modalSenderEmail').value = "management.trainee@sidneyapparels.com";
            document.getElementById('modalRecipients').value = Array.isArray(record.emailRecipients) ? record.emailRecipients.join(', ') : record.emailRecipients;
            document.getElementById('modalSubject').value = record.emailSubject;

            // We need to inject the HTML body somewhere if we want to preview it, 
            // but the SMTP modal mainly expects us to just send.
            // For now, let's assume we proceed to send. 
            // If we want to preview *again* in the big editor, we'd need to switch views.
            // But the user asked for a "pop up modal... option to send ... populated".

            // Critical: The current sendEmailViaNodemailer reads from the PREVIEW divs (innerHTML) in the backgrounds.
            // We must populate those hidden preview divs so `sendEmailViaNodemailer` can grab them.

            document.getElementById('emailPreviewContent').innerHTML = record.emailBodyHtml;
            document.getElementById('plainTextEmail').value = "Please use HTML view."; // Fallback

            // Show SMTP Modal
            closeChangeoverModal();
            document.getElementById('smtpModal').classList.remove('hidden');
        }

        function closeChangeoverModal() {
            document.getElementById('changeoverModal').classList.add('hidden');
            currentModalChangeoverId = null;
        }

        function deleteCurrentChangeover() {
            if (!currentModalChangeoverId) return;
            if (!confirm("Are you sure you want to delete this Changeover Record? This cannot be undone.")) return;

            if (isFirebaseConnected) {
                db.collection('changeovers').doc(currentModalChangeoverId).delete().then(() => {
                    showNotification("Record deleted successfully", "success");
                    closeChangeoverModal();
                    refreshChangeoverData();
                }).catch(err => {
                    showNotification("Error deleting: " + err.message, "error");
                });
            } else {
                let localData = JSON.parse(localStorage.getItem('changeovers')) || [];
                localData = localData.filter(r => r.id !== currentModalChangeoverId);
                localStorage.setItem('changeovers', JSON.stringify(localData));
                showNotification("Record deleted locally", "success");
                closeChangeoverModal();
                refreshChangeoverData();
            }
        }

        function editCurrentChangeover() {
            // Placeholder for edit functionality - for now just notify
            if (!currentModalChangeoverId) return;
            // To implement robust editing, we would replace text fields with inputs in the modal
            // For this iteration, we focus on View/Delete logic as requested primarily
            showNotification("Edit functionality coming in next update. Use Delete & Re-create if strict editing needed.", "info");
        }

        function filterChangeovers() {
            refreshChangeoverData();
        }

        // ============================================
        // EMAIL ID MANAGEMENT SYSTEM - FIXED VERSION
        // ============================================

        async function loadEmailDataFromFirebase() {
            if (!isFirebaseConnected) {
                addFirebaseLog('Firebase not connected, loading from local storage', 'warning');
                loadEmailDataFromLocal();
                return;
            }

            try {
                addFirebaseLog('Loading email data from Firebase...', 'info');

                const emailDocRef = db.collection('emailData').doc('lines');
                const doc = await emailDocRef.get();

                if (doc.exists) {
                    emailData = doc.data();
                    localStorage.setItem('emailData', JSON.stringify(emailData));
                    addFirebaseLog('Email data loaded from Firebase successfully', 'success');

                    // Update email management table if it's visible
                    if (!document.getElementById('emailManagementSection').classList.contains('hidden')) {
                        renderEmailManagementTable();
                    }

                    showNotification('Email data loaded from Firebase', 'success');
                } else {
                    addFirebaseLog('No email data in Firebase, creating default structure', 'info');

                    // Create default structure
                    await initializeFirebaseCollections();
                    await loadEmailDataFromFirebase(); // Try again
                }
            } catch (error) {
                addFirebaseLog(`Error loading email data from Firebase: ${error.message}`, 'error');
                loadEmailDataFromLocal();
            }
        }

        function loadEmailDataFromLocal() {
            addFirebaseLog('Loading email data from local storage', 'info');

            const savedData = localStorage.getItem('emailData');
            if (savedData) {
                try {
                    emailData = JSON.parse(savedData);
                    addFirebaseLog('Email data loaded from local storage', 'success');

                    // Update email management table if it's visible
                    if (!document.getElementById('emailManagementSection').classList.contains('hidden')) {
                        renderEmailManagementTable();
                    }
                } catch (error) {
                    addFirebaseLog(`Error parsing local email data: ${error.message}`, 'error');
                    initializeDefaultEmailData();
                }
            } else {
                initializeDefaultEmailData();
            }
        }

        function initializeDefaultEmailData() {
            emailData = {};
            const lines = ["1", "1A", "2", "3", "6+17", "7", "7A", "8+5", "9", "10", "11+15", "12", "13/21", "14", "16", "16A", "18", "19", "20", "22", "23", "24", "25", "26/4", "28", "29", "30", "31", "32"];

            lines.forEach(line => {
                if (!emailData[line]) {
                    emailData[line] = {
                        supervisor: "",
                        rqc: "",
                        ie: "",
                        lineIncharge: "",
                        qam: "",
                        mechIncharge: "",
                        technical: "",
                        planning: "",
                        production: "",
                        fabric: "",
                        cutting: "",
                        maintenance: "",
                        lastUpdated: new Date().toISOString()
                    };
                }
            });

            localStorage.setItem('emailData', JSON.stringify(emailData));
            renderEmailManagementTable();
            addFirebaseLog('Created default email data structure', 'info');
        }

        async function saveEmailDataToFirebase() {
            if (!isFirebaseConnected) {
                addFirebaseLog('Firebase not connected. Data saved locally only.', 'warning');
                showNotification('Firebase not connected. Data saved locally only.', 'warning');
                return;
            }

            try {
                addFirebaseLog('Saving email data to Firebase...', 'info');

                const emailDocRef = db.collection('emailData').doc('lines');
                await emailDocRef.set(emailData, { merge: true });

                addFirebaseLog('Email data saved to Firebase successfully', 'success');
                showNotification('Email data saved to Firebase', 'success');
                logActivity(`${currentUser.name} updated email data in Firebase`, 'email_management');
            } catch (error) {
                addFirebaseLog(`Error saving email data to Firebase: ${error.message}`, 'error');
                showNotification('Failed to save to Firebase. Data saved locally.', 'error');
            }
        }

        async function syncEmailData() {
            if (isFirebaseConnected) {
                await saveEmailDataToFirebase();
            } else {
                showNotification('Cannot sync: Firebase is not connected', 'error');
                addFirebaseLog('Cannot sync: Firebase is not connected', 'error');
            }
        }

        function refreshEmailData() {
            if (isFirebaseConnected) {
                loadEmailDataFromFirebase();
            } else {
                loadEmailDataFromLocal();
                showNotification('Refreshed from local storage (Firebase disconnected)', 'info');
                addFirebaseLog('Refreshed from local storage (Firebase disconnected)', 'info');
            }
        }

        function loadEmailManagement() {
            renderEmailManagementTable();
        }

        function renderEmailManagementTable() {
            const tableBody = document.getElementById('emailManagementTable');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Sort lines for display
            const lines = Object.keys(emailData).sort((a, b) => {
                // Handle special cases like "6+17", "13/21", etc.
                const aNum = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                const bNum = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                return aNum - bNum;
            });

            lines.forEach(line => {
                const row = document.createElement('tr');
                const lineData = emailData[line] || {};

                row.innerHTML = `
                    <td class="font-medium text-gray-900">${line}</td>
                    <!-- Supervisor -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="supervisor" value="${lineData.supervisor || ''}" placeholder="Sup" onchange="updateEmailField(this)">
                    </td>
                    <!-- RQC -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="rqc" value="${lineData.rqc || ''}" placeholder="RQC" onchange="updateEmailField(this)">
                    </td>
                    <!-- IE -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="ie" value="${lineData.ie || ''}" placeholder="IE" onchange="updateEmailField(this)">
                    </td>
                    <!-- Line Incharge -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="lineIncharge" value="${lineData.lineIncharge || ''}" placeholder="Incharge" onchange="updateEmailField(this)">
                    </td>
                    <!-- Planning (NEW) -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="planning" value="${lineData.planning || ''}" placeholder="Planning" onchange="updateEmailField(this)">
                    </td>
                     <!-- Maintenance (NEW) -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="maintenance" value="${lineData.maintenance || ''}" placeholder="Maint" onchange="updateEmailField(this)">
                    </td>
                     <!-- Technical (NEW) -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="technical" value="${lineData.technical || ''}" placeholder="Tech" onchange="updateEmailField(this)">
                    </td>
                     <!-- Quality/QAM -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="qam" value="${lineData.qam || ''}" placeholder="QAM" onchange="updateEmailField(this)">
                    </td>
                     <!-- Production -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="production" value="${lineData.production || ''}" placeholder="Prod" onchange="updateEmailField(this)">
                    </td>
                     <!-- Fabric -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="fabric" value="${lineData.fabric || ''}" placeholder="Fabric" onchange="updateEmailField(this)">
                    </td>
                    <!-- Cutting -->
                    <td class="email-input-cell">
                        <input type="email" class="w-full p-2 border border-gray-300 rounded-lg text-sm email-input"
                               data-line="${line}" data-role="cutting" value="${lineData.cutting || ''}" placeholder="Cutting" onchange="updateEmailField(this)">
                    </td>
                    <td>
                        <button onclick="clearLineEmails('${line}')" 
                                class="px-3 py-1 text-sm text-red-600 hover:text-red-800"
                                title="Clear all emails for this line">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            addFirebaseLog(`Rendered email management table with ${lines.length} lines`, 'info');
        }

        async function updateEmailField(input) {
            const line = input.dataset.line;
            const role = input.dataset.role;
            const value = input.value.trim();

            // Validate email format if value is provided
            if (value && !isValidEmail(value)) {
                showNotification('Please enter a valid email address', 'error');
                input.focus();
                return;
            }

            // Ensure line data exists
            if (!emailData[line]) {
                emailData[line] = {
                    supervisor: "",
                    rqc: "",
                    ie: "",
                    lineIncharge: "",
                    qam: "",
                    mechIncharge: "",
                    technical: "",
                    planning: "",
                    production: "",
                    fabric: "",
                    cutting: "",
                    maintenance: "",
                    lastUpdated: new Date().toISOString()
                };
            }

            // Update the value
            emailData[line][role] = value;
            emailData[line].lastUpdated = new Date().toISOString();

            // Save to local storage
            localStorage.setItem('emailData', JSON.stringify(emailData));

            // Try to save to Firebase
            if (isFirebaseConnected) {
                await saveEmailDataToFirebase();
            }

            // Log activity
            logActivity(`${currentUser.name} updated ${role} email for line ${line}: ${value || 'cleared'}`, 'email_management');

            // Update email preview if it's open
            if (comparisonResults && selectedLine === line) {
                generateEmail();
            }
        }

        async function clearLineEmails(line) {
            if (confirm(`Clear all email IDs for Line ${line}?`)) {
                if (emailData[line]) {
                    emailData[line] = {
                        supervisor: "",
                        rqc: "",
                        ie: "",
                        lineIncharge: "",
                        qam: "",
                        mechIncharge: "",
                        technical: "",
                        planning: "",
                        production: "",
                        fabric: "",
                        cutting: "",
                        maintenance: "",
                        lastUpdated: new Date().toISOString()
                    };

                    // Save to local storage
                    localStorage.setItem('emailData', JSON.stringify(emailData));

                    // Try to save to Firebase
                    if (isFirebaseConnected) {
                        await saveEmailDataToFirebase();
                    }

                    // Re-render table
                    renderEmailManagementTable();

                    // Log activity
                    logActivity(`${currentUser.name} cleared all email IDs for line ${line}`, 'email_management');

                    showNotification(`Email IDs cleared for Line ${line}`, 'success');
                    addFirebaseLog(`Cleared all email IDs for line ${line}`, 'info');
                }
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // ============================================
        // BULK UPLOAD FUNCTIONALITY
        // ============================================

        function handleBulkUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const csvContent = e.target.result;
                    const results = Papa.parse(csvContent, {
                        header: true,
                        skipEmptyLines: true
                    });

                    if (results.errors.length > 0) {
                        showNotification('Error parsing CSV file', 'error');
                        console.error('CSV parsing errors:', results.errors);
                        return;
                    }

                    bulkUploadData = results.data;
                    showCSVPreview(bulkUploadData);

                    document.getElementById('processBulkUpload').classList.remove('hidden');
                    showNotification(`CSV loaded: ${bulkUploadData.length} rows`, 'success');
                    addFirebaseLog(`Loaded CSV file with ${bulkUploadData.length} rows for bulk upload`, 'info');

                } catch (error) {
                    showNotification('Error reading CSV file: ' + error.message, 'error');
                    addFirebaseLog(`Error reading CSV file: ${error.message}`, 'error');
                }
            };

            reader.readAsText(file);
        }

        function showCSVPreview(data) {
            const previewContainer = document.getElementById('csvPreview');
            if (!previewContainer) return;

            if (data.length === 0) {
                previewContainer.innerHTML = '<p class="text-gray-500">No data to preview</p>';
                previewContainer.classList.remove('hidden');
                return;
            }

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';

            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });

            html += '</tr></thead><tbody>';

            data.slice(0, 10).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            if (data.length > 10) {
                html += `<tr><td colspan="${headers.length}" class="text-center text-gray-500">... and ${data.length - 10} more rows</td></tr>`;
            }

            html += '</tbody></table>';

            previewContainer.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }

        async function processBulkUpload() {
            if (!bulkUploadData || bulkUploadData.length === 0) {
                showNotification('No data to process', 'error');
                return;
            }

            let updatedCount = 0;
            let errorCount = 0;

            for (const row of bulkUploadData) {
                try {
                    const line = row.line;
                    if (!line) continue;

                    // Ensure line data exists
                    if (!emailData[line]) {
                        emailData[line] = {
                            supervisor: "",
                            rqc: "",
                            ie: "",
                            lineIncharge: "",
                            qam: "",
                            mechIncharge: "",
                            technical: "",
                            planning: "",
                            production: "",
                            fabric: "",
                            cutting: "",
                            maintenance: "",
                            lastUpdated: new Date().toISOString()
                        };
                    }

                    // Update fields
                    if (row.supervisor && isValidEmail(row.supervisor)) {
                        emailData[line].supervisor = row.supervisor;
                    }
                    if (row.rqc && isValidEmail(row.rqc)) {
                        emailData[line].rqc = row.rqc;
                    }
                    if (row.ie && isValidEmail(row.ie)) {
                        emailData[line].ie = row.ie;
                    }
                    if (row.lineIncharge && isValidEmail(row.lineIncharge)) {
                        emailData[line].lineIncharge = row.lineIncharge;
                    }
                    if (row.qam && isValidEmail(row.qam)) {
                        emailData[line].qam = row.qam;
                    }
                    if (row.mechIncharge && isValidEmail(row.mechIncharge)) {
                        emailData[line].mechIncharge = row.mechIncharge;
                    }
                    if (row.technical && isValidEmail(row.technical)) {
                        emailData[line].technical = row.technical;
                    }

                    emailData[line].lastUpdated = new Date().toISOString();
                    updatedCount++;

                } catch (error) {
                    console.error('Error processing row:', row, error);
                    errorCount++;
                }
            }

            // Save to local storage
            localStorage.setItem('emailData', JSON.stringify(emailData));

            // Try to save to Firebase
            if (isFirebaseConnected) {
                await saveEmailDataToFirebase();
            }

            // Re-render table
            renderEmailManagementTable();

            // Reset bulk upload
            document.getElementById('bulkUploadFile').value = '';
            document.getElementById('csvPreview').classList.add('hidden');
            document.getElementById('processBulkUpload').classList.add('hidden');
            bulkUploadData = null;

            // Show results
            const message = `Bulk upload completed: ${updatedCount} lines updated${errorCount > 0 ? `, ${errorCount} errors` : ''}`;
            showNotification(message, 'success');
            addFirebaseLog(message, 'success');
            logActivity(`${currentUser.name} performed bulk upload: ${updatedCount} lines updated`, 'email_management');
        }

        // ============================================
        // UPDATED EMAIL GENERATION WITH ATTACHMENTS
        // ============================================

        function generateEmailRecipients() {
            const recipients = new Set(); // Use Set to ensure uniqueness

            if (!selectedLine) return [];

            // Smart Lookup for combined lines (e.g. "15" should find "11+15")
            let lookupLine = selectedLine.replace(/^Line\s*/i, '').trim();

            if (!emailData[lookupLine]) {
                const foundKey = Object.keys(emailData).find(key => {
                    const parts = key.split(/[\+\/]/).map(p => p.trim());
                    return parts.includes(lookupLine);
                });
                if (foundKey) lookupLine = foundKey;
            }

            const lineEmails = emailData[lookupLine] || {};

            // Add email IDs from Firebase/Local
            if (lineEmails.supervisor) recipients.add(lineEmails.supervisor);
            if (lineEmails.rqc) recipients.add(lineEmails.rqc);
            if (lineEmails.ie) recipients.add(lineEmails.ie);
            if (lineEmails.lineIncharge) recipients.add(lineEmails.lineIncharge);
            if (lineEmails.qam) recipients.add(lineEmails.qam);
            if (lineEmails.mechIncharge) recipients.add(lineEmails.mechIncharge);
            if (lineEmails.technical) recipients.add(lineEmails.technical);
            if (lineEmails.planning) recipients.add(lineEmails.planning);
            if (lineEmails.production) recipients.add(lineEmails.production);
            if (lineEmails.fabric) recipients.add(lineEmails.fabric);
            if (lineEmails.cutting) recipients.add(lineEmails.cutting);
            if (lineEmails.maintenance) recipients.add(lineEmails.maintenance);

            // Add additional recipients from select2
            const additionalRecipients = $('#additionalRecipients').select2('data');
            additionalRecipients.forEach(recipient => {
                recipients.add(recipient.text);
            });

            // Add default CC from settings
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            if (settings.defaultCC) {
                settings.defaultCC.split(',').forEach(email => {
                    const trimmedEmail = email.trim();
                    if (trimmedEmail) {
                        recipients.add(trimmedEmail);
                    }
                });
            }

            // Add CC and BCC from inputs
            const cc = document.getElementById('emailCC').value;
            if (cc) {
                cc.split(',').forEach(email => {
                    const trimmedEmail = email.trim();
                    if (trimmedEmail) {
                        recipients.add(trimmedEmail);
                    }
                });
            }

            return Array.from(recipients);
        }

        function generateEmail() {
            if (!comparisonResults || !selectedLine || !currentOBData || !upcomingOBData) return;

            const lookupLine = document.getElementById('lineSelect').value;
            const lineData = {
                supervisor: document.getElementById('supervisorName').value.trim() || (personnelData[lookupLine]?.supervisor || "TBD"),
                rqc: document.getElementById('rqcName').value.trim() || (personnelData[lookupLine]?.rqc || "TBD"),
                ie: document.getElementById('ieName').value.trim() || (personnelData[lookupLine]?.ie || "TBD"),
                lineIncharge: document.getElementById('lineIncharge').value.trim() || (personnelData[lookupLine]?.lineIncharge || "TBD"),
                qam: document.getElementById('qamName').value.trim() || (personnelData[lookupLine]?.qam || "TBD"),
                mechIncharge: document.getElementById('mechIncharge').value.trim() || (personnelData[lookupLine]?.mechIncharge || "TBD"),
                technical: document.getElementById('technicalName').value.trim() || (personnelData[lookupLine]?.technical || "TBD")
            };

            // Update QCO number display in email section
            if (currentQCONumber) {
                document.getElementById('emailQCONumber').textContent = currentQCONumber;
            }

            // Get email recipients
            const recipients = generateEmailRecipients();

            const criticalMachines = comparisonResults.filter(r => r.required > 0);
            const machinesToRelease = comparisonResults.filter(r => r.surplus > 0);

            const meetingDateInput = document.getElementById('meetingDate');
            const meetingDate = meetingDateInput.value ? new Date(meetingDateInput.value) : new Date();
            meetingDate.setDate(meetingDate.getDate() + 1);
            const formattedDate = meetingDate.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const smvChange = upcomingOBData.smv - currentOBData.smv;
            const targetChange = upcomingOBData.target - currentOBData.target;
            const sign = smvChange >= 0 ? '+' : '';

            let machineList = "None";
            let releaseList = "None";

            if (criticalMachines.length > 0) {
                machineList = criticalMachines.map(m => {
                    let remark = m.remarks ? ` (${m.remarks})` : '';
                    return `• ${m.machine}: Need ${m.required} more (Current: ${m.current}, Required: ${m.upcoming})${remark}`;
                }).join('\n');
            }

            if (machinesToRelease.length > 0) {
                releaseList = machinesToRelease.map(m => {
                    let remark = m.remarks ? ` (${m.remarks})` : '';
                    return `• ${m.machine}: Release ${m.surplus} machines (Current: ${m.current}, Required: ${m.upcoming})${remark}`;
                }).join('\n');
            }

            // Get email IDs for display - lookup by parent line for complex lines
            const lineEmails = emailData[lookupLine] || emailData[selectedLine] || {};

            // Generate HTML email content
            const htmlContent = generateHtmlEmailContent(criticalMachines, machinesToRelease, meetingDate, lineData, formattedDate, sign, smvChange, targetChange, machineList, releaseList, lineEmails);

            // Generate plain text email content/
            // Note: Plain text is less prioritized now, simplified call
            const plainTextContent = "Please use HTML view."; // simplified for now as HTML is primary

            // Update preview
            document.getElementById('emailPreviewContent').innerHTML = htmlContent;
            document.getElementById('plainTextEmail').value = plainTextContent;

            // Update recipients and subject
            // Update recipients and subject
            let subjectPrefix = "";
            if (typeof emailTemplate !== 'undefined') {
                if (emailTemplate === 'urgent') subjectPrefix = "⚠️ [URGENT] ";
                else if (emailTemplate === 'detailed') subjectPrefix = "[DETAILED ANALYSIS] ";
            }

            const subject = `${subjectPrefix}[${currentQCONumber || 'QCO'}] Changeover Meeting: Style Changeover ${currentOBData.style || "Current"} → ${upcomingOBData.style || "Upcoming"} (Line ${selectedLine})`;
            document.getElementById('previewSubject').textContent = subject;

            document.getElementById('previewRecipients').textContent = recipients.join(', ');

            // Update attachment preview
            updateEmailAttachmentPreview();

            // Show appropriate preview mode
            toggleEmailPreviewMode(previewMode);

            // Log activity
            logActivity(`${currentUser.name} generated changeover email for Line ${selectedLine} (${typeof emailTemplate !== 'undefined' ? emailTemplate : 'standard'})`, 'email');

            // --- SAVE EMAIL DATA TO QCO RECORD ---
            currentEmailData = {
                emailSubject: subject,
                emailRecipients: recipients,
                emailBodyHtml: htmlContent,
                emailGeneratedAt: new Date().toISOString()
            };

            if (currentQCONumber) {
                // Save to local storage
                let localChangeovers = JSON.parse(localStorage.getItem('changeovers') || '[]');
                const idx = localChangeovers.findIndex(co => co.qcoNumber === currentQCONumber);
                if (idx !== -1) {
                    localChangeovers[idx] = { ...localChangeovers[idx], ...currentEmailData };
                    localStorage.setItem('changeovers', JSON.stringify(localChangeovers));
                }

                // Save to Firebase (Update only if doc likely exists)
                if (isFirebaseConnected) {
                    db.collection('changeovers').doc(currentQCONumber).update(currentEmailData)
                        .then(() => console.log("Email data saved to QCO record via update"))
                        .catch(err => console.log("Skipping email update - doc likely being created"));
                }
            }
        }

        function generateHtmlEmailContent(criticalMachines, machinesToRelease, meetingDate, lineData, formattedDate, sign, smvChange, targetChange, machineList, releaseList, lineEmails) {
            // Get settings for default meeting time
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const meetingTime = settings.defaultMeetingTime || "09:00";

            // INLINE STYLES for QCO Highlight (Ensures visibility in email clients)
            const qcoStyle = "background-color: #fffbeb; border: 2px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 8px; font-weight: 800; margin-bottom: 20px; display: inline-block; font-size: 1.1em; box-shadow: 0 2px 4px rgba(0,0,0,0.05);";
            const qcoDisplay = currentQCONumber ? `<div style="${qcoStyle}">Changeover Reference: ${currentQCONumber}</div>` : '';

            // Template Handling
            let headerColor = "#1e40af"; // Default Blue
            let urgencyBanner = "";
            let template = (typeof emailTemplate !== 'undefined') ? emailTemplate : 'standard';

            let contentBody = "";

            if (template === 'urgent') {
                headerColor = "#b91c1c"; // Red
                urgencyBanner = `
                <div style="background-color: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 15px; text-align: center; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <div style="font-size: 18px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px;">⚠️ URGENT CHANGEOVER NOTICE</div>
                    <div style="font-size: 14px;">Immediate preparation and attention required. Please prioritize this transition.</div>
                </div>`;

                // URGENT TEMPLATE: Focus on CRITICAL items only
                contentBody = `
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        CRITICAL LOGISTICS
                    </h3>
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 20px;">
                        Date: ( to be decided by planning team ) | Line ${selectedLine}<br>
                        <div style="margin-top: 10px;">
                            <strong>Checklist:</strong> <a href="https://shantanuguin.github.io/sidneyme/outlist.html" style="color: #b91c1c; font-weight: bold; text-decoration: underline; background-color: #fee2e2; padding: 4px 8px; border-radius: 4px; border: 1px solid #fecaca;">Department Checklist Link</a>
                        </div>
                    </div>
                    
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        STYLE CHANGE
                    </h3>
                    <div style="font-size: 1.1em;">
                        <strong>Current:</strong> ${currentOBData.style || "N/A"} &rarr; 
                        <strong>Upcoming:</strong> ${upcomingOBData.style || "N/A"}
                    </div>

                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        CRITICAL MACHINE REQUIREMENTS
                    </h3>
                    
                    ${criticalMachines.length > 0 ? `
                        <div style="background-color: #fef2f2; padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 5px solid #dc2626;">
                            <h4 style="margin-top: 0; margin-bottom: 12px; color: #991b1b; text-transform: uppercase;">MACHINES TO ADD IMMEDIATELY:</h4>
                            <pre style="margin: 0; font-family: inherit; white-space: pre-wrap; font-weight: bold; color: #7f1d1d;">${machineList}</pre>
                        </div>
                    ` : '<p style="color: #047857; font-weight: bold;">No new machines required.</p>'}
                    
                    ${this.generateStandardAttendeesSection(headerColor, lineData, lineEmails)}
                `;

            } else if (template === 'detailed') {
                headerColor = "#047857"; // Green
                urgencyBanner = `
                <div style="background-color: #ecfdf5; border: 1px solid #10b981; color: #065f46; padding: 12px; text-align: center; margin-bottom: 25px; border-radius: 8px;">
                    <div style="font-weight: 600;">Detailed Transition Analysis</div>
                    <div style="font-size: 12px; opacity: 0.8;">Full comprehensive report for records and planning.</div>
                </div>`;

                // Calculate additional metrics
                const currentWP = currentOBData.allotedWP || 0;
                const upcomingWP = upcomingOBData.allotedWP || 0;
                const wpDelta = upcomingWP - currentWP;

                const currentOps = currentOBData.operations ? currentOBData.operations.length : 0;
                const upcomingOps = upcomingOBData.operations ? upcomingOBData.operations.length : 0;

                const efficiencyCurrent = (currentOBData.smv && currentOBData.target) ? ((currentOBData.smv * currentOBData.target) / (480 * (currentWP || 1)) * 100).toFixed(1) : "N/A";
                const efficiencyUpcoming = (upcomingOBData.smv && upcomingOBData.target) ? ((upcomingOBData.smv * upcomingOBData.target) / (480 * (upcomingWP || 1)) * 100).toFixed(1) : "N/A";

                // DETAILED TEMPLATE: Everything + More Metrics
                contentBody = `
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        MEETING LOGISTICS
                    </h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr><td style="width: 140px; font-weight: bold;">Date:</td><td>( to be decided by planning team in a follow up email)</td></tr>
                        <tr><td style="font-weight: bold;">Checklist:</td><td><a href="https://shantanuguin.github.io/sidneyme/outside/outlist.html" style="color: #047857; font-weight: bold; text-decoration: underline; background-color: #ecfdf5; padding: 3px 6px; border-radius: 4px; border: 1px solid #a7f3d0;">Department Checklist Link</a></td></tr>
                        <tr><td style="font-weight: bold;">Location:</td><td>Line ${selectedLine} - Production Floor</td></tr>
                        <tr><td style="font-weight: bold;">Purpose:</td><td>Detailed Layout & Resource Planning</td></tr>
                    </table>

                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        STYLE & METRICS COMPARISON
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.95em;">
                        <thead>
                            <tr style="background-color: #f3f4f6; text-align: left;">
                                <th style="padding: 8px; border: 1px solid #e5e7eb;">Metric</th>
                                <th style="padding: 8px; border: 1px solid #e5e7eb;">Current Style</th>
                                <th style="padding: 8px; border: 1px solid #e5e7eb;">Upcoming Style</th>
                                <th style="padding: 8px; border: 1px solid #e5e7eb;">Variance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>Style Name</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${currentOBData.style || "N/A"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingOBData.style || "N/A"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>SMV</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${currentOBData.smv ? currentOBData.smv.toFixed(2) : "--"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingOBData.smv ? upcomingOBData.smv.toFixed(2) : "--"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb; color: ${sign === '+' ? '#b91c1c' : '#047857'}">${sign}${smvChange.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>Target (pcs/day)</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${currentOBData.target || "--"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingOBData.target || "--"}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${targetChange > 0 ? '+' : ''}${targetChange}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>Manpower (WP)</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${currentWP}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingWP}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${wpDelta > 0 ? '+' : ''}${wpDelta}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>Operations Count</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${currentOps}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingOps}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${upcomingOps - currentOps}</td>
                            </tr>
                            <tr style="background-color: #f9fafb;">
                                <td style="padding: 8px; border: 1px solid #e5e7eb;"><strong>Est. Line Efficiency</strong></td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${efficiencyCurrent}%</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${efficiencyUpcoming}%</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">-</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        RESOURCE PLAN
                    </h3>
                    
                    <div style="background-color: #fff7ed; padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #f97316;">
                        <h4 style="margin-top: 0; margin-bottom: 8px; color: #9a3412;">MACHINES TO ACQUIRE (Shortage):</h4>
                        <pre style="margin: 0; font-family: inherit; white-space: pre-wrap;">${machineList}</pre>
                    </div>
                    
                    <div style="background-color: #f0fdf4; padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #22c55e;">
                        <h4 style="margin-top: 0; margin-bottom: 8px; color: #166534;">MACHINES TO RETURN (Surplus):</h4>
                        <pre style="margin: 0; font-family: inherit; white-space: pre-wrap;">${releaseList}</pre>
                    </div>

                    ${this.generateStandardAttendeesSection(headerColor, lineData, lineEmails)}
                    ${this.generateStandardActionItems(headerColor)}
                `;

            } else {
                // STANDARD TEMPLATE (Existing)
                contentBody = `
                    <p>Dear Team,</p>
                    
                    <p>Please be advised that a style changeover is scheduled for Line ${selectedLine}. Below is the operational analysis and resource requirement plan for the transition.</p>
                    
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        MEETING LOGISTICS
                    </h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr><td style="width: 120px; padding: 4px 0;"><strong>Date:</strong></td><td style="padding: 4px 0;">( to be decided by planning team in a follow up email)</td></tr>
                        <tr><td style="padding: 4px 0;"><strong>Checklist:</strong></td><td style="padding: 4px 0;"><a href="https://shantanuguin.github.io/sidneyme/outside/outlist.html" style="color: #2563eb; font-weight: bold; text-decoration: underline; background-color: #eff6ff; padding: 4px 8px; border-radius: 4px; border: 1px solid #bfdbfe;">Department Checklist Link</a></td></tr>
                        <tr><td style="padding: 4px 0;"><strong>Location:</strong></td><td style="padding: 4px 0;">Line ${selectedLine} - Production Floor</td></tr>
                        <tr><td style="padding: 4px 0;"><strong>Purpose:</strong></td><td style="padding: 4px 0;">Pre-production layout review and resource allocation</td></tr>
                    </table>
                    
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        STYLE TRANSITION SUMMARY
                    </h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr><td style="width: 120px; padding: 4px 0;"><strong>Current Style:</strong></td><td style="padding: 4px 0;">${currentOBData.style || "N/A"}</td></tr>
                        <tr><td style="padding: 4px 0;"><strong>Upcoming Style:</strong></td><td style="padding: 4px 0;">${upcomingOBData.style || "N/A"}</td></tr>
                    </table>
                    
                    <div style="background-color: #f8fafc; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; margin-bottom: 8px; color: #374151;">Operational Impact:</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li><strong>SMV Variance:</strong> ${sign}${smvChange.toFixed(2)}</li>
                            <li><strong>Target Variance:</strong> ${targetChange >= 0 ? '+' : ''}${targetChange} pcs/day</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        RESOURCE REQUIREMENTS (MACHINE DELTA)
                    </h3>
                    
                    <div style="background-color: #fef3c7; padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                        <h4 style="margin-top: 0; margin-bottom: 12px; color: #92400e;">1. MACHINES TO ADD (Critical for Setup):</h4>
                        <pre style="margin: 0; font-family: inherit; white-space: pre-wrap;">${machineList}</pre>
                    </div>
                    
                    <div style="background-color: #dcfce7; padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #10b981;">
                        <h4 style="margin-top: 0; margin-bottom: 12px; color: #166534;">2. MACHINES TO RELEASE (Surplus):</h4>
                        <pre style="margin: 0; font-family: inherit; white-space: pre-wrap;">${releaseList}</pre>
                    </div>
                    
                    ${this.generateStandardAttendeesSection(headerColor, lineData, lineEmails)}
                    ${this.generateStandardActionItems(headerColor)}
                `;
            }

            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #374151;">
                    ${qcoDisplay}
                    ${urgencyBanner}
                    ${contentBody}
                    ${this.generateAttachmentsSection(headerColor)}
                    
                    <div class="email-signature" style="margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <p>Regards,<br>
                        <strong>Manufacturing Excellence Department</strong><br>
                        Sidney Apparels LLC, QVJ</p>
                        <p style="font-size: 0.75rem; color: #9ca3af;">
                            This email was automatically generated by Changeover Meeting Initiator System<br>
                            ${currentUser.name}
                        </p>
                    </div>
                </div>
            `;
        }

        // Helper functions attached to window/this context to avoid rewriting same code
        function generateStandardAttendeesSection(headerColor, lineData, lineEmails) {
            return `
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        REQUIRED ATTENDEES
                    </h3>
                    <ul style="margin: 0 0 20px 0; padding-left: 20px;">
                        <li><strong>Supervisor:</strong> ${lineData.supervisor} ${lineEmails.supervisor ? `(${lineEmails.supervisor})` : ''}</li>
                        <li><strong>RQC:</strong> ${lineData.rqc} ${lineEmails.rqc ? `(${lineEmails.rqc})` : ''}</li>
                        <li><strong>IE:</strong> ${lineData.ie} ${lineEmails.ie ? `(${lineEmails.ie})` : ''}</li>
                        <li><strong>Line Incharge:</strong> ${lineData.lineIncharge} ${lineEmails.lineIncharge ? `(${lineEmails.lineIncharge})` : ''}</li>
                        ${lineData.qam && lineData.qam !== 'TBD' ? `<li><strong>QAM:</strong> ${lineData.qam} ${lineEmails.qam ? `(${lineEmails.qam})` : ''}</li>` : (lineEmails.qam ? `<li><strong>QAM:</strong> ${lineEmails.qam}</li>` : '')}
                        <li><strong>Planning:</strong> Yash Mhetre/ Rawan Mazen</li>
                        <li><strong>Production:</strong> Ramesh Perumal</li>
                        <li><strong>Fabric/Cutting:</strong> Shanoop V, Majeed</li>
                        <li><strong>Maintenance:</strong> Abdul Nasar</li>
                        <li><strong>Maintenance:</strong> ${lineData.mechIncharge} ${lineEmails.maintenance ? `(${lineEmails.maintenance})` : ''}</li>
                        <li><strong>Technical:</strong> ${lineData.technical} ${lineEmails.technical ? `(${lineEmails.technical})` : ''}</li>
                        <li style="font-weight: bold; color: #4b5563;">IE Manager : Sathvik Bhat</li>
                    </ul>
             `;
        }

        function generateStandardActionItems(headerColor) {
            return `
                    <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                        ACTION ITEMS
                    </h3>
                    <ol style="margin: 0; padding-left: 20px;">
                        <li><strong>Maintenance:</strong> Ensure all "Machines to Add" are serviced and staged at the line 30 minutes prior to changeover.</li>
                        <li><strong>Supervisor/IE:</strong> Review the new operation bulletin and balance layout.</li>
                        <li><strong>Quality:</strong> Prepare standard operating procedures (SOPs) for the new style.</li>
                    </ol>
            `;
        }

        function generateAttachmentsSection(headerColor) {
            if (!attachments || attachments.length === 0) return '';
            return `
                <h3 style="color: ${headerColor}; border-bottom: 2px solid ${headerColor}40; padding-bottom: 8px; margin-top: 24px; margin-bottom: 16px;">
                    ATTACHMENTS
                </h3>
                <div style="background-color: #f0f9ff; padding: 16px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0 0 8px 0; color: #1e40af;"><strong>${attachments.length} file${attachments.length !== 1 ? 's' : ''} attached:</strong></p>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${attachments.map(att => `<li>${att.name} (${formatFileSize(att.size)})</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function generatePlainTextEmail(criticalMachines, machinesToRelease, meetingDate, lineData, formattedDate, sign, smvChange, targetChange, machineList, releaseList, lineEmails) {
            // Get settings for default meeting time
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const meetingTime = settings.defaultMeetingTime || "09:00";

            const qcoText = currentQCONumber ? `Changeover Reference: ${currentQCONumber}\n\n` : '';

            return `${qcoText}Dear Team,

Please be advised that a style changeover is scheduled for Line ${selectedLine}. Below is the operational analysis and resource requirement plan for the transition.

MEETING LOGISTICS
------------------------------------------------
Date:    ( to be decided by planning team in a follow up email)
Checklist: https://shantanuguin.github.io/sidneyme/outside/outlist.html
Location: Line ${selectedLine} - Production Floor
Purpose:  Pre-production layout review and resource allocation

STYLE TRANSITION SUMMARY
------------------------------------------------
Current Style: ${currentOBData.style || "N/A"}
Upcoming Style: ${upcomingOBData.style || "N/A"}

Operational Impact:
- SMV Variance:    ${sign}${smvChange.toFixed(2)}
- Target Variance: ${targetChange >= 0 ? '+' : ''}${targetChange} pcs/day

RESOURCE REQUIREMENTS (MACHINE DELTA)
------------------------------------------------
1. MACHINES TO ADD (Critical for Setup):
${machineList}

2. MACHINES TO RELEASE (Surplus):
${releaseList}

REQUIRED ATTENDEES
------------------------------------------------
- Supervisor: ${lineData.supervisor}
- RQC: ${lineData.rqc}
- IE: ${lineData.ie}
- Line Incharge: ${lineData.lineIncharge}
- Maintenance: ${lineData.mechIncharge}
- Technical: ${lineData.technical}
- Planning: Yash Mhetre/ Rawan Mazen
- Production: Ramesh Perumal
- Fabric/Cutting: Shanoop V, Majeed
- Maintenance: Abdul Nasar
- IE Manager : Sathvik Bhat

ACTION ITEMS
------------------------------------------------
1. Maintenance: Ensure all "Machines to Add" are serviced and staged at the line 30 minutes prior to changeover.
2. Supervisor/IE: Review the new operation bulletin and balance layout.
3. Quality: Prepare standard operating procedures (SOPs) for the new style.

${attachments.length > 0 ? `
ATTACHMENTS
------------------------------------------------
${attachments.map(att => `- ${att.name} (${formatFileSize(att.size)})`).join('\n')}
` : ''}

Regards,

Manufacturing Excellence Department
Sidney Apparels LLC, QVJ

---
This email was automatically generated by Changeover Meeting Initiator System
Shantanu & Sampreeti`;
        }

        // ============================================
        // NODEMAILER BACKEND FUNCTIONALITY WITH ATTACHMENTS
        // ============================================

        async function checkBackendConnection() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const backendUrl = settings.backendUrl || BACKEND_URL;

            try {
                const response = await fetch(`${backendUrl}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('backendStatus').textContent = 'Connected';
                    document.getElementById('backendStatus').className = 'font-medium text-green-600';
                } else {
                    document.getElementById('backendStatus').textContent = 'Disconnected';
                    document.getElementById('backendStatus').className = 'font-medium text-red-600';
                }
            } catch (error) {
                document.getElementById('backendStatus').textContent = 'Disconnected';
                document.getElementById('backendStatus').className = 'font-medium text-red-600';
            }
        }

        async function testNodemailerConnection() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const backendUrl = settings.backendUrl || BACKEND_URL;
            const testResult = document.getElementById('smtpTestResult');
            const statusElement = document.getElementById('smtpStatus');

            // Update status to testing
            statusElement.textContent = "Testing...";
            statusElement.className = "smtp-status-indicator smtp-status-testing ml-2";

            // Show testing message
            testResult.innerHTML = '<div class="text-yellow-600"><i class="fas fa-spinner fa-spin mr-2"></i>Testing backend connection...</div>';
            testResult.classList.remove('hidden');

            try {
                const response = await fetch(`${backendUrl}/api/test-smtp`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    statusElement.textContent = "Connected";
                    statusElement.className = "smtp-status-indicator smtp-status-connected ml-2";

                    testResult.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Backend connection successful!</div>';
                    showNotification('Backend connection test successful', 'success');
                    logActivity(`${currentUser.name} tested backend connection: Success`, 'smtp');

                    // Update backend status
                    document.getElementById('backendStatus').textContent = 'Connected';
                    document.getElementById('backendStatus').className = 'font-medium text-green-600';
                } else {
                    statusElement.textContent = "Disconnected";
                    statusElement.className = "smtp-status-indicator smtp-status-disconnected ml-2";

                    testResult.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Connection failed: ${result.error || 'Unknown error'}</div>`;
                    showNotification('Backend connection failed', 'error');
                    logActivity(`${currentUser.name} tested backend connection: Failed`, 'smtp');

                    // Update backend status
                    document.getElementById('backendStatus').textContent = 'Disconnected';
                    document.getElementById('backendStatus').className = 'font-medium text-red-600';
                }
            } catch (error) {
                statusElement.textContent = "Disconnected";
                statusElement.className = "smtp-status-indicator smtp-status-disconnected ml-2";

                testResult.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Connection error: ${error.message}</div>`;
                showNotification('Connection to backend failed', 'error');
                logActivity(`${currentUser.name} backend connection error: ${error.message}`, 'smtp_error');

                // Update backend status
                document.getElementById('backendStatus').textContent = 'Disconnected';
                document.getElementById('backendStatus').className = 'font-medium text-red-600';
            }

            // Hide test result after 5 seconds
            setTimeout(() => {
                testResult.classList.add('hidden');
            }, 5000);
        }

        function sendEmailSMTP() {
            if (!comparisonResults || !selectedLine || !currentOBData || !upcomingOBData) {
                showNotification('Please generate a changeover plan first', 'error');
                return;
            }

            // Prepare modal data
            const recipients = generateEmailRecipients();
            const subject = document.getElementById('previewSubject').textContent;

            document.getElementById('modalSenderEmail').value = "planning@sidneyapparels.co";
            document.getElementById('modalRecipients').value = recipients.join(', ');
            document.getElementById('modalSubject').value = subject;

            // Update modal attachment preview
            updateAttachmentList();

            // Show modal
            document.getElementById('smtpModal').classList.remove('hidden');
        }

        function closeSmtpModal() {
            document.getElementById('smtpModal').classList.add('hidden');
            document.getElementById('smtpSendStatus').classList.add('hidden');
            document.getElementById('smtpSendStatus').innerHTML = '';
        }

        async function sendEmailViaNodemailer() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const backendUrl = settings.backendUrl || BACKEND_URL;
            const senderEmail = document.getElementById('modalSenderEmail').value.trim();
            const recipients = document.getElementById('modalRecipients').value;
            const subject = document.getElementById('modalSubject').value;
            const statusElement = document.getElementById('smtpSendStatus');

            if (!senderEmail || !recipients) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            // Get email body
            const emailBody = document.getElementById('plainTextEmail').value;
            const htmlBody = document.getElementById('emailPreviewContent').innerHTML;


            // Prepare attachments for sending
            const emailAttachments = [];
            // Check if we should include original OB files - DISABLED BY DEFAULT AS PER REQUEST
            // Only add if explicitly requested (logic can be added here if needed, but for now we rely on manual attachments)
            // If user wants to re-enable default attachments, we can uncomment logic or add a toggle.

            // Add user-added attachments
            attachments.forEach(attachment => {
                emailAttachments.push({
                    filename: attachment.name,
                    content: attachment.data,
                    contentType: attachment.type || 'application/octet-stream'
                });
            });

            // Show sending status
            statusElement.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Sending email via backend...</div>';
            statusElement.classList.remove('hidden');

            try {
                const response = await fetch(`${backendUrl}/api/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from: senderEmail,
                        to: recipients,
                        subject: subject,
                        html: htmlBody,
                        text: emailBody,
                        cc: document.getElementById('emailCC').value || null,
                        bcc: document.getElementById('emailBCC').value || null,
                        attachments: emailAttachments.length > 0 ? emailAttachments : null
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    statusElement.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Email sent successfully via backend!</div>';
                    showNotification('Email sent successfully!', 'success');
                    logActivity(`${currentUser.name} successfully sent email via backend with ${emailAttachments.length} attachments`, 'email_smtp_success');

                    // Update changeover record with email sent date
                    const targetQCOId = currentQCONumber || currentReviewQCOId;

                    if (targetQCOId) {
                        const emailSentData = {
                            emailSent: new Date().toISOString()
                        };

                        if (isFirebaseConnected) {
                            await db.collection('changeovers').doc(targetQCOId).update(emailSentData)
                                .then(() => console.log("Updated emailSent timestamp"));
                        }

                        // Update local
                        let localChangeovers = JSON.parse(localStorage.getItem('changeovers') || '[]');
                        const idx = localChangeovers.findIndex(co => co.qcoNumber === targetQCOId);
                        if (idx !== -1) {
                            localChangeovers[idx] = { ...localChangeovers[idx], ...emailSentData };
                            localStorage.setItem('changeovers', JSON.stringify(localChangeovers));
                        }

                        // Refresh data to update UI (e.g. show "Sent" badge instead of button)
                        await refreshChangeoverData();
                    }

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeSmtpModal();
                        // Reset review ID
                        currentReviewQCOId = null;
                    }, 2000);
                } else {
                    statusElement.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Failed to send email: ${result.message || result.error}</div>`;
                    showNotification(`Failed to send email: ${result.message || result.error}`, 'error');
                    logActivity(`${currentUser.name} failed to send email via backend: ${result.error}`, 'email_smtp_error');
                }
            } catch (error) {
                console.error('Email sending error:', error);
                statusElement.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Connection error: ${error.message}</div>`;
                showNotification(`Connection error: ${error.message}`, 'error');
                logActivity(`${currentUser.name} backend connection error: ${error.message}`, 'email_smtp_error');
            }
        }

        async function testSMTPConnection() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;
            const backendUrl = settings.backendUrl || BACKEND_URL;
            const statusElement = document.getElementById('smtpSendStatus');

            statusElement.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Testing SMTP Configuration...</div>';
            statusElement.classList.remove('hidden');

            try {
                const response = await fetch(`${backendUrl}/api/test-smtp`);
                const data = await response.json();

                if (response.ok && data.success) {
                    statusElement.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>SMTP Connection Successful! Server is ready.</div>';
                    showNotification('SMTP Server is configured correctly', 'success');
                } else {
                    let errorMsg = data.message || 'Unknown Error';
                    if (data.error && data.error.includes('environment variables')) {
                        errorMsg = 'Server Missing Credentials (SMTP_USERNAME/PASSWORD)';
                    }
                    statusElement.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>${errorMsg}</div>`;
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error("SMTP Test Failed:", error);
                statusElement.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Test Failed: ${error.message}</div>`;
                showNotification(`Test Failed: ${error.message}. Check Vercel Env Vars.`, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function getMimeType(filename) {
            const extension = getFileExtension(filename);
            switch (extension) {
                case 'xlsx':
                    return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                case 'xls':
                    return 'application/vnd.ms-excel';
                case 'csv':
                    return 'text/csv';
                case 'pdf':
                    return 'application/pdf';
                case 'doc':
                    return 'application/msword';
                case 'docx':
                    return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                case 'txt':
                    return 'text/plain';
                case 'png':
                    return 'image/png';
                case 'jpg':
                case 'jpeg':
                    return 'image/jpeg';
                default:
                    return 'application/octet-stream';
            }
        }

        // ============================================
        // USER MANAGEMENT WITH EDIT/DELETE
        // ============================================

        async function loadUserManagement() {
            let users = [];

            if (isFirebaseConnected) {
                try {
                    const usersCollection = db.collection('users');
                    const querySnapshot = await usersCollection.get();

                    users = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data
                        };
                    });

                    addFirebaseLog(`Loaded ${users.length} users from Firebase`, 'success');
                } catch (error) {
                    addFirebaseLog(`Error loading users from Firebase: ${error.message}`, 'error');
                    // Fallback to local storage
                    users = JSON.parse(localStorage.getItem('systemUsers'));
                }
            } else {
                users = JSON.parse(localStorage.getItem('systemUsers'));
            }

            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');

                // Format last login
                let lastLoginDisplay = 'Never';
                if (user.lastLogin) {
                    let lastLoginDate;
                    if (user.lastLogin.toDate) {
                        // Firebase Timestamp
                        lastLoginDate = user.lastLogin.toDate();
                    } else if (typeof user.lastLogin === 'string') {
                        lastLoginDate = new Date(user.lastLogin);
                    } else if (typeof user.lastLogin === 'number') {
                        lastLoginDate = new Date(user.lastLogin);
                    }

                    if (lastLoginDate && !isNaN(lastLoginDate.getTime())) {
                        lastLoginDisplay = lastLoginDate.toLocaleDateString() + ' ' + lastLoginDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                }

                row.innerHTML = `
                    <td>
                        <div class="font-medium">${user.name}</div>
                        <div class="text-xs text-gray-500">${user.email}</div>
                    </td>
                    <td>
                        <span class="px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="text-sm">${lastLoginDisplay}</td>
                    <td>
                        <div class="flex space-x-2">
                            <button onclick="startEditUser('${user.id}')" class="text-blue-600 hover:text-blue-800" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${user.id}', '${user.name}')" class="text-red-600 hover:text-red-800" title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                userList.appendChild(row);
            });
        }

        async function startEditUser(userId) {
            let user = null;

            // Find user in local storage first
            const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            user = users.find(u => u.id.toString() === userId.toString());

            // If not found locally, try Firebase
            if (!user && isFirebaseConnected) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        user = { id: doc.id, ...doc.data() };
                    }
                } catch (error) {
                    console.error("Error fetching user for edit:", error);
                }
            }

            if (!user) {
                showNotification('User not found. Try refreshing the page.', 'error');
                return;
            }

            isEditingUser = true;

            // Populate form safely
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };

            setVal('editUserId', userId);
            setVal('newUserName', user.name);
            setVal('newUserEmail', user.email);
            setVal('newUserRole', user.role || 'user');

            // Password field - optional when editing
            const pwdInput = document.getElementById('newUserPassword');
            if (pwdInput) pwdInput.placeholder = 'Leave blank to keep current password';

            const confirmDiv = document.getElementById('confirmPasswordDiv');
            if (confirmDiv) confirmDiv.classList.add('hidden');

            const hint = document.getElementById('passwordHint');
            if (hint) hint.classList.remove('hidden');

            // Update buttons
            const title = document.getElementById('userFormTitle');
            if (title) title.textContent = 'Edit User';

            const saveBtn = document.getElementById('saveUserBtn');
            if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Update User';

            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.classList.remove('hidden');

            // Scroll to form
            const nameInput = document.getElementById('newUserName');
            if (nameInput) nameInput.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            isEditingUser = false;

            // Clear form
            document.getElementById('editUserId').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserConfirmPassword').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserRole').value = 'user';

            // Reset form UI
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('saveUserBtn').innerHTML = '<i class="fas fa-user-plus mr-2"></i> Add User';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('confirmPasswordDiv').classList.remove('hidden');
            document.getElementById('newUserPassword').placeholder = '';
            document.getElementById('passwordHint').classList.add('hidden');
        }

        async function saveUser() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const confirmPassword = document.getElementById('newUserConfirmPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            const email = document.getElementById('newUserEmail').value.trim();

            // Validation
            if (!name || !email) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            if (isEditingUser) {
                // Editing existing user
                if (password && password !== confirmPassword && !document.getElementById('confirmPasswordDiv').classList.contains('hidden')) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }

                await updateExistingUser(userId, name, email, role, password);
            } else {
                // Adding new user
                if (!password || !confirmPassword) {
                    showNotification('Please fill all required fields', 'error');
                    return;
                }

                if (password !== confirmPassword) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }

                if (password.length < 6) {
                    showNotification('Password must be at least 6 characters', 'error');
                    return;
                }

                await addNewUser(name, email, role, password);
            }
        }

        async function addNewUser(name, email, role, password) {
            // Check if user already exists
            if (isFirebaseConnected) {
                try {
                    const usersCollection = db.collection('users');
                    const querySnapshot = await usersCollection.where('email', '==', email).get();

                    if (!querySnapshot.empty) {
                        showNotification('User with this email already exists', 'error');
                        return;
                    }
                } catch (error) {
                    addFirebaseLog(`Error checking existing user: ${error.message}`, 'error');
                }
            }

            // Create new user
            const newUser = {
                name,
                password,
                role,
                email,
                lastLogin: null,
                created: new Date().toISOString()
            };

            if (isFirebaseConnected) {
                try {
                    // Add to Firebase
                    const usersCollection = db.collection('users');
                    const docRef = await usersCollection.add(newUser);
                    newUser.id = docRef.id;

                    addFirebaseLog(`User added to Firebase: ${name}`, 'success');
                } catch (error) {
                    addFirebaseLog(`Error adding user to Firebase: ${error.message}`, 'error');
                    // Fallback to local storage
                    addUserToLocalStorage(newUser);
                }
            } else {
                addUserToLocalStorage(newUser);
            }

            // Log activity
            logActivity(`${currentUser.name} added new user: ${name} (${role})`, 'user_management');

            // Clear form
            cancelEdit();

            // Reload user list
            loadUserManagement();

            // Show success message
            showNotification(`User "${name}" added successfully`, 'success');
        }

        async function updateExistingUser(userId, name, email, role, password) {
            const updateData = {
                name,
                email,
                role,
                updatedAt: new Date().toISOString()
            };

            if (password) {
                updateData.password = password;
            }

            if (isFirebaseConnected) {
                try {
                    await db.collection('users').doc(userId).update(updateData);
                    addFirebaseLog(`User updated in Firebase: ${userId}`, 'success');
                } catch (error) {
                    addFirebaseLog(`Error updating user in Firebase: ${error.message}`, 'error');
                    updateUserInLocalStorage(userId, updateData);
                }
            } else {
                updateUserInLocalStorage(userId, updateData);
            }

            logActivity(`${currentUser.name} updated user: ${name}`, 'user_management');
            cancelEdit();
            loadUserManagement();
            showNotification(`User "${name}" updated successfully`, 'success');
        }

        function addUserToLocalStorage(newUser) {
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            newUser.id = Date.now(); // Simple ID generation
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
        }

        function updateUserInLocalStorage(userId, updateData) {
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            const userIndex = users.findIndex(u => u.id.toString() === userId.toString());

            if (userIndex !== -1) {
                users[userIndex] = { ...users[userIndex], ...updateData };
                localStorage.setItem('systemUsers', JSON.stringify(users));
            }
        }

        async function deleteUser(userId, userName) {
            if (confirm(`Are you sure you want to delete user "${userName}"?`)) {
                if (isFirebaseConnected) {
                    try {
                        await db.collection('users').doc(userId).delete();
                        addFirebaseLog(`User deleted from Firebase: ${userId}`, 'success');
                    } catch (error) {
                        addFirebaseLog(`Error deleting user from Firebase: ${error.message}`, 'error');
                        deleteUserFromLocalStorage(userId);
                    }
                } else {
                    deleteUserFromLocalStorage(userId);
                }

                logActivity(`${currentUser.name} deleted user: ${userName}`, 'user_management');
                loadUserManagement();
                showNotification(`User "${userName}" deleted successfully`, 'success');
            }
        }

        function deleteUserFromLocalStorage(userId) {
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            const userIndex = users.findIndex(u => u.id.toString() === userId.toString());

            if (userIndex !== -1) {
                const userName = users[userIndex].name;
                users.splice(userIndex, 1);
                localStorage.setItem('systemUsers', JSON.stringify(users));
            }
        }

        async function loadActivityLog() {
            let activities = [];

            if (isFirebaseConnected) {
                try {
                    const activityLogRef = db.collection('activityLog');
                    const querySnapshot = await activityLogRef
                        .orderBy('timestamp', 'desc')
                        .limit(50)
                        .get();

                    activities = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data
                        };
                    });

                    addFirebaseLog(`Loaded ${activities.length} activities from Firebase`, 'success');
                } catch (error) {
                    addFirebaseLog(`Error loading activities from Firebase: ${error.message}`, 'error');
                    // Fallback to local storage
                    activities = JSON.parse(localStorage.getItem('activityLog'));
                }
            } else {
                activities = JSON.parse(localStorage.getItem('activityLog'));
            }

            const timeline = document.getElementById('activityTimeline');
            timeline.innerHTML = '';

            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'timeline-item';

                const timestamp = new Date(activity.timestamp);
                const timeString = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                item.innerHTML = `
                    <div class="text-sm font-medium">${activity.action}</div>
                    <div class="text-xs text-gray-500">${timeString} • ${activity.user}</div>
                    ${activity.details ? `<div class="text-xs text-gray-600 mt-1">${activity.details}</div>` : ''}
                `;

                timeline.appendChild(item);
            });

            // Update activity count
            document.getElementById('totalActivities').textContent = activities.length;
            document.getElementById('systemActivitiesCount').textContent = activities.length;
        }

        async function logActivity(action, type = 'general', details = null) {
            const activity = {
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.name : 'System',
                action,
                type,
                details
            };

            // Save to local storage
            const activities = JSON.parse(localStorage.getItem('activityLog'));
            activities.push(activity);
            localStorage.setItem('activityLog', JSON.stringify(activities));

            // Save to Firebase if connected
            if (isFirebaseConnected) {
                try {
                    await db.collection('activityLog').add(activity);
                } catch (error) {
                    addFirebaseLog(`Error saving activity to Firebase: ${error.message}`, 'error');
                }
            }

            // If admin is viewing the activity log, refresh it
            if (currentUser && currentUser.role === 'admin' &&
                !document.getElementById('activityLogSection').classList.contains('hidden')) {
                loadActivityLog();
            }
        }

        async function clearActivityLog() {
            if (confirm('Are you sure you want to clear the entire activity log? This cannot be undone.')) {
                // Clear local storage
                localStorage.setItem('activityLog', JSON.stringify([]));

                // Clear Firebase if connected
                if (isFirebaseConnected) {
                    try {
                        // Note: This is a destructive operation. In production, you might want to archive instead.
                        const activityLogRef = db.collection('activityLog');
                        const querySnapshot = await activityLogRef.get();

                        const batch = db.batch();
                        querySnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        addFirebaseLog('Activity log cleared from Firebase', 'info');
                    } catch (error) {
                        addFirebaseLog(`Error clearing activity log from Firebase: ${error.message}`, 'error');
                    }
                }

                loadActivityLog();
                logActivity(`${currentUser.name} cleared the activity log`, 'system');
                showNotification('Activity log cleared', 'success');
            }
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;

            // Apply settings
            if (settings.darkModeEnabled) {
                toggleDarkMode(true);
            }

            // Update app info
            document.getElementById('appLastUpdated').textContent =
                new Date(settings.appLastUpdated).toLocaleDateString();
        }

        function loadSettingsUI() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || defaultSettings;

            // Populate settings form
            document.getElementById('defaultCC').value = settings.defaultCC || '';
            document.getElementById('defaultMeetingTime').value = settings.defaultMeetingTime || '09:00';
            document.getElementById('backendUrl').value = settings.backendUrl || BACKEND_URL;
            document.getElementById('autoSaveEnabled').checked = settings.autoSaveEnabled !== false;
            document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled !== false;
            document.getElementById('autoGenerateEmailEnabled').checked = settings.autoGenerateEmailEnabled !== false;
            document.getElementById('darkModeEnabled').checked = settings.darkModeEnabled || false;
            document.getElementById('includeOriginalFiles').checked = settings.includeOriginalFiles !== false;

            // Update active users count
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            const activeUsers = users.filter(u => u.lastLogin).length;
            document.getElementById('activeUsersCount').textContent = activeUsers;
        }

        function saveSettings() {
            const settings = {
                defaultCC: document.getElementById('defaultCC').value.trim(),
                defaultMeetingTime: document.getElementById('defaultMeetingTime').value,
                autoSaveEnabled: document.getElementById('autoSaveEnabled').checked,
                notificationsEnabled: document.getElementById('notificationsEnabled').checked,
                autoGenerateEmailEnabled: document.getElementById('autoGenerateEmailEnabled').checked,
                darkModeEnabled: document.getElementById('darkModeEnabled').checked,
                includeOriginalFiles: document.getElementById('includeOriginalFiles').checked,
                backendUrl: document.getElementById('backendUrl').value.trim(),
                appLastUpdated: new Date().toISOString()
            };

            localStorage.setItem('appSettings', JSON.stringify(settings));

            // Log activity
            logActivity(`${currentUser.name} updated application settings`, 'settings');

            showNotification('Settings saved successfully', 'success');
        }

        function resetToDefaults() {
            if (confirm('Reset all settings to default values?')) {
                localStorage.setItem('appSettings', JSON.stringify(defaultSettings));
                loadSettingsUI();
                logActivity(`${currentUser.name} reset settings to defaults`, 'settings');
                showNotification('Settings reset to defaults', 'success');
            }
        }

        function toggleDarkMode(force = null) {
            const darkModeEnabled = force !== null ? force : document.getElementById('darkModeEnabled').checked;

            if (darkModeEnabled) {
                document.body.classList.add('bg-gray-900', 'text-gray-100');
                document.querySelectorAll('.glass-panel').forEach(panel => {
                    panel.classList.add('bg-gray-800', 'text-gray-100');
                    panel.classList.remove('bg-white');
                });
            } else {
                document.body.classList.remove('bg-gray-900', 'text-gray-100');
                document.querySelectorAll('.glass-panel').forEach(panel => {
                    panel.classList.remove('bg-gray-800', 'text-gray-100');
                    panel.classList.add('bg-white');
                });
            }
        }

        function exportAllData() {
            const data = {
                users: JSON.parse(localStorage.getItem('systemUsers')),
                activities: JSON.parse(localStorage.getItem('activityLog')),
                settings: JSON.parse(localStorage.getItem('appSettings')),
                emailData: JSON.parse(localStorage.getItem('emailData')),
                changeovers: JSON.parse(localStorage.getItem('changeovers')),
                exportDate: new Date().toISOString(),
                exportedBy: currentUser ? currentUser.name : 'Unknown'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `changeover_system_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            logActivity(`${currentUser.name} exported all system data`, 'data_export');
            showNotification('All data exported successfully', 'success');
        }

        function importData() {
            showNotification('Import functionality coming soon!', 'info');
        }

        function clearLocalData() {
            if (confirm('Warning: This will clear all locally stored data including users, activities, and settings. This cannot be undone. Proceed?')) {
                localStorage.clear();
                initializeStorage();

                // Logout current user
                logout();

                showNotification('All local data cleared. System reset to defaults.', 'warning');
            }
        }

        function updateSystemInfo() {
            const users = JSON.parse(localStorage.getItem('systemUsers'));
            const activities = JSON.parse(localStorage.getItem('activityLog'));

            document.getElementById('activeUsersCount').textContent = users.filter(u => u.lastLogin).length;
            document.getElementById('systemActivitiesCount').textContent = activities.length;
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleButton = document.querySelector('.password-toggle i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.classList.remove('fa-eye');
                toggleButton.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleButton.classList.remove('fa-eye-slash');
                toggleButton.classList.add('fa-eye');
            }
        }

        // ============================================
        // ORIGINAL APPLICATION FUNCTIONALITY
        // ============================================

        function initializeEventListeners() {
            // File upload handlers
            setupFileUpload('currentFile', 'currentFileDropZone', 'currentFileInfo', 'currentFileName', 'currentFileSize', 'removeCurrentFile');
            setupFileUpload('upcomingFile', 'upcomingFileDropZone', 'upcomingFileInfo', 'upcomingFileName', 'upcomingFileSize', 'removeUpcomingFile');

            // Line selection handler
            // Line selection handler
            document.getElementById('lineSelect').addEventListener('change', function () {
                const value = this.value;
                selectedLine = value;

                const subLineContainer = document.getElementById('subLineContainer');
                const subLineOptions = document.getElementById('subLineOptions');

                // Reset editability
                const supervisorInput = document.getElementById('supervisorName');
                const rqcInput = document.getElementById('rqcName');
                supervisorInput.readOnly = true;
                rqcInput.readOnly = true;

                if (value.includes('+') || value.includes('/')) {
                    // Show sub-selector
                    subLineContainer.classList.remove('hidden');
                    const parts = value.split(/[+/]/);
                    subLineOptions.innerHTML = parts.map(p => `
                        <label class="inline-flex items-center cursor-pointer p-2 rounded hover:bg-white border border-transparent hover:border-blue-200 transition-all">
                            <input type="radio" name="specificLine" value="${p}" class="form-radio h-4 w-4 text-blue-600" onchange="updateSelectedLine(this.value)">
                            <span class="ml-2 font-medium text-gray-700">${p}</span>
                        </label>
                    `).join('');

                    // Enable editing for complex lines
                    supervisorInput.readOnly = false;
                    rqcInput.readOnly = false;
                    supervisorInput.classList.remove('bg-gray-50');
                    supervisorInput.classList.add('bg-white', 'border-blue-300');
                    rqcInput.classList.remove('bg-gray-50');
                    rqcInput.classList.add('bg-white', 'border-blue-300');

                } else {
                    subLineContainer.classList.add('hidden');
                    subLineOptions.innerHTML = '';

                    supervisorInput.classList.add('bg-gray-50');
                    supervisorInput.classList.remove('bg-white', 'border-blue-300');
                    rqcInput.classList.add('bg-gray-50');
                    rqcInput.classList.remove('bg-white', 'border-blue-300');
                }

                updatePersonnelInfo();
                checkGenerateButton();
                updateRecentActivity(`Line ${selectedLine} selected`);
            });

            // Mobile menu handlers
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('closeMobileMenu').addEventListener('click', toggleMobileMenu);

            // Configuration handlers
            document.getElementById('includeMaintenance').addEventListener('change', generateEmail);
            document.getElementById('includeManagement').addEventListener('change', generateEmail);
            document.getElementById('autoGenerateEmail').addEventListener('change', function () {
                if (this.checked && comparisonResults) {
                    generateEmail();
                }
            });

            // Meeting date handler
            document.getElementById('meetingDate').addEventListener('change', generateEmail);

            // Email recipients handlers
            document.getElementById('emailCC').addEventListener('change', generateEmail);
            document.getElementById('emailBCC').addEventListener('change', generateEmail);

            // Auto-detect machines checkbox
            document.getElementById('autoDetectMachines').addEventListener('change', function () {
                showNotification(this.checked ? 'Auto-detection enabled' : 'Auto-detection disabled', 'info');
            });

            // Admin tab handlers
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    switchToAdminTab(tabId);
                });
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (!document.getElementById('filePreviewModal').classList.contains('hidden')) {
                        closeFilePreview();
                    }
                    if (!document.getElementById('smtpModal').classList.contains('hidden')) {
                        closeSmtpModal();
                    }
                    if (!document.getElementById('changeoverModal').classList.contains('hidden')) {
                        closeChangeoverModal();
                    }
                }
            });
        }

        function setupFileUpload(inputId, dropZoneId, infoId, nameId, sizeId, removeId) {
            const input = document.getElementById(inputId);
            const dropZone = document.getElementById(dropZoneId);
            const info = document.getElementById(infoId);
            const name = document.getElementById(nameId);
            const size = document.getElementById(sizeId);
            const remove = document.getElementById(removeId);

            dropZone.addEventListener('click', () => input.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    handleFileSelect(inputId, files[0], infoId, nameId, sizeId);
                }
            });

            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(inputId, e.target.files[0], infoId, nameId, sizeId);
                }
            });

            remove.addEventListener('click', () => {
                removeFile(inputId, dropZoneId, infoId);
            });
        }

        function handleFileSelect(inputId, file, infoId, nameId, sizeId) {
            const info = document.getElementById(infoId);
            const name = document.getElementById(nameId);
            const size = document.getElementById(sizeId);

            info.classList.remove('hidden');
            name.textContent = file.name;
            size.textContent = formatFileSize(file.size);

            // Store the file object for later use
            if (inputId === 'currentFile') {
                currentFile = file;
            } else if (inputId === 'upcomingFile') {
                upcomingFile = file;
            }

            showNotification(`File "${file.name}" uploaded successfully`, 'success');
            updateRecentActivity(`Uploaded: ${file.name}`);
            checkGenerateButton();

            // Log activity
            logActivity(`${currentUser.name} uploaded file: ${file.name}`, 'file_upload');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(inputId, dropZoneId, infoId) {
            document.getElementById(inputId).value = '';
            document.getElementById(infoId).classList.add('hidden');

            // Clear stored file object
            if (inputId === 'currentFile') {
                currentFile = null;
            } else if (inputId === 'upcomingFile') {
                upcomingFile = null;
            }

            checkGenerateButton();
            showNotification('File removed', 'info');
        }

        function checkGenerateButton() {
            const currentFile = document.getElementById('currentFile').files[0];
            const upcomingFile = document.getElementById('upcomingFile').files[0];
            const lineSelected = document.getElementById('lineSelect').value;
            const generateBtn = document.getElementById('generateBtn');

            if (currentFile && upcomingFile && lineSelected) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function processFiles() {
            // Log activity
            logActivity(`${currentUser.name} started processing OB files`, 'analysis');

            // Original implementation
            const currentFile = document.getElementById('currentFile').files[0];
            const upcomingFile = document.getElementById('upcomingFile').files[0];

            if (!currentFile || !upcomingFile) {
                showNotification('Please upload both OB files', 'error');
                return;
            }

            showLoading(true);
            document.getElementById('progressContainer').classList.remove('hidden');
            updateProgress(10, 'Reading files...');

            // Process current file
            processOBFile(currentFile, 'current').then(data => {
                currentOBData = data;
                updateProgress(40, 'Processing current style...');
                return processOBFile(upcomingFile, 'upcoming');
            }).then(async data => {
                upcomingOBData = data;
                updateProgress(70, 'Processing upcoming style...');

                // Generate QCO Number NOW (after styles are known)
                currentQCONumber = await getNextQCONumber(selectedLine, currentOBData.style, upcomingOBData.style);

                renderResults();
                updateProgress(90, 'Generating reports...');

                // Save changeover to Firebase
                const changeoverData = {
                    qcoNumber: currentQCONumber,
                    lineNumber: selectedLine,
                    currentStyle: currentOBData.style,
                    currentSMV: currentOBData.smv,
                    currentTarget: currentOBData.target,
                    upcomingStyle: upcomingOBData.style,
                    upcomingSMV: upcomingOBData.smv,
                    upcomingTarget: upcomingOBData.target,
                    allotedWP: upcomingOBData.allotedWP || 0, // Add manpower from Column J
                    operationsList: upcomingOBData.operations || [], // Save extracted operations
                    machineSummary: comparisonResults ? comparisonResults.map(r => ({
                        machine: r.machine,
                        current: r.current,
                        upcoming: r.upcoming,
                        required: r.required,
                        surplus: r.surplus
                    })) : [],
                    createdBy: currentUser.name,
                    createdAt: new Date().toISOString(),
                    ...(currentEmailData || {}),
                    emailSent: null
                };

                await saveChangeoverToFirebase(changeoverData);

                setTimeout(() => {
                    showLoading(false);
                    document.getElementById('progressContainer').classList.add('hidden');
                    showNotification(`OB files processed successfully! QCO Number: ${currentQCONumber}`, 'success');
                    saveToLocalStorage();
                    updateRecentActivity('Generated changeover plan');

                    // Log activity
                    logActivity(`${currentUser.name} completed analysis for QCO ${currentQCONumber}: ${currentOBData.style} → ${upcomingOBData.style}`, 'analysis');
                }, 500);
            }).catch(error => {
                showLoading(false);
                document.getElementById('progressContainer').classList.add('hidden');
                showNotification('Error processing files: ' + error.message, 'error');
                console.error(error);

                // Log error activity
                logActivity(`${currentUser.name} encountered error processing files: ${error.message}`, 'error');
            });
        }

        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('loadingStatus').textContent = status;
            document.getElementById('loadingProgressBar').style.width = percent + '%';
        }

        function renderResults() {
            if (!currentOBData || !upcomingOBData) return;

            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');
            if (document.getElementById('autoGenerateEmail').checked) {
                document.getElementById('emailSection').classList.remove('hidden');
            }

            // Update QCO Display
            document.getElementById('qcoNumberDisplay').textContent = currentQCONumber;
            document.getElementById('qcoCreatedBy').textContent = currentUser.name;
            document.getElementById('qcoCreatedDate').textContent = new Date().toLocaleDateString();

            // Update style cards
            updateStyleCards();

            // Update change summary
            updateChangeSummary();

            // Generate machine comparison
            generateMachineComparison();

            // Generate email
            generateEmail();

            // Update counters
            updateCounters();

            // Add animation
            document.querySelectorAll('.slide-in').forEach(el => {
                el.classList.add('slide-in');
            });
        }

        function updateStyleCards() {
            // Current style
            document.getElementById('currStyleName').textContent = currentOBData.style || "Unknown";
            document.getElementById('currSMV').textContent = currentOBData.smv ? currentOBData.smv.toFixed(2) : "--";
            document.getElementById('currTarget').textContent = currentOBData.target || "--";
            document.getElementById('currTotalMachines').textContent = currentOBData.machines ?
                Object.values(currentOBData.machines).reduce((a, b) => a + b, 0) : "--";
            document.getElementById('currLastUpdated').textContent = new Date().toLocaleDateString();

            // Upcoming style
            document.getElementById('nextStyleName').textContent = upcomingOBData.style || "Unknown";
            document.getElementById('nextSMV').textContent = upcomingOBData.smv ? upcomingOBData.smv.toFixed(2) : "--";
            document.getElementById('nextTarget').textContent = upcomingOBData.target || "--";
            document.getElementById('nextTotalMachines').textContent = upcomingOBData.machines ?
                Object.values(upcomingOBData.machines).reduce((a, b) => a + b, 0) : "--";
            document.getElementById('nextChangeDate').textContent = new Date().toLocaleDateString();
        }

        function updateSelectedLine(val) {
            selectedLine = val;
            console.log("Specific line selected:", selectedLine);
        }

        function updateChangeSummary() {
            if (!currentOBData.smv || !upcomingOBData.smv) {
                document.getElementById('smvChange').textContent = "--";
                document.getElementById('targetChange').textContent = "--";
                document.getElementById('efficiencyImpact').textContent = "--";
                document.getElementById('machineDelta').textContent = "--";
                return;
            }

            const smvChange = upcomingOBData.smv - currentOBData.smv;
            const targetChange = upcomingOBData.target - currentOBData.target;
            const efficiencyImpact = ((upcomingOBData.smv / currentOBData.smv - 1) * 100).toFixed(1);

            // Calculate machine delta
            const currentMachines = currentOBData.machines ? Object.values(currentOBData.machines).reduce((a, b) => a + b, 0) : 0;
            const upcomingMachines = upcomingOBData.machines ? Object.values(upcomingOBData.machines).reduce((a, b) => a + b, 0) : 0;
            const machineDelta = upcomingMachines - currentMachines;

            document.getElementById('smvChange').textContent = (smvChange >= 0 ? '+' : '') + smvChange.toFixed(2);
            document.getElementById('targetChange').textContent = (targetChange >= 0 ? '+' : '') + targetChange;
            document.getElementById('efficiencyImpact').textContent = (efficiencyImpact >= 0 ? '+' : '') + efficiencyImpact + '%';
            document.getElementById('machineDelta').textContent = (machineDelta >= 0 ? '+' : '') + machineDelta;
        }

        function generateMachineComparison() {
            if (!currentOBData.machines || !upcomingOBData.machines) {
                console.error("Machine data not available for one or both styles");
                return;
            }

            const allMachines = new Set([...Object.keys(currentOBData.machines), ...Object.keys(upcomingOBData.machines)]);
            const results = [];

            allMachines.forEach(machine => {
                const currentQty = currentOBData.machines[machine] || 0;
                const upcomingQty = upcomingOBData.machines[machine] || 0;
                const delta = upcomingQty - currentQty;

                results.push({
                    machine,
                    current: currentQty,
                    upcoming: upcomingQty,
                    delta: delta,
                    required: delta > 0 ? delta : 0,
                    surplus: delta < 0 ? Math.abs(delta) : 0,
                    status: delta > 0 ? 'needed' : delta < 0 ? 'surplus' : 'same',
                    priority: delta > 5 ? 'high' : delta > 0 ? 'medium' : 'low',
                    remarks: '' // Initialize remarks field
                });
            });

            // Sort by required descending, then by absolute delta
            results.sort((a, b) => {
                if (b.required !== a.required) return b.required - a.required;
                return Math.abs(b.delta) - Math.abs(a.delta);
            });

            comparisonResults = results;

            // Update table
            updateMachineTable(results);

            // Update cards
            updateMachineCards(results);

            // Update delta summary
            const totalDelta = results.reduce((sum, r) => sum + r.required, 0);
            document.getElementById('totalDelta').textContent = totalDelta;
        }

        function updateMachineTable(results) {
            const tbody = document.getElementById('machineTableBody');
            tbody.innerHTML = '';

            if (!results || results.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p class="text-sm">No machine data available</p>
                </td>`;
                tbody.appendChild(row);
                return;
            }

            results.forEach((result, index) => {
                if (result.current === 0 && result.upcoming === 0) return;

                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50 transition-colors';

                const statusBadge = {
                    'needed': '<span class="machine-diff-add">Required</span>',
                    'surplus': '<span class="machine-diff-remove">Surplus</span>',
                    'same': '<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-medium">No Change</span>'
                };

                const priorityBadge = {
                    'high': '<span class="badge badge-danger">High</span>',
                    'medium': '<span class="badge badge-warning">Medium</span>',
                    'low': '<span class="badge badge-success">Low</span>'
                };

                const deltaClass = result.delta > 0 ? 'text-red-600 font-bold' : result.delta < 0 ? 'text-green-600 font-bold' : 'text-gray-600';
                const deltaText = result.delta !== 0 ? (result.delta > 0 ? '+' : '') + result.delta : '0';

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">
                        <div class="flex items-center">
                            <i class="fas fa-cog text-gray-400 mr-2"></i>
                            ${result.machine}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center font-mono">${result.current}</td>
                    <td class="px-6 py-4 text-center font-mono">${result.upcoming}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="${deltaClass} font-bold">${deltaText}</span>
                    </td>
                    <td class="px-6 py-4 text-center">${statusBadge[result.status]}</td>
                    <td class="px-6 py-4 text-center">${priorityBadge[result.priority]}</td>
                    <td class="px-6 py-4">
                        <input type="text" 
                               data-index="${index}"
                               class="remarks-input" 
                               placeholder="Add remarks..." 
                               value="${result.remarks || ''}"
                               onchange="updateRemarks(this)">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRemarks(input) {
            const index = input.dataset.index;
            if (comparisonResults && comparisonResults[index]) {
                comparisonResults[index].remarks = input.value;
                if (document.getElementById('autoGenerateEmail').checked) {
                    generateEmail();
                }
            }
        }

        function toggleRemarks() {
            const inputs = document.querySelectorAll('.remarks-input');
            inputs.forEach(input => {
                input.classList.toggle('hidden');
            });
        }

        function selectTemplate(template) {
            emailTemplate = template;
            document.querySelectorAll('.email-template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Update email based on template
            if (comparisonResults) {
                generateEmail();
            }

            showNotification(`Template changed to ${template}`, 'info');
        }

        function toggleEmailPreviewMode(mode) {
            previewMode = mode;
            const htmlPreview = document.getElementById('htmlEmailPreview');
            const textEditor = document.getElementById('textEmailEditor');

            if (mode === 'html') {
                htmlPreview.classList.remove('hidden');
                textEditor.classList.add('hidden');
            } else {
                htmlPreview.classList.add('hidden');
                textEditor.classList.remove('hidden');
            }
        }

        function copyEmail() {
            const content = previewMode === 'html'
                ? document.getElementById('plainTextEmail').value
                : document.getElementById('plainTextEmail').value;

            navigator.clipboard.writeText(content).then(() => {
                showNotification('Email copied to clipboard!', 'success');
                logActivity(`${currentUser.name} copied changeover email to clipboard`, 'email');
            }).catch(err => {
                showNotification('Failed to copy email: ' + err.message, 'error');
            });
        }

        function sendEmailOutlook() {
            const subject = document.getElementById('previewSubject').textContent;
            const recipients = generateEmailRecipients();
            const cc = document.getElementById('emailCC').value;
            const bcc = document.getElementById('emailBCC').value;
            const body = encodeURIComponent(document.getElementById('plainTextEmail').value);

            let mailtoLink = `mailto:${recipients.join(',')}?subject=${encodeURIComponent(subject)}&body=${body}`;

            if (cc) {
                mailtoLink += `&cc=${cc}`;
            }
            if (bcc) {
                mailtoLink += `&bcc=${bcc}`;
            }

            window.location.href = mailtoLink;
            showNotification('Opening email in Outlook...', 'success');
            logActivity(`${currentUser.name} initiated email send via Outlook`, 'email');
        }

        function downloadEmail() {
            const subject = document.getElementById('previewSubject').textContent;
            const content = document.getElementById('plainTextEmail').value;

            const fullContent = `Subject: ${subject}\n\n${content}`;
            const blob = new Blob([fullContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Changeover_Email_${currentQCONumber || 'QCO'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Email downloaded successfully!', 'success');
            logActivity(`${currentUser.name} downloaded changeover email`, 'email');
        }

        function printEmail() {
            const printContent = document.getElementById('emailPreviewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Changeover Email - ${currentQCONumber || 'QCO'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 30px; }
                        .footer { border-top: 1px solid #ddd; padding-top: 20px; margin-top: 30px; font-size: 0.8em; color: #666; }
                        .qco-highlight { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 20px; display: inline-block; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="qco-highlight">Reference: ${currentQCONumber || 'N/A'}</div>
                        <h2>${document.getElementById('previewSubject').textContent}</h2>
                        <p><strong>To:</strong> ${document.getElementById('previewRecipients').textContent}</p>
                        <p><strong>From:</strong> planning@sidneyapparel.com</p>
                    </div>
                    ${printContent}
                    <div class="footer">
                        <p>Generated by Changeover Meeting Initiator System on ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            logActivity(`${currentUser.name} printed changeover email`, 'email');
        }

        function exportResults() {
            if (!comparisonResults) return;

            const csvContent = [
                ['QCO Number', 'Machine Type', 'Current', 'Upcoming', 'Delta', 'Required', 'Surplus', 'Status', 'Priority', 'Remarks'],
                ...comparisonResults.map(r => [
                    currentQCONumber || 'N/A',
                    r.machine,
                    r.current,
                    r.upcoming,
                    r.delta,
                    r.required,
                    r.surplus,
                    r.status,
                    r.priority,
                    r.remarks || ''
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Machine_Requirements_${currentQCONumber || 'QCO'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Results exported successfully!', 'success');
            updateRecentActivity('Exported machine analysis');
            logActivity(`${currentUser.name} exported machine analysis results`, 'export');
        }

        function updateCounters() {
            document.getElementById('totalComparisons').textContent =
                parseInt(document.getElementById('totalComparisons').textContent) + 1;

            const totalMachines = (currentOBData.machines ? Object.keys(currentOBData.machines).length : 0) +
                (upcomingOBData.machines ? Object.keys(upcomingOBData.machines).length : 0);
            document.getElementById('totalMachines').textContent = totalMachines;
        }

        function updateRecentActivity(activity) {
            const recentActivityDiv = document.getElementById('recentActivity');
            recentActivityDiv.classList.remove('hidden');

            const timeline = recentActivityDiv.querySelector('.timeline');
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const activityItem = document.createElement('div');
            activityItem.className = 'timeline-item';
            activityItem.innerHTML = `
                <div class="text-sm font-medium">${activity}</div>
                <div class="text-xs text-gray-500">${timeString}</div>
            `;

            timeline.insertBefore(activityItem, timeline.firstChild);

            // Keep only last 5 activities
            const items = timeline.querySelectorAll('.timeline-item');
            if (items.length > 5) {
                items[items.length - 1].remove();
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.toggle('hidden', !show);
        }

        function showNotification(message, type) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg slide-in`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${icons[type]} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('active');
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function setDefaultMeetingDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const formattedDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('meetingDate').value = formattedDate;
        }

        function saveToLocalStorage() {
            const data = {
                currentOBData: {
                    style: currentOBData.style,
                    smv: currentOBData.smv,
                    target: currentOBData.target,
                    machines: currentOBData.machines
                },
                upcomingOBData: {
                    style: upcomingOBData.style,
                    smv: upcomingOBData.smv,
                    target: upcomingOBData.target,
                    machines: upcomingOBData.machines
                },
                comparisonResults,
                selectedLine,
                qcoNumber: currentQCONumber,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('changeoverData', JSON.stringify(data));
        }

        function updateMachineCards(results) {
            const container = document.getElementById('machineCards');
            container.innerHTML = '';

            if (!results) return;

            // Filter to only show machines that have changes
            const criticalMachines = results.filter(r => r.delta !== 0).slice(0, 6);

            if (criticalMachines.length === 0) {
                const noChanges = document.createElement('div');
                noChanges.className = 'col-span-full bg-green-50 p-6 rounded-lg text-center border border-green-200 slide-in';
                noChanges.innerHTML = `
                    <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                    <h3 class="font-bold text-lg mb-1">No Machine Changes Required</h3>
                    <p class="text-gray-600">The machine configuration is identical between styles.</p>
                `;
                container.appendChild(noChanges);
                return;
            }

            criticalMachines.forEach(result => {
                const card = document.createElement('div');
                card.className = 'machine-card glass-panel p-4 slide-in';

                const statusClass = result.delta > 0 ? 'border-l-4 border-red-500' : 'border-l-4 border-green-500';
                const statusText = result.delta > 0 ? `+${result.delta} machines needed` : `${Math.abs(result.delta)} machines surplus`;
                const statusColor = result.delta > 0 ? 'text-red-600' : 'text-green-600';
                const icon = result.delta > 0 ? 'fa-plus-circle' : 'fa-minus-circle';

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="font-bold text-gray-800">${result.machine}</h4>
                        <span class="${statusColor} font-bold text-lg">${result.delta > 0 ? '+' : ''}${result.delta}</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Current:</span>
                            <span class="font-medium">${result.current}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">New Requirement:</span>
                            <span class="font-medium">${result.upcoming}</span>
                        </div>
                        ${result.remarks ? `
                        <div class="text-xs text-gray-600 bg-gray-100 p-2 rounded border">
                            <strong>Remarks:</strong> ${result.remarks}
                        </div>
                        ` : ''}
                        <div class="flex items-center text-sm ${statusColor} font-medium">
                            <i class="fas ${icon} mr-2"></i>
                            ${statusText}
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${result.delta > 0 ? 'bg-red-500' : 'bg-green-500'} h-2 rounded-full" 
                                 style="width: ${Math.min(Math.abs(result.delta) / Math.max(result.current, result.upcoming, 1) * 100, 100)}%"></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Keep existing personnel data and OB processing functions
        const personnelData = {
            "1": { supervisor: "WASANA", rqc: "SANGIB", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "MONIR/RAJESH", mechIncharge: "MOTHIN", technical: "SAMINATHAN" },
            "1A": { supervisor: "WASANA", rqc: "MIYARAJ", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "ANIL/SUJAN", mechIncharge: "MOTHIN", technical: "SAMINATHAN" },
            "2": { supervisor: "SOHORAB", rqc: "SHERAJ", ie: "BUDDIKA", lineIncharge: "VARMA", qam: "JANAKA", mechIncharge: "MOTHIN", technical: "KOUSAR" },
            "3": { supervisor: "SOHEL", rqc: "RIPON", ie: "SANAKA", lineIncharge: "TARAJUL", qam: "", mechIncharge: "SAKIB", technical: "SAMINATHAN" },
            "6+17": { supervisor: "SHAKIL/MUSUM", rqc: "NURADAM/KHOKUN", ie: "SANAKA", lineIncharge: "TARAJUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "ROHANA/SHAFIK" },
            "7": { supervisor: "NAGENDER", rqc: "SHAMIM", ie: "BUDDIKA", lineIncharge: "VARMA", qam: "ANIL/SUJAN", mechIncharge: "MOTHIN", technical: "KOUSAR" },
            "7A": { supervisor: "KAMAL", rqc: "LABO", ie: "BUDDIKA", lineIncharge: "VARMA", qam: "MONIR/RAJESH", mechIncharge: "MOTHIN", technical: "KOUSAR" },
            "8+5": { supervisor: "BALISTER/FARUK", rqc: "SABOZ/NAIME", ie: "SANAKA", lineIncharge: "SAKIR", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "SAMINATHAN" },
            "9": { supervisor: "SUMI", rqc: "HELAL", ie: "SANAKA", lineIncharge: "FARIDUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "RASHID" },
            "10": { supervisor: "RAJ KUMAR", rqc: "RAM KUMAR", ie: "THANVIR", lineIncharge: "SADDAM", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "11+15": { supervisor: "KAMAL/MUNSAF", rqc: "ANWER/ARIFUL", ie: "SANAKA", lineIncharge: "TARAJUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "SAMINATHAN" },
            "12": { supervisor: "DHARAMEDER", rqc: "JAHEDUL", ie: "BUDDIKA", lineIncharge: "VARMA", qam: "MONIR/RAJESH", mechIncharge: "MOTHIN", technical: "RASHID" },
            "13/21": { supervisor: "SUMON/DEVRAJ", rqc: "ABU KASAM/ABHAY", ie: "THANVIR", lineIncharge: "SADDAM", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "14": { supervisor: "SHARIF", rqc: "GUDDU", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "ANIL/SUJAN", mechIncharge: "SAKIB", technical: "KOUSAR" },
            "16": { supervisor: "RAHMAN", rqc: "JAHURUL", ie: "THANVIR", lineIncharge: "SADDAM", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "16A": { supervisor: "RHANIA", rqc: "VIJAY", ie: "THANVIR", lineIncharge: "SADDAM", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "18": { supervisor: "JAKIR", rqc: "RASHMI", ie: "THANVIR", lineIncharge: "SADDAM", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "19": { supervisor: "ALAMGIR", rqc: "ASLAM", ie: "SANAKA", lineIncharge: "TARAJUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "ROHANA/SHAFIK" },
            "20": { supervisor: "GAYANI", rqc: "TUHIN", ie: "SANAKA", lineIncharge: "FARIDUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "ROHANA/SHAFIK" },
            "22": { supervisor: "ASHRAFUL", rqc: "FOKRUL", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "MONIR/RAJESH", mechIncharge: "MOTHIN", technical: "KOUSAR" },
            "23": { supervisor: "RUMA", rqc: "SAMANMALI", ie: "THANVIR", lineIncharge: "FARIDUL", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "24": { supervisor: "NASIR", rqc: "SOBUJ", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "ROHANA/SHAFIK" },
            "25": { supervisor: "AKBAR", rqc: "SAKIB", ie: "SANAKA", lineIncharge: "SAKIR", qam: "MONIR/RAJESH", mechIncharge: "MOTHIN", technical: "RASHID" },
            "26/4": { supervisor: "HIMAYIT/AHMAD", rqc: "BELAYET/ASHISH", ie: "THANVIR", lineIncharge: "VARMA", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" },
            "28": { supervisor: "RUPNANAYAN", rqc: "NASRUL", ie: "SANAKA", lineIncharge: "SAKIR", qam: "ANIL/SUJAN", mechIncharge: "MOTHIN", technical: "RASHID" },
            "29": { supervisor: "SUBA", rqc: "FATEMA", ie: "SANAKA", lineIncharge: "FARIDUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "RASHID" },
            "30": { supervisor: "RAZIB", rqc: "ZAHIDUL", ie: "BUDDIKA", lineIncharge: "MOHAMAD", qam: "ANIL/SUJAN", mechIncharge: "MOTHIN", technical: "KOUSAR" },
            "31": { supervisor: "AKESH", rqc: "MONJURY", ie: "SANAKA", lineIncharge: "FARIDUL", qam: "MONIR/RAJESH", mechIncharge: "SAKIB", technical: "ROHANA/SHAFIK" },
            "32": { supervisor: "KALU", rqc: "MUSTAK", ie: "THANVIR", lineIncharge: "FARIDUL", qam: "JANAKA/RAKESH", mechIncharge: "NASIR", technical: "TUHIN" }
        };

        function updatePersonnelInfo() {
            const line = document.getElementById('lineSelect').value;
            const personnelInfo = document.getElementById('personnelInfo');
            const personnelDetails = document.getElementById('personnelDetails');

            if (line && personnelData[line]) {
                const data = personnelData[line];
                // Update personnel fields
                document.getElementById('supervisorName').value = data.supervisor;
                document.getElementById('rqcName').value = data.rqc;
                document.getElementById('ieName').value = data.ie;
                document.getElementById('lineIncharge').value = data.lineIncharge;
                document.getElementById('qamName').value = data.qam;
                document.getElementById('mechIncharge').value = data.mechIncharge;
                document.getElementById('technicalName').value = data.technical;

                // Show personnel info
                personnelInfo.classList.remove('hidden');
                personnelDetails.innerHTML = `
                    <p><strong>Line:</strong> ${line}</p>
                    <p><strong>Supervisor:</strong> ${data.supervisor}</p>
                    <p><strong>Total Personnel:</strong> 7 members</p>
                `;
            } else {
                personnelInfo.classList.add('hidden');
                // Clear fields
                ['supervisorName', 'rqcName', 'ieName', 'lineIncharge', 'qamName', 'mechIncharge', 'technicalName'].forEach(id => {
                    document.getElementById(id).value = '';
                });
            }
        }

        // OB processing functions
        function processOBFile(file, type) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        let data;
                        const fileName = file.name.toLowerCase();
                        if (fileName.endsWith('.csv')) {
                            data = processCSV(e.target.result);
                        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            data = processExcel(e.target.result, type);
                        } else {
                            reject(new Error('Unsupported file format'));
                            return;
                        }
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));

                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function processCSV(content) {
            const lines = content.split('\n');
            const data = {
                style: "Unknown",
                smv: 0,
                target: 0,
                machines: {},
                rawData: lines
            };

            // Extract metadata
            for (let i = 0; i < Math.min(lines.length, 30); i++) {
                const line = lines[i].toUpperCase();
                if (line.includes('STYLE') && !data.style) {
                    const match = lines[i].match(/STYLE[\s#]*[:]*[\s]*([A-Z0-9-]+)/i);
                    if (match) data.style = match[1];
                }
                if (line.includes('SMV') && !data.smv) {
                    const match = lines[i].match(/SMV[\s]*[:]*[\s]*([0-9.]+)/i);
                    if (match) data.smv = parseFloat(match[1]);
                }
                if (line.includes('TARGET') && !data.target) {
                    const match = lines[i].match(/TARGET[\s]*[:]*[\s]*([0-9]+)/i);
                    if (match) data.target = parseInt(match[1]);
                }
            }

            // Extract machines
            data.machines = extractMachinesFromCSV(lines);
            return data;
        }

        function processExcel(arrayBuffer, fileType) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            let sheetName;

            if (fileType === 'current') {
                sheetName = workbook.SheetNames.find(name =>
                    name.toUpperCase().includes('ORIGINAL') ||
                    name.toUpperCase().includes('OB') ||
                    name.toUpperCase().includes('MAIN')
                ) || workbook.SheetNames[0];
            } else {
                sheetName = workbook.SheetNames.find(name =>
                    name.toUpperCase().includes('RE WORK') ||
                    name.toUpperCase().includes('REWORK') ||
                    name.toUpperCase().includes('OB') ||
                    name.toUpperCase().includes('MAIN')
                ) || workbook.SheetNames[0];
            }

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

            const data = {
                style: "Unknown",
                smv: 0,
                target: 0,
                machines: {},
                rawData: jsonData
            };

            // Extract style and metadata
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];

                if (row.length > 2 && (row[1] === "STYLE #" || row[1] === "STYLE NO" || row[2] === "STYLE NO")) {
                    if (jsonData[i + 1] && jsonData[i + 1].length > 2) {
                        data.style = jsonData[i + 1][2].toString().trim();
                    }
                }

                if (row.length > 0 && typeof row[0] === 'string' && row[0].includes("SMV")) {
                    const smvMatch = row[0].match(/SMV\s*-\s*([0-9.]+)/);
                    if (smvMatch) data.smv = parseFloat(smvMatch[1]);
                }

                if (row.length > 1 && (row[0] === "TTL SMV" || row[1] === "TTL SMV")) {
                    for (let j = 2; j < row.length; j++) {
                        if (typeof row[j] === 'number') {
                            data.smv = row[j];
                            break;
                        } else if (typeof row[j] === 'string' && !isNaN(parseFloat(row[j]))) {
                            data.smv = parseFloat(row[j]);
                            break;
                        }
                    }
                }

                if (row.length > 1 && (row[1] === "TARGET:" || row[1] === "TARGET")) {
                    for (let j = 2; j < row.length; j++) {
                        if (typeof row[j] === 'number') {
                            data.target = row[j];
                            break;
                        } else if (typeof row[j] === 'string' && !isNaN(parseInt(row[j]))) {
                            data.target = parseInt(row[j]);
                            break;
                        }
                    }
                }
            }

            // Extract machines and operations
            const extractionResult = extractMachinesFromExcelWithEOLOnly(jsonData);
            data.machines = extractionResult.machines;
            data.operations = extractionResult.operations || [];
            data.allotedWP = extractionResult.allotedWP || 0;

            // Fallback extraction
            if (data.style === "Unknown" || data.smv === 0 || data.target === 0) {
                const fullText = jsonData.map(row => row.join(' ')).join('\n').toUpperCase();

                const styleMatch = fullText.match(/STYLE\s*[\s#]*[:]*\s*([A-Z0-9-]+)/i);
                if (styleMatch) data.style = styleMatch[1];

                if (data.smv === 0) {
                    const smvMatch = fullText.match(/SMV\s*[:=]?\s*([0-9.]+)/i);
                    if (smvMatch) data.smv = parseFloat(smvMatch[1]);
                }

                if (data.target === 0) {
                    const targetMatch = fullText.match(/TARGET\s*[:=]?\s*([0-9]+)/i);
                    if (targetMatch) data.target = parseInt(targetMatch[1]);
                }
            }

            return data;
        }

        function extractMachinesFromExcelWithEOLOnly(data) {
            const machines = {};
            const operations = []; // List to store extracted operations
            let allotedWP = 0; // Initialize manpower sum
            let operationStartRow = -1;

            for (let i = 0; i < Math.min(data.length, 100); i++) {
                const row = data[i].map(cell => String(cell).trim().toUpperCase());
                if (row.some(cell => cell.includes("OPERATION")) &&
                    row.some(cell => cell.includes("SL") || cell.includes("S.NO"))) {
                    operationStartRow = i + 1;
                    break;
                }
            }

            if (operationStartRow === -1) {
                for (let i = 0; i < Math.min(data.length, 100); i++) {
                    const row = data[i].map(cell => String(cell).trim().toUpperCase());
                    if (row.some(cell => cell.includes("MACHINE"))) {
                        operationStartRow = i + 1;
                        break;
                    }
                }
            }

            if (operationStartRow === -1) {
                operationStartRow = 10;
            }

            const machineCol = 6;
            const qtyCol = 9;
            let foundEndMarker = false;

            for (let i = operationStartRow; i < data.length && !foundEndMarker; i++) {
                const row = data[i];

                if (!row || row.length <= machineCol) continue;

                const machineCell = row[machineCol];
                const qtyCell = row[qtyCol];

                // --- Operations Extraction Logic with SMV ---
                const colA = row[0] ? String(row[0]).trim() : "";
                const colB = row[1] ? String(row[1]).trim() : "";
                const colC = row[2] ? String(row[2]).trim() : "";

                // Check if Column A has numeric content (is a serial number)
                const isSerialNumber = /^\d+$/.test(colA) || (colA.length > 0 && !isNaN(parseFloat(colA)));

                // Extract SMV from Column C
                const smvValue = colC.length > 0 && !isNaN(parseFloat(colC)) ? parseFloat(colC) : null;

                // User Rule: All 3 columns (A, B, C) must be populated
                // A must be numeric, B must have operation name, C must have SMV value
                if (isSerialNumber && colB.length > 0 && smvValue !== null) {
                    // Extract Column G (Machine Type), J (Allocated WP), K (Allocated Direct)
                    const colG = row[6] ? String(row[6]).trim() : "MANUAL";
                    const colJ = row[9] ? parseFloat(row[9]) : 0;
                    const colK_raw = row[10] ? parseFloat(row[10]) : 0;
                    // Round Column K to nearest 0.5
                    const colK = Math.round(colK_raw * 2) / 2;

                    operations.push({
                        serialNumber: colA,
                        name: colB,
                        smv: smvValue,
                        machineType: colG || "MANUAL",
                        allocatedWP: isNaN(colJ) ? 0 : colJ,
                        allocatedDirect: isNaN(colK) ? 0 : colK
                    });


                    // --- Manpower Calculation (Column J) ---
                    // Summing Allocated WP from Column J (index 9) for valid operations
                    if (qtyCell) {
                        const wpVal = parseFloat(qtyCell);
                        if (!isNaN(wpVal)) {
                            allotedWP += wpVal;
                        } else if (String(qtyCell).trim() !== "") {
                            // Try extracting number if it's a string like "1.0" or " 1 "
                            const wpMatch = String(qtyCell).match(/(\d+(\.\d+)?)/);
                            if (wpMatch) {
                                allotedWP += parseFloat(wpMatch[1]);
                            }
                        }
                    }
                }
                // -----------------------------------

                if (machineCell) {
                    const machineValue = String(machineCell).trim().toUpperCase();

                    if (machineValue.includes("EOL-TB") || machineValue.includes("END OF LINE") || machineValue.includes("END OF LINE-TB")) {
                        foundEndMarker = true;
                        break;
                    }

                    if (machineValue === "" ||
                        machineValue.includes("M/C") ||
                        machineValue.includes("MACHINE") ||
                        machineValue.includes("REQ QTY") ||
                        machineValue.includes("---") ||
                        machineValue.includes("TOTAL") ||
                        machineValue.includes("SUMMARY") ||
                        machineValue.includes("REMARKS") ||
                        machineValue.includes("WORK AIDS") ||
                        machineValue.includes("FOLDER") ||
                        machineValue.includes("TABLE") ||
                        machineValue.includes("TYPE")) {
                        continue;
                    }

                    if (row[1] && String(row[1]).trim().toUpperCase() === machineValue) {
                        continue;
                    }

                    const machineType = machineValue;

                    if (machineType !== "" && machineType.length >= 2 &&
                        !machineType.includes("*") && !machineType.includes("/")) {

                        let quantity = 0;

                        if (qtyCell && !isNaN(parseFloat(qtyCell))) {
                            quantity = Math.round(parseFloat(qtyCell));
                        } else if (qtyCell && String(qtyCell).trim() !== "") {
                            const qtyMatch = String(qtyCell).match(/(\d+(\.\d+)?)/);
                            if (qtyMatch) {
                                quantity = Math.round(parseFloat(qtyMatch[1]));
                            }
                        }

                        if (quantity === 0) {
                            quantity = 1;
                        }

                        if (quantity > 0) {
                            machines[machineType] = (machines[machineType] || 0) + quantity;
                        }
                    }
                }
            }

            console.log("Found machines until EOL-TB:", machines);
            console.log("Calculated Alloted WP (Manpower):", allotedWP);
            return { machines, operations, allotedWP: Math.round(allotedWP * 100) / 100 }; // Return rounded value
        }

        function extractMachinesFromCSV(lines) {
            const machines = {};
            let inMachineSection = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toUpperCase();

                if (line.includes('OPERATION') && line.includes('MACHINE')) {
                    inMachineSection = true;
                    continue;
                }

                if (inMachineSection) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 3) {
                        const machine = parts.find(part =>
                            part.trim() &&
                            !part.toUpperCase().includes('OPERATION') &&
                            !part.toUpperCase().includes('TOTAL') &&
                            part.length > 2
                        );

                        if (machine) {
                            const machineName = machine.trim().toUpperCase();
                            if (machineName && machineName !== 'SNLS' && machineName !== 'OL4T') {
                                machines[machineName] = (machines[machineName] || 0) + 1;
                            }
                        }
                    }
                }

                if (line.includes('TOTAL') || line.includes('SUMMARY') || line.includes('EOL-TB')) {
                    inMachineSection = false;
                }
            }

            return machines;
        }

        function checkAuth() {
            const userStr = localStorage.getItem('qcoCurrentUser');
            if (userStr) {
                const user = JSON.parse(userStr);

                // Update Initials in Header
                const initialsEl = document.querySelector('.w-10.h-10.rounded-full.bg-gradient-to-br');
                if (initialsEl) {
                    const initials = (user.name || 'User').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    initialsEl.textContent = initials;
                }
            }
        }

        // ============================================
        // LINE SCHEDULES SEEDING
        // ============================================

        const RAW_LINE_SCHEDULES = {
            "S-01": { supervisor: "WASANA-1", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:45", end: "17:00" }] },
            "S-01A": { supervisor: "WASANA-2", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:50", end: "17:05" }] },
            "S-02": { supervisor: "SOHRAB", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-03": { supervisor: "SOHEL", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-04": { supervisor: "AHMAD", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-05": { supervisor: "OMAR FARUK", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-06": { supervisor: "SHAKIL", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-07": { supervisor: "NAGENDRA", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:50", end: "17:05" }] },
            "S-07A": { supervisor: "KAMAL-2", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-08": { supervisor: "BALISTER", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-09": { supervisor: "SUMI", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-10": { supervisor: "RAJKUMAR", breaks: [{ start: "09:45", end: "10:00" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-11": { supervisor: "KAMAL-1", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-12": { supervisor: "DARMENDRA", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-13": { supervisor: "SUMON", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-14": { supervisor: "SHARIF", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-15": { supervisor: "MUNSEF", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:45", end: "17:00" }] },
            "S-16": { supervisor: "RAHAMAN", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-17": { supervisor: "MASUM", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-18": { supervisor: "JAKIR", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-19": { supervisor: "ALAMGIR", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-20": { supervisor: "GAYANI", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-21": { supervisor: "DEVRAJ", breaks: [{ start: "09:45", end: "10:00" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-22": { supervisor: "ASHRAFUL", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-23": { supervisor: "RUMA", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-24": { supervisor: "NASIR", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-25": { supervisor: "AKBAR", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-26": { supervisor: "HIMAYAT", breaks: [{ start: "09:45", end: "10:00" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-28": { supervisor: "ROOP NARAYAN", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-29": { supervisor: "SUBA", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-30": { supervisor: "RAJIB", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-31": { supervisor: "AKASH", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-32": { supervisor: "KALU CHARAN", breaks: [{ start: "09:45", end: "10:00" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] }
        };

        async function seedLineSchedules() {
            try {
                // Check if already seeded
                const check = await db.collection('line_schedules').doc('S-01').get();
                if (check.exists) {
                    console.log('Line schedules already exist. Skipping seed.');
                    return;
                }

                console.log('Seeding line schedules...');
                const batch = db.batch();

                Object.keys(RAW_LINE_SCHEDULES).forEach(lineId => {
                    const ref = db.collection('line_schedules').doc(lineId);
                    batch.set(ref, RAW_LINE_SCHEDULES[lineId]);
                });

                await batch.commit();
                console.log('Line schedules seeded successfully!');
                showNotification('Line schedules database initialized', 'success');

            } catch (error) {
                console.error("Error seeding schedules:", error);
            }
        }

        // Initialize Select2 for additional recipients
        $(document).ready(function () {
            checkAuth();

            // Seed DB if needed
            if (window.location.protocol.indexOf('http') !== -1) {
                setTimeout(seedLineSchedules, 3000);
            }

            $('#additionalRecipients').select2({
                placeholder: 'Select additional recipients',
                allowClear: true,
                width: '100%'
            });
        });
    </script>
</body>

</html>