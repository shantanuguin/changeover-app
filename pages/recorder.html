<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Activity Recorder | Smart QCO System</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lenis@1.1.2/dist/lenis.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], heading: ['Poppins', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f9ff', 500: '#0ea5e9', 900: '#0c4a6e' } },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* --- PERFORMANCE OPTIMIZATION --- */
        #appContent {
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        body.is-scrolling .glass,
        body.is-scrolling .glass-card {
            backdrop-filter: none;
            transition: backdrop-filter 0.3s ease;
            pointer-events: none;
        }

        @media (max-width: 768px) {

            .glass,
            .glass-card {
                backdrop-filter: none !important;
                background: rgba(255, 255, 255, 0.95) !important;
            }

            .animate-blob {
                animation: none !important;
                opacity: 0.05 !important;
            }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 2rem;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.05);
            /* GPU Performance Fixes */
            transform-style: preserve-3d;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .cursor-dot {
            width: 8px;
            height: 8px;
            background-color: #0ea5e9;
            position: fixed;
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
        }

        .cursor-outline {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(14, 165, 233, 0.3);
            position: fixed;
            border-radius: 50%;
            z-index: 9998;
            pointer-events: none;
            transition: 0.2s;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.8);
            color: #0ea5e9;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        input,
        select,
        textarea {
            background: rgba(255, 255, 255, 0.5);
        }

        input:focus,
        select:focus,
        textarea:focus {
            background: #fff;
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            #mainApp {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }

        /* Section headers - Premium Divider Style */
        .section-header {
            display: flex;
            align-items: center;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding: 0 1rem;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #475569;
            /* Slate 600 */
            position: relative;
        }

        .section-header::before {
            content: '';
            width: 4px;
            height: 4px;
            background: #0ea5e9;
            border-radius: 50%;
            margin-right: 0.75rem;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }

        .section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, rgba(226, 232, 240, 0.8), transparent);
            margin-left: 1rem;
        }

        /* --- Navigation & Backdrop --- */
        .nav-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .retractable-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            max-width: 85vw;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            will-change: transform;
        }

        .retractable-sidebar.open {
            transform: translateX(0);
        }

        /* Premium Glassmorphism & Shadows */
        .glass {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.9),
                    rgba(240, 249, 255, 0.9));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow:
                0 40px 100px -12px rgba(0, 0, 0, 0.08),
                0 20px 50px -12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 1.5rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow:
                0 40px 100px -12px rgba(0, 0, 0, 0.08),
                0 20px 50px -12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(14, 165, 233, 0.2);
            box-shadow:
                0 40px 100px -12px rgba(14, 165, 233, 0.15),
                0 20px 50px -12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }


        /* Hamburger Menu Button - Squircle Glassmorphism */
        #appHeader .hamburger-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.375rem;
            /* 6px */
            width: 3rem;
            /* 48px */
            height: 3rem;
            /* 48px */
            padding: 0.875rem;
            /* 14px */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 249, 255, 0.9));
            border-radius: 1rem;
            /* 16px */
            border: 0.09375rem solid rgba(255, 255, 255, 1);
            box-shadow:
                0 0.5rem 1.5rem -0.25rem rgba(14, 165, 233, 0.25),
                0 0.25rem 0.5rem -0.125rem rgba(14, 165, 233, 0.15),
                inset 0 0.0625rem 0 rgba(255, 255, 255, 1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Snappy */
            cursor: pointer;
            overflow: hidden;
        }

        .hamburger-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(6, 182, 212, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hamburger-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow:
                0 12px 40px -8px rgba(14, 165, 233, 0.25),
                0 6px 20px -4px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 1);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .hamburger-btn:hover::before {
            opacity: 1;
        }

        .hamburger-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .hamburger-line {
            width: 100%;
            height: 0.15625rem;
            /* 2.5px */
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
            border-radius: 0.125rem;
            /* 2px */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            box-shadow: 0 0.0625rem 0.125rem rgba(14, 165, 233, 0.3);
        }

        .hamburger-btn.open {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(6, 182, 212, 0.1));
            border-color: rgba(14, 165, 233, 0.4);
        }

        .hamburger-btn.open .hamburger-line:nth-child(1) {
            transform: translateY(0.25rem) rotate(45deg);
            /* 4px */
            background: linear-gradient(90deg, #0284c7, #0891b2);
        }

        .hamburger-btn.open .hamburger-line:nth-child(2) {
            transform: translateY(-0.25rem) rotate(-45deg);
            /* -4px */
            background: linear-gradient(90deg, #0284c7, #0891b2);
        }

        /* Hide Scrollbar for specific elements */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Modals */
        .modal-active {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        #editModal,
        #breakModal {
            z-index: 100;
        }

        /* Spinner for loading states */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Mobile Logic -->
    <script>
        window.initMobileBehavior = () => {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                // Disable heavy animations/effects if needed
            }
        };
    </script>
</head>

<body class="relative min-h-screen">

    <div class="cursor-dot hidden md:block"></div>
    <div class="cursor-outline hidden md:block"></div>

    <div class="fixed inset-0 overflow-hidden -z-10 pointer-events-none">
        <div
            class="absolute top-0 right-0 w-[500px] h-[500px] bg-[radial-gradient(circle,rgba(252,211,77,0.4)_0%,rgba(255,255,255,0)_70%)] animate-pulse-slow">
        </div>
        <div
            class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-[radial-gradient(circle,rgba(251,207,232,0.4)_0%,rgba(255,255,255,0)_70%)] animate-pulse-slow">
        </div>
    </div>

    <!-- Navigation Backdrop -->
    <div id="navBackdrop" class="nav-backdrop" aria-hidden="true"></div>

    <!-- Retractable Sidebar -->
    <!-- Retractable Sidebar (Hidden by default) -->
    <aside id="appSidebar" class="retractable-sidebar" aria-hidden="true">
        <!-- Header - FIXED HEIGHT -->
        <div class="sidebar-header h-20 flex-shrink-0 flex items-center px-6 border-b border-white/30">
            <a href="../index.html" class="flex items-center gap-3 group transition-all hover:scale-105">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-slate-900 to-slate-700 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:shadow-xl transition-all group-hover:rotate-6">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm tracking-wide">QCO Portal</h1>
                    <p class="text-[10px] text-slate-500 font-medium">Enterprise v2.1</p>
                </div>
            </a>
        </div>

        <!-- Navigation - SCROLLABLE -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-6">
            <div>
                <div class="section-header">General</div>
                <ul class="space-y-1">
                    <li>
                        <a href="../index.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="home" class="w-4 h-4 text-slate-500"></i>
                            <span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="dashboard.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="line-chart" class="w-4 h-4 text-slate-500"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div>
                <div class="section-header">Workflow</div>
                <ul class="space-y-1">
                    <li>
                        <a href="creation.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="pen-tool" class="w-4 h-4 text-slate-500"></i>
                            <span>QCO Creation</span>
                        </a>
                    </li>
                    <li>
                        <a href="operations.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="list-ordered" class="w-4 h-4 text-slate-500"></i>
                            <span>Operations</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div>
                <div class="section-header">Planning</div>
                <ul class="space-y-1">
                    <li>
                        <a href="planning.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="layout-grid" class="w-4 h-4 text-slate-500"></i>
                            <span>Planning</span>
                        </a>
                    </li>
                    <li>
                        <a href="schedule.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i>
                            <span>Schedule</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div>
                <div class="section-header">Utilities</div>
                <ul class="space-y-1">
                    <li>
                        <a href="checklist.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="clipboard-list" class="w-4 h-4 text-slate-500"></i>
                            <span>Checklist</span>
                        </a>
                    </li>
                    <li>
                        <a href="recorder.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors active">
                            <i data-lucide="mic" class="w-4 h-4 text-slate-500"></i>
                            <span>Recorder</span>
                        </a>
                    </li>
                    <li>
                        <a href="summary.html"
                            class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-white/50 rounded-lg transition-colors">
                            <i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Footer - FIXED HEIGHT -->
        <div class="sidebar-footer flex-shrink-0 p-4 border-t border-white/30">
            <div
                class="flex items-center justify-center gap-2 text-[10px] font-bold text-slate-400 tracking-widest uppercase">
                <i data-lucide="lock" class="w-3 h-3 text-slate-300"></i> Secure Access
            </div>
        </div>
    </aside>

    <!-- Main App Container Structure -->
    <div id="appShell" class="flex flex-col h-screen overflow-hidden">
        <!-- Header with Hamburger Menu -->
        <header id="appHeader"
            class="glass h-20 flex items-center justify-between px-4 md:px-8 z-20 flex-shrink-0 sticky top-0 border-b border-white/20">
            <!-- Hamburger Menu Button -->
            <button id="navToggle" class="hamburger-btn touch-target" aria-label="Toggle navigation">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>

            <!-- Right Actions (User, etc.) -->
            <div class="flex items-center gap-4">
                <!-- System Status -->
                <div
                    class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold text-emerald-700 tracking-wider uppercase">System Online</span>
                </div>

                <!-- User Profile -->
                <div class="relative group">
                    <button
                        class="flex items-center gap-3 focus:outline-none group p-1.5 pr-3 rounded-full hover:bg-white/60 transition-all border border-transparent hover:border-slate-200">
                        <div
                            class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 border border-white shadow-sm flex items-center justify-center overflow-hidden">
                            <span class="text-xs font-bold text-white user-initials-display">??</span>
                        </div>
                        <div class="text-left hidden md:block">
                            <p class="text-xs font-bold text-slate-900 user-name-display leading-tight">User</p>
                            <p
                                class="text-[10px] text-slate-500 user-role-display leading-tight uppercase font-semibold">
                                Member</p>
                        </div>
                        <i data-lucide="chevron-down"
                            class="w-3 h-3 text-slate-400 ml-1 group-hover:text-slate-600 transition-colors"></i>
                    </button>
                    <!-- Profile Dropdown -->
                    <div
                        class="absolute right-0 mt-2 w-56 bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl border border-white/50 ring-1 ring-slate-900/5 transform opacity-0 scale-95 pointer-events-none group-hover:pointer-events-auto group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 origin-top-right z-50">
                        <div class="p-2">
                            <button onclick="handleLogout()"
                                class="w-full group flex items-center px-4 py-2.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-xl transition-colors text-left">
                                <i data-lucide="log-out"
                                    class="w-4 h-4 text-red-400 group-hover:text-red-600 transition-colors mr-3"></i>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div id="appContent" class="flex-1 relative overflow-y-auto">
            <div id="mainApp" class="min-h-full flex flex-col pt-8 pb-32 px-6 opacity-0">
                <div class="max-w-[1400px] mx-auto w-full">

                    <!-- Operations Tracker Card -->
                    <div class="glass-card p-6 lg:p-10 relative overflow-hidden mb-6">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-400 to-rose-500"></div>

                        <h2
                            class="text-2xl lg:text-3xl font-heading font-bold text-slate-900 mb-6 lg:mb-8 flex flex-col xl:flex-row items-start xl:items-center justify-between gap-6">
                            <div class="flex items-center gap-3">
                                <span
                                    class="w-10 h-10 rounded-xl bg-slate-900 text-white flex items-center justify-center text-lg shadow-lg shadow-slate-900/20">
                                    <i data-lucide="activity"></i>
                                </span>
                                Operations Log
                            </div>

                            <div class="flex flex-col w-full xl:w-auto lg:flex-row items-stretch lg:items-center gap-4">
                                <div class="flex flex-col sm:flex-row items-stretch gap-3 w-full xl:w-auto">
                                    <div class="relative w-full sm:w-auto">
                                        <i data-lucide="search"
                                            class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                                        <input type="text" id="qcoSearch" onkeyup="handleSearch(event)"
                                            placeholder="Search QCO..."
                                            class="pl-10 pr-10 py-2.5 rounded-xl bg-white border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 w-full sm:w-48 transition-all hover:border-slate-300">
                                        <button onclick="clearSearch()" id="clearSearchBtn"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors hidden">
                                            <i data-lucide="x" class="w-3 h-3"></i>
                                        </button>
                                        <p id="searchStatus"
                                            class="absolute top-full right-0 mt-1 text-xs text-slate-500 hidden z-10 bg-white p-2 rounded-xl shadow-xl border border-slate-100 w-full">
                                        </p>
                                    </div>
                                    <!-- QCO Selector -->
                                    <div class="relative group w-full sm:w-auto">
                                        <select id="qcoSelector" onchange="handleQCOChange(this.value)"
                                            class="appearance-none w-full xl:w-auto bg-white border border-slate-200 text-slate-700 font-bold py-2.5 pl-4 pr-10 rounded-xl hover:border-violet-400 hover:shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-violet-500 cursor-pointer text-sm min-w-[200px]">
                                            <option value="">Select Changeover...</option>
                                        </select>
                                        <i data-lucide="chevron-down"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 pointer-events-none"></i>
                                    </div>
                                    <!-- Shift Mode Toggle -->
                                    <div class="relative group w-full sm:w-auto">
                                        <select id="shiftMode" onchange="handleShiftChange(this.value)"
                                            class="appearance-none w-full sm:w-auto bg-indigo-50 border border-indigo-200 text-indigo-700 font-bold py-2.5 pl-4 pr-10 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer text-sm min-w-[150px]">
                                            <option value="day">Day Only (07-18)</option>
                                            <option value="day-night">Day-Night (24h)</option>
                                        </select>
                                        <i data-lucide="sun-moon"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 w-4 h-4 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="font-mono font-bold text-2xl text-slate-700 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200 shadow-sm text-center sm:text-left min-w-[140px]"
                                id="clock">00:00:00</div>
                        </h2>
                    </div>

                    <!-- Target COPT Info -->
                    <div id="targetCOPTSection"
                        class="mb-6 lg:mb-10 p-6 lg:p-8 bg-gradient-to-br from-emerald-50/50 to-blue-50/50 backdrop-blur-sm rounded-3xl border border-emerald-100/50 shadow-sm relative overflow-hidden">
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-emerald-200/10 rounded-full -mr-16 -mt-16 blur-2xl">
                        </div>
                        <div
                            class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6 relative z-10">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white flex items-center justify-center shadow-lg shadow-emerald-500/20">
                                    <i data-lucide="target" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-emerald-700 uppercase tracking-widest mb-0.5">
                                        Target COPT
                                    </p>
                                    <p class="text-3xl font-heading font-bold text-slate-900">
                                        <span id="recorderTargetCOPT">-</span> <span
                                            class="text-sm text-slate-400 font-semibold ml-1">min</span>
                                    </p>
                                </div>
                            </div>
                            <div
                                class="flex flex-row sm:flex-col items-center sm:items-end justify-between w-full sm:w-auto gap-4">
                                <div class="text-left sm:text-right">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">
                                        Category</p>
                                    <p class="text-sm lg:text-base font-bold text-slate-800 bg-white/60 px-3 py-1 rounded-lg border border-white/50"
                                        id="recorderCategory">-</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tight mb-1"
                                        id="lineIdLabel">Line -</p>
                                    <button onclick="openBreakModal()"
                                        class="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-600 text-xs font-bold hover:bg-blue-100 transition-all flex items-center gap-2">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        Break timings
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-[11px] text-slate-400 mt-4 flex items-center gap-1.5 font-medium">
                            <i data-lucide="info" class="w-3.5 h-3.5 text-emerald-500"></i>
                            Based on SMV and changeover complexity
                        </p>
                    </div>

                    <!-- Operations Tracking Section -->
                    <div id="operationsSection" class="hidden">
                        <h3 class="text-xl font-heading font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm">
                                <i data-lucide="list-checks" class="w-4 h-4"></i>
                            </span>
                            Operations Checklist
                        </h3>
                        <div id="operationsList" class="space-y-3">
                            <!-- Operations will be injected here -->
                        </div>

                        <!-- Mark Completed Section -->
                        <div id="markCompletedSection" class="mt-10 pt-8 border-t-2 border-dashed border-slate-200">
                            <!-- Status Indicator -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div id="statusIndicator"
                                        class="flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-50 border border-amber-200">
                                        <div class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                                        <span class="text-xs font-bold text-amber-700 uppercase tracking-wider"
                                            id="statusText">In Progress</span>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-500">
                                    <span id="completedOpsCount">0</span>/<span id="totalOpsCount">0</span> Operations
                                    <span id="opsPercentage" class="ml-1 font-bold text-slate-700">(0%)</span>
                                </div>
                            </div>

                            <!-- Complete Changeover Button -->
                            <button onclick="openCompleteConfirmModal()" id="markCompletedBtn"
                                class="w-full py-4 px-6 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-heading font-bold text-lg shadow-xl shadow-emerald-500/30 hover:shadow-2xl hover:shadow-emerald-500/40 hover:scale-[1.02] transition-all duration-300 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                                <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                                Mark Changeover as Completed
                            </button>
                            <p class="text-center text-xs text-slate-400 mt-3">
                                <i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i>
                                This will finalize the changeover and update the dashboard
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer
            class="mt-auto py-8 px-6 border-t border-slate-200/30 relative z-10 bg-white/30 backdrop-blur-md -mx-6 -mb-32">
            <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <p class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase">Â© 2026 MANUFACTURING
                    EXCELLENCE SYSTEM</p>
                <div class="flex gap-6">
                    <a href="#" class="text-slate-400 hover:text-blue-500 transition-colors"><i data-lucide="github"
                            class="w-4 h-4"></i></a>
                    <a href="#" class="text-slate-400 hover:text-blue-500 transition-colors"><i data-lucide="twitter"
                            class="w-4 h-4"></i></a>
                    <a href="#" class="text-slate-400 hover:text-blue-500 transition-colors"><i data-lucide="mail"
                            class="w-4 h-4"></i></a>
                </div>
            </div>
        </footer>
    </div> <!-- End mainApp -->
    </div> <!-- End appContent -->
    </div> <!-- End appShell -->





    <script>
        // --- Navigation System ---
        // Standardized Navigation System
        class NavigationSystem {
            constructor() {
                this.isOpen = false;
                this.init();
            }

            init() {
                this.toggleBtn = document.getElementById('navToggle');
                this.sidebar = document.getElementById('appSidebar');
                this.backdrop = document.getElementById('navBackdrop');
                this.body = document.body;

                this.setupEventListeners();
                this.resolveActiveState();
                this.setupScrollableNav();
            }

            setupEventListeners() {
                if (this.toggleBtn) {
                    this.toggleBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.toggleSidebar();
                    });
                }

                if (this.backdrop) {
                    this.backdrop.addEventListener('click', (e) => {
                        if (e.target === this.backdrop) this.closeSidebar();
                    });

                    this.backdrop.addEventListener('touchstart', (e) => {
                        if (e.target === this.backdrop) this.closeSidebar();
                    }, { passive: true });
                }

                if (this.sidebar) {
                    this.sidebar.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => this.closeSidebar());
                    });
                }

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) this.closeSidebar();
                });
            }

            toggleSidebar() {
                this.isOpen ? this.closeSidebar() : this.openSidebar();
            }

            openSidebar() {
                this.isOpen = true;
                this.sidebar?.classList.add('open');
                this.toggleBtn?.classList.add('open');
                this.backdrop?.classList.add('active');
                this.body.style.overflow = 'hidden';
                if (window.lenis) window.lenis.stop();
            }

            closeSidebar() {
                this.isOpen = false;
                this.sidebar?.classList.remove('open');
                this.toggleBtn?.classList.remove('open');
                this.backdrop?.classList.remove('active');
                this.body.style.overflow = '';
                if (window.lenis) window.lenis.start();
            }

            resolveActiveState() {
                const currentPath = window.location.pathname;
                const filename = currentPath.split('/').pop() || 'index.html';
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    const href = item.getAttribute('href');
                    if (href && (filename === href.split('/').pop())) {
                        item.classList.add('active');
                    }
                });
            }

            setupScrollableNav() {
                const nav = this.sidebar?.querySelector('nav');
                if (nav) {
                    this.sidebar.addEventListener('touchmove', (e) => {
                        if (this.isOpen) e.stopPropagation();
                    }, { passive: false });
                }
            }
        }

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCayfWGQP1t3oBU9eFj-3Ww0uu7nSl3Q4g",
            authDomain: "sidneymailer.firebaseapp.com",
            projectId: "sidneymailer",
            storageBucket: "sidneymailer.firebasestorage.app",
            messagingSenderId: "911316068119",
            appId: "1:911316068119:web:ce23dbe663dc385a81f952",
            measurementId: "G-NJ0QH6DEXG"
        };
        // Initialize
        let db, auth;
        let currentQCOId = null;
        let currentQCOData = null;
        let currentLineSchedule = null;
        let shiftMode = "day"; // Default
        const allChangeovers = []; // For dropdown population

        const RAW_LINE_SCHEDULES = {
            "S-01": { supervisor: "WASANA-1", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:45", end: "17:00" }] },
            "S-01A": { supervisor: "WASANA-2", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:50", end: "17:05" }] },
            "S-02": { supervisor: "SOHRAB", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-03": { supervisor: "SOHEL", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-04": { supervisor: "AHMAD", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-05": { supervisor: "OMAR FARUK", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-06": { supervisor: "SUMI", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-07": { supervisor: "NAGENDRA", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:50", end: "17:05" }] },
            "S-07A": { supervisor: "KAMAL-2", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-08": { supervisor: "BALISTER", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-09": { supervisor: "MONJURUL", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-10": { supervisor: "RAJKUMAR", breaks: [{ start: "09:45", end: "10:00" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-11": { supervisor: "KAMAL-1", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-12": { supervisor: "DARMENDRA", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-13": { supervisor: "SUMON", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-14": { supervisor: "SHARIF", breaks: [{ start: "09:00", end: "09:15" }, { start: "12:00", end: "12:30" }, { start: "16:15", end: "16:30" }] },
            "S-15": { supervisor: "MUNSEF", breaks: [{ start: "09:30", end: "09:45" }, { start: "12:30", end: "13:00" }, { start: "16:45", end: "17:00" }] },
            "S-16": { supervisor: "RAHAMAN", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-17": { supervisor: "MASUM", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-18": { supervisor: "DIANA", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:20", end: "13:50" }, { start: "17:00", end: "17:15" }] },
            "S-19": { supervisor: "ALAMGIR", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-20": { supervisor: "KAZAL", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-21": { supervisor: "DEVRAJ", breaks: [{ start: "09:45", end: "10:00" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-22": { supervisor: "ASHRAFUL", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:20", end: "12:50" }, { start: "16:30", end: "16:45" }] },
            "S-23": { supervisor: "RUMA", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] },
            "S-24": { supervisor: "NASIR", breaks: [{ start: "09:10", end: "09:25" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-25": { supervisor: "AKBAR", breaks: [{ start: "09:50", end: "10:05" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-26": { supervisor: "HIMAYAT", breaks: [{ start: "09:45", end: "10:00" }, { start: "13:00", end: "13:30" }, { start: "17:00", end: "17:15" }] },
            "S-28": { supervisor: "ROOP NARAYAN", breaks: [{ start: "09:40", end: "09:55" }, { start: "12:40", end: "13:10" }, { start: "16:50", end: "17:05" }] },
            "S-29": { supervisor: "SUBA", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-30": { supervisor: "RAJIB", breaks: [{ start: "09:20", end: "09:35" }, { start: "12:10", end: "12:40" }, { start: "16:20", end: "16:35" }] },
            "S-31": { supervisor: "AKASH", breaks: [{ start: "09:00", end: "09:15" }, { start: "11:50", end: "12:20" }, { start: "16:15", end: "16:30" }] },
            "S-32": { supervisor: "KALU CHARAN", breaks: [{ start: "09:45", end: "10:00" }, { start: "12:50", end: "13:20" }, { start: "16:50", end: "17:05" }] }
        };

        function handleShiftChange(val) {
            shiftMode = val;
            localStorage.setItem('shiftMode', val);
            console.log("Shift Mode changed to:", val);
            if (currentQCOId) loadData(); // Reload to refresh all calculations with new shift logic
        }

        function openBreakModal() {
            console.log("Opening Break Modal. Current schedule state:", currentLineSchedule);
            const modal = document.getElementById('breakModal');
            const container = document.getElementById('breakListContainer');
            const title = document.getElementById('breakModalTitle');

            if (window.lenis) window.lenis.stop();
            modal.classList.remove('hidden');
            title.textContent = currentLineSchedule ? `Schedule: ${currentLineSchedule.lineKey}` : 'Line Schedule';

            if (!currentLineSchedule || !currentLineSchedule.breaks) {
                container.innerHTML = `<p class="text-sm text-slate-500 italic text-center py-4">No schedule data available for this line.</p>`;
                return;
            }

            container.innerHTML = currentLineSchedule.breaks.map(b => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-slate-400">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                        </div>
                        <span class="text-sm font-semibold text-slate-700">Production Break</span>
                    </div>
                    <span class="text-sm font-mono font-bold text-slate-900 bg-white px-2 py-1 rounded-lg border border-slate-100 shadow-sm">
                        ${b.start} - ${b.end}
                    </span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function closeBreakModal() {
            document.getElementById('breakModal').classList.add('hidden');
            if (window.lenis) window.lenis.start();
        }

        // =====================================================
        // MARK COMPLETED FUNCTIONS
        // =====================================================

        function updateStatusIndicator() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const completedCount = document.getElementById('completedOpsCount');
            const totalCount = document.getElementById('totalOpsCount');

            if (!currentQCOData) return;

            const ops = currentQCOData.operationsList || [];
            const completed = ops.filter(o => o.endTime).length;
            const total = ops.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            if (completedCount) completedCount.textContent = completed;
            if (totalCount) totalCount.textContent = total;

            const percentageEl = document.getElementById('opsPercentage');
            if (percentageEl) {
                percentageEl.textContent = `(${percentage}%)`;
                // Add color indication based on progress
                percentageEl.className = 'ml-1 font-bold ' +
                    (percentage === 100 ? 'text-emerald-600' :
                        percentage > 50 ? 'text-blue-600' :
                            'text-slate-700');
            }

            // Update status based on current state
            const status = currentQCOData.status || 'pending';

            if (status === 'completed') {
                if (statusIndicator) {
                    statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-50 border border-emerald-200';
                    statusIndicator.querySelector('div').className = 'w-2 h-2 rounded-full bg-emerald-500';
                }
                if (statusText) {
                    statusText.textContent = 'Completed';
                    statusText.className = 'text-xs font-bold text-emerald-700 uppercase tracking-wider';
                }
                // Disable button
                const btn = document.getElementById('markCompletedBtn');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i data-lucide="check-circle-2" class="w-6 h-6"></i> Changeover Completed';
                    lucide.createIcons();
                }
            } else if (status === 'in-progress' || completed > 0) {
                if (statusIndicator) {
                    statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-50 border border-amber-200';
                    statusIndicator.querySelector('div').className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
                }
                if (statusText) {
                    statusText.textContent = 'In Progress';
                    statusText.className = 'text-xs font-bold text-amber-700 uppercase tracking-wider';
                }
            } else {
                if (statusIndicator) {
                    statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200';
                    statusIndicator.querySelector('div').className = 'w-2 h-2 rounded-full bg-slate-400';
                }
                if (statusText) {
                    statusText.textContent = 'Pending';
                    statusText.className = 'text-xs font-bold text-slate-600 uppercase tracking-wider';
                }
            }
        }

        function openCompleteConfirmModal() {
            if (!currentQCOData) {
                showToast('No changeover selected', 'error');
                return;
            }

            const modal = document.getElementById('completeConfirmModal');
            const ops = currentQCOData.operations || [];
            const completed = ops.filter(o => o.endTime).length;

            // Populate modal data
            document.getElementById('confirmQcoNumber').textContent = currentQCOData.qcoNumber || '-';
            document.getElementById('confirmStyle').textContent = currentQCOData.upcomingStyle || '-';
            document.getElementById('confirmOpsCount').textContent = `${completed}/${ops.length}`;

            if (window.lenis) window.lenis.stop();
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeCompleteConfirmModal() {
            document.getElementById('completeConfirmModal').classList.add('hidden');
            if (window.lenis) window.lenis.start();
        }

        async function confirmMarkCompleted() {
            if (!currentQCOData || !currentQCOData.id) {
                showToast('No changeover selected', 'error');
                return;
            }

            const btn = document.getElementById('confirmCompleteBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Completing...';

            try {
                const now = new Date();

                // Update Firebase
                await db.collection('changeovers').doc(currentQCOData.id).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedBy: currentUser?.uid || 'unknown'
                });

                // Update local state
                currentQCOData.status = 'completed';
                currentQCOData.completedAt = now;

                closeCompleteConfirmModal();
                updateStatusIndicator();

                showToast('Changeover marked as completed!', 'success');

                // Redirect to summary after short delay
                setTimeout(() => {
                    window.location.href = `summary.html?qco=${currentQCOData.id}`;
                }, 1500);

            } catch (error) {
                console.error('Error completing changeover:', error);
                showToast('Failed to complete changeover', 'error');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // Helper function for toast notifications
        function showToast(message, type = 'info') {
            // Create toast if not exists
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-xl z-[100] transition-all duration-300 transform translate-y-20 opacity-0';
                document.body.appendChild(toast);
            }

            // Set color based on type
            const colors = {
                success: 'bg-emerald-600 text-white',
                error: 'bg-red-600 text-white',
                info: 'bg-slate-800 text-white',
                warning: 'bg-amber-500 text-white'
            };

            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-xl z-[100] transition-all duration-300 font-semibold text-sm ${colors[type] || colors.info}`;
            toast.textContent = message;

            // Show
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);

            // Hide after 3s
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function updateUserUI() {
            let user = {};
            try {
                user = JSON.parse(localStorage.getItem('qcoCurrentUser')) || {};
            } catch (e) {
                console.warn("User data error:", e);
            }
            const name = user.displayName || user.name || 'User';
            const role = user.role || 'Member';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2);

            document.querySelectorAll('.user-initials-display').forEach(el => el.textContent = initials);
            document.querySelectorAll('.user-name-display').forEach(el => el.textContent = name);
            document.querySelectorAll('.user-role-display').forEach(el => el.textContent = role.toUpperCase());
        }

        function handleLogout() {
            if (confirm("Are you sure you want to sign out?")) {
                auth.signOut().then(() => {
                    localStorage.removeItem('qcoCurrentUser');
                    localStorage.removeItem('currentQCOId');
                    window.location.href = '../index.html';
                });
            }
        }

        let clockInterval;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Instant Reveal
            gsap.to("#mainApp", { opacity: 1, duration: 0.4, ease: "power2.out" });

            // 2. Initialize Navigation
            window.navSystem = new NavigationSystem();

            // 3. Mobile Init
            if (window.initMobileBehavior) window.initMobileBehavior();

            // 4. Lenis Init
            window.lenis = new Lenis({
                wrapper: document.getElementById('appContent'),
                content: document.getElementById('mainApp'),
                duration: 1.2,
                easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                smoothWheel: true,
                smoothTouch: false,
                touchMultiplier: 1.5,
                topOffset: 0
            });
            function raf(time) { window.lenis.raf(time); requestAnimationFrame(raf); }
            requestAnimationFrame(raf);

            // Scroll State
            let isScrolling;
            document.getElementById('appContent').addEventListener('scroll', () => {
                document.body.classList.add('is-scrolling');
                clearTimeout(isScrolling);
                isScrolling = setTimeout(() => {
                    document.body.classList.remove('is-scrolling');
                }, 150);
            }, { passive: true });

            // 5. Auth & Firebase Sequence
            const user = JSON.parse(localStorage.getItem('qcoCurrentUser'));
            if (!user) {
                window.location.href = '../index.html';
                return;
            }
            if (user.role === 'planning') {
                window.location.replace('schedule.html');
                return;
            }

            // Init Firebase
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();

            // Wait for Auth
            await new Promise(resolve => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) {
                        localStorage.setItem('qcoCurrentUser', JSON.stringify({
                            uid: u.uid,
                            name: u.displayName || 'User',
                            email: u.email,
                            role: user.role || 'Member'
                        }));
                    }
                    updateUserUI();
                    unsubscribe();
                    resolve();
                });
            });

            // 6. Data Loading
            await loadChangeoverList();

            // 7. Cursor
            const dot = document.querySelector('.cursor-dot');
            const outline = document.querySelector('.cursor-outline');
            window.addEventListener('mousemove', e => {
                gsap.to(dot, { x: e.clientX, y: e.clientY, duration: 0.1 });
                gsap.to(outline, { x: e.clientX, y: e.clientY, duration: 0.5 });
            });

            // 8. Clock
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                const el = document.getElementById('clock');
                if (el) el.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
            }, 1000);

            lucide.createIcons();
        });

        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    localStorage.setItem('qcoCurrentUser', JSON.stringify({
                        uid: user.uid,
                        name: user.displayName || 'User',
                        email: user.email,
                        role: 'Member'
                    }));
                } else {
                    if (!localStorage.getItem('qcoCurrentUser')) {
                        window.location.href = '../index.html';
                    }
                }
                updateUserUI();
            });
        }



        // --- Data Logic: Selection & Loading ---

        async function loadChangeoverList() {
            try {
                const snapshot = await db.collection('changeovers').orderBy('createdAt', 'desc').limit(20).get();
                const selector = document.getElementById('qcoSelector');
                selector.innerHTML = '<option value="">Select Changeover...</option>';

                const currentSaved = localStorage.getItem('currentQCOId');
                let foundMatch = false;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    const upcomingStyle = data.upcomingStyle || 'Unknown';
                    const last4Digits = upcomingStyle.length >= 4 ? upcomingStyle.slice(-4) : upcomingStyle;
                    opt.textContent = `${data.qcoNumber || 'QCO'} - ${last4Digits}`;

                    if (doc.id === currentSaved) {
                        opt.selected = true;
                        foundMatch = true;
                    }
                    selector.appendChild(opt);
                    allChangeovers.push({ id: doc.id, ...data });
                });

                if (foundMatch) {
                    currentQCOId = currentSaved;
                    await loadData();
                } else if (snapshot.size > 0) {
                    // document.getElementById('qcoSelector').value = ""; // Default empty to force selection or prompt
                }

            } catch (e) {
                console.error("Error loading Changeover list:", e);
            }
        }

        function handleQCOChange(qcoId) {
            if (!qcoId) return;
            localStorage.setItem('currentQCOId', qcoId);
            currentQCOId = qcoId;

            // Clear current view to prevent interaction with stale data
            document.getElementById('operationsSection').classList.add('hidden');
            document.getElementById('operationsList').innerHTML = ''; // Clear list

            loadData(); // Reload operations and data for new QCO
        }

        // --- Data Loading ---

        async function loadData() {
            if (!currentQCOId) return;
            try {
                const doc = await db.collection('changeovers').doc(currentQCOId).get();
                if (doc.exists) {
                    const data = doc.data();
                    currentQCOData = { id: doc.id, ...data };

                    // --- Extract Line ID and Load Schedule ---
                    // Fix: Prioritize 'lineNumber' field from data, fallback to QCO number parsing
                    let lineKey = data.lineNumber || "Unknown";

                    if (lineKey === "Unknown" && data.qcoNumber) {
                        const parts = data.qcoNumber.split('-');
                        // Handle formats like "S-01-..." or "01-..."
                        if (parts.length >= 2) {
                            if (parts[0].toUpperCase() === 'S') {
                                lineKey = parts.slice(0, 2).join('-');
                            } else {
                                lineKey = parts[0];
                            }
                        }
                    }

                    // Display Line ID in UI
                    const lineIdLabel = document.getElementById('lineIdLabel');
                    if (lineIdLabel) lineIdLabel.textContent = `Line: ${lineKey}`;

                    // --- Robustness: Normalization ---
                    lineKey = lineKey.toString().trim().toUpperCase();
                    if (/^\d+[A-Z]?$/.test(lineKey) && !lineKey.startsWith('S-')) {
                        const numPart = lineKey.match(/\d+/)[0];
                        const letterPart = lineKey.match(/[A-Z]$/) ? lineKey.match(/[A-Z]$/)[0] : '';
                        lineKey = "S-" + numPart.padStart(2, '0') + letterPart;
                    } else if (lineKey.startsWith('S-')) {
                        const sub = lineKey.substring(2);
                        if (/^\d+[A-Z]?$/.test(sub)) {
                            const numPart = sub.match(/\d+/)[0];
                            const letterPart = sub.match(/[A-Z]$/) ? sub.match(/[A-Z]$/)[0] : '';
                            lineKey = "S-" + numPart.padStart(2, '0') + letterPart;
                        }
                    }
                    console.log("Final LineKey used for schedule lookup:", lineKey);

                    if (!currentLineSchedule || currentLineSchedule.lineKey !== lineKey) {
                        try {
                            const schedDoc = await db.collection('line_schedules').doc(lineKey).get();
                            if (schedDoc.exists) {
                                currentLineSchedule = { lineKey, ...schedDoc.data() };
                                console.log("Loaded schedule from Firebase for", lineKey, currentLineSchedule);
                            } else if (RAW_LINE_SCHEDULES[lineKey]) {
                                // Fallback: Use hardcoded schedule
                                currentLineSchedule = { lineKey, ...RAW_LINE_SCHEDULES[lineKey] };
                                console.log("Using hardcoded fallback schedule for", lineKey, currentLineSchedule);
                            } else {
                                console.warn("No schedule found (Firebase or Fallback) for", lineKey);
                                currentLineSchedule = null;
                            }
                        } catch (err) {
                            console.error("Error loading schedule:", err);
                        }
                    }

                    // Calculate and display Target COPT
                    updateTargetCOPTDisplay(data);

                    // Load Operations List for Tracking
                    if (data.operationsList && Array.isArray(data.operationsList)) {
                        renderOperationsList(data.operationsList, data.operationTimings || {}, currentQCOId);
                        updateStatusIndicator();
                    } else {
                        document.getElementById('operationsSection').classList.add('hidden');
                    }
                }
            } catch (e) {
                console.error("Error loading data:", e);
                showToast("Failed to load QCO data. Please check your connection.", "error");
                document.getElementById('operationsSection').classList.add('hidden');
            }
        }

        /**
         * Calculates net duration in minutes, excluding break times.
         * Day Mode: Deducts any time outside 07:00-18:00.
         */
        function getNetDuration(startISO, endISO, schedule) {
            const start = new Date(startISO);
            const end = new Date(endISO);
            if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
            const mode = shiftMode;

            if (mode === 'day') {
                // Logic: Only count minutes within 07:00 and 18:00
                // For now, if it spans multiple days, we process each day.
                let totalMins = 0;
                let iter = new Date(start);

                while (iter < end) {
                    const nextMin = new Date(iter.getTime() + 60000);
                    const h = iter.getHours();
                    const isWithinShift = h >= 7 && h < 18; // 07:00 to 17:59:59

                    if (isWithinShift) {
                        // Check if this minute overlaps with a break
                        let inBreak = false;
                        if (schedule && schedule.breaks) {
                            const timeStr = `${h.toString().padStart(2, '0')}:${iter.getMinutes().toString().padStart(2, '0')}`;
                            inBreak = schedule.breaks.some(b => timeStr >= b.start && timeStr < b.end);
                        }
                        if (!inBreak) totalMins++;
                    }
                    iter = nextMin;
                }
                return totalMins;
            } else {
                // Day-Night (24h) Mode
                let totalMinutes = (end - start) / 60000;
                if (!schedule || !schedule.breaks || !Array.isArray(schedule.breaks)) return totalMinutes;

                // Simple break overlap logic for 24h (same day assumption for now)
                const getBreakOverlay = (breakStartStr, breakEndStr) => {
                    const bStart = new Date(start);
                    const [sh, sm] = breakStartStr.split(':').map(Number);
                    bStart.setHours(sh, sm, 0, 0);
                    const bEnd = new Date(start);
                    const [eh, em] = breakEndStr.split(':').map(Number);
                    bEnd.setHours(eh, em, 0, 0);

                    const overlapStart = new Date(Math.max(start, bStart));
                    const overlapEnd = new Date(Math.min(end, bEnd));
                    return (overlapStart < overlapEnd) ? (overlapEnd - overlapStart) / 60000 : 0;
                };

                let deduction = 0;
                schedule.breaks.forEach(b => deduction += getBreakOverlay(b.start, b.end));
                return Math.max(0, totalMinutes - deduction);
            }
        }

        function renderOperationsList(operations, timings, qcoId) {
            const section = document.getElementById('operationsSection');
            const list = document.getElementById('operationsList');

            if (!operations || operations.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            list.innerHTML = operations.map((op, index) => {
                // Handle both old format (string) and new format (object)
                const opName = typeof op === 'string' ? op : op.name;
                const opSMV = typeof op === 'object' ? op.smv : null;

                const safeOpName = opName.replace(/"/g, '&quot;');
                const timing = timings && timings[opName];
                const startTime = timing ? timing.start : null;
                const endTime = timing ? timing.end : null;
                const department = timing ? timing.department || '' : '';
                const remarks = timing ? timing.remarks || '' : '';

                // Calculate standard time (SMV Ã 10) - try from operation SMV first, then fall back to saved value
                let standardTime = null;
                if (opSMV !== null && opSMV !== undefined) {
                    standardTime = (opSMV * 10).toFixed(2);
                } else if (timing && timing.standardTime !== null && timing.standardTime !== undefined) {
                    // Fallback: use standardTime that was saved in Firebase
                    standardTime = parseFloat(timing.standardTime).toFixed(2);
                }

                // Calculate actual time
                const actualTime = (startTime && endTime)
                    ? ((new Date(endTime) - new Date(startTime)) / 60000).toFixed(2)
                    : null;

                let rowHtml = '';

                // Common button logic - always pass qcoId!
                if (endTime && actualTime !== null) {
                    // Completed - show all controls
                    const isOnTime = standardTime ? parseFloat(actualTime) <= parseFloat(standardTime) : true;
                    const comparisonColor = isOnTime ? 'text-emerald-600' : 'text-rose-600';
                    const variance = standardTime ? (parseFloat(actualTime) - parseFloat(standardTime)).toFixed(2) : 0;

                    rowHtml = `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 p-3 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex-shrink-0">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <p class="text-sm font-bold text-slate-900">${opName}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] font-bold ${comparisonColor} bg-${isOnTime ? 'emerald' : 'rose'}-50 px-2 py-0.5 rounded">
                                        ${actualTime}m
                                    </span>
                                    ${standardTime ? `<span class="text-[10px] font-medium text-slate-400">vs ${standardTime}m</span>` : ''}
                                    ${standardTime ? `<span class="text-[10px] font-bold ${comparisonColor}">${variance > 0 ? '+' : ''}${variance}m</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto sm:ml-auto">
                            <select id="dept_${index}" class="flex-1 sm:flex-none px-3 py-2 text-xs rounded-lg border border-slate-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all w-full sm:w-32">
                                <option value="">Dept...</option>
                                <option value="Trims" ${department === 'Trims' ? 'selected' : ''}>Trims</option>
                                <option value="Cutting" ${department === 'Cutting' ? 'selected' : ''}>Cutting</option>
                                <option value="Production" ${department === 'Production' ? 'selected' : ''}>Production</option>
                                <option value="Merchandiser" ${department === 'Merchandiser' ? 'selected' : ''}>Merchandiser</option>
                                <option value="IE" ${department === 'IE' ? 'selected' : ''}>IE</option>
                                <option value="Technical" ${department === 'Technical' ? 'selected' : ''}>Technical</option>
                                <option value="Maintenance" ${department === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                            </select>
                            <input type="text" id="remarks_${index}" placeholder="Remarks..." value="${remarks}"
                                class="flex-1 sm:flex-none px-3 py-2 text-xs rounded-lg border border-slate-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all min-w-[120px]">
                            
                            <div class="flex items-center gap-2 ml-auto sm:ml-0">
                                <button onclick="saveOperationDetails('${qcoId}', '${index}', '${safeOpName}')" 
                                    class="p-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 transition-all flex-shrink-0" title="Save Info">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                </button>
                                <button onclick="openEditModal('${qcoId}', '${index}', '${safeOpName}')" 
                                    class="px-4 py-2 rounded-lg bg-white border-2 border-slate-200 text-slate-700 text-xs font-bold hover:bg-slate-50 hover:border-slate-300 transition-all whitespace-nowrap">
                                    <i data-lucide="edit-3" class="w-3 h-3 inline mr-1"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                } else if (startTime) {
                    // Running - show end button and standard time
                    rowHtml = `
                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-amber-100 text-amber-600 flex-shrink-0">
                            <span class="w-2 h-2 bg-amber-600 rounded-full animate-ping"></span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-900">${opName}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-[10px] font-bold text-amber-600">Running...</p>
                                ${standardTime ? `<span class="text-[10px] font-medium text-slate-500">Allowed: ${standardTime}m</span>` : ''}
                            </div>
                        </div>
                        <button onclick="endOperation('${qcoId}', '${index}', '${safeOpName}', ${opSMV})" 
                            class="px-6 py-2 rounded-lg bg-rose-500 text-white text-xs font-bold hover:bg-rose-600 transition-all shadow-sm ml-auto">
                            End
                        </button>
                    </div>
                    `;
                } else {
                    // Not started - show start button and standard time
                    rowHtml = `
                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all hover:border-emerald-300">
                        <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 text-slate-400 flex-shrink-0">
                            <i data-lucide="circle" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-900">${opName}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-[10px] font-medium text-slate-400">Not started</p>
                                ${standardTime ? `<span class="text-[10px] font-medium text-slate-500">Allowed: ${standardTime}m</span>` : ''}
                            </div>
                        </div>
                        <button onclick="startOperation('${qcoId}', '${index}', '${safeOpName}')" 
                            class="px-6 py-2 rounded-lg bg-emerald-500 text-white text-xs font-bold hover:bg-emerald-600 transition-all shadow-sm ml-auto">
                            Start
                        </button>
                    </div>
                    `;
                }

                return rowHtml;
            }).join('');

            lucide.createIcons();
        }

        function toggleMobileMenu() {
            window.navSystem?.toggleSidebar();
        }

        let currentEditOp = null;

        async function openEditModal(qcoId, index, opName) {
            if (!qcoId) return;
            currentEditOp = { index, opName, qcoId };

            try {
                // Get current values from UI
                const currentDept = document.getElementById(`dept_${index}`) ? document.getElementById(`dept_${index}`).value : '';
                const currentRemarks = document.getElementById(`remarks_${index}`) ? document.getElementById(`remarks_${index}`).value : '';

                // Get original data for timestamps
                const doc = await db.collection('changeovers').doc(qcoId).get();
                const data = doc.data();
                const timing = data.operationTimings && data.operationTimings[opName];

                if (!timing) { alert("Timing data not found"); return; }

                // Populate Modal
                document.getElementById('editOpName').textContent = opName;
                document.getElementById('editDept').value = currentDept || timing.department || '';
                document.getElementById('editRemarks').value = currentRemarks || timing.remarks || '';

                const formatForInput = (isoString) => {
                    if (!isoString) return '';
                    const d = new Date(isoString);
                    if (isNaN(d.getTime())) return '';
                    const z = d.getTimezoneOffset() * 60 * 1000;
                    const localTime = new Date(d - z);
                    return localTime.toISOString().slice(0, 19);
                };

                document.getElementById('editStartTime').value = formatForInput(timing.start);
                document.getElementById('editEndTime').value = formatForInput(timing.end);

                // Show Modal
                const modal = document.getElementById('editModal');
                if (window.lenis) window.lenis.stop();
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                gsap.from('#editModalContent', { y: 20, opacity: 0, duration: 0.3 });

            } catch (e) { console.error(e); alert("Error opening edit modal"); }
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (window.lenis) window.lenis.start();
            }, 300);
            currentEditOp = null;
        }

        async function saveEditModal() {
            if (!currentEditOp || !currentEditOp.qcoId) return;
            const qcoId = currentEditOp.qcoId;

            try {
                const opName = currentEditOp.opName;
                const newStart = document.getElementById('editStartTime').value;
                const newEnd = document.getElementById('editEndTime').value;
                const newDept = document.getElementById('editDept').value;
                const newRemarks = document.getElementById('editRemarks').value;

                if (!newStart) { alert("Start time is required"); return; }

                // Convert inputs back to ISO string
                const startDate = new Date(newStart);
                const endDate = newEnd ? new Date(newEnd) : null;

                const startISO = startDate.toISOString();
                const endISO = endDate ? endDate.toISOString() : null;

                // Calculate durations if end time exists
                let actualTime = null;
                if (endDate && !isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    actualTime = getNetDuration(startISO, endISO, currentLineSchedule);
                }

                // Get standard time to preserve or recalculate if needed? 
                // Mostly just update what changed.
                // Re-fetching original to be safe about preserving other fields
                const doc = await db.collection('changeovers').doc(qcoId).get();
                const data = doc.data();
                const existing = data.operationTimings[opName] || {};

                const fieldPath = new firebase.firestore.FieldPath('operationTimings', opName);
                await db.collection('changeovers').doc(qcoId).update(fieldPath, {
                    ...existing,
                    start: startISO,
                    end: endISO,
                    department: newDept,
                    remarks: newRemarks,
                    actualTime: actualTime ? parseFloat(actualTime) : existing.actualTime
                });

                closeEditModal();
                loadData();

                // Show success toast (simple alert replacement for now or custom toast)
                const toast = document.createElement('div');
                toast.className = "fixed bottom-5 right-5 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-lg z-[60] animate-fade-in";
                toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Update Saved';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

            } catch (e) { console.error(e); alert("Failed to save changes"); }
        }
        async function saveOperationDetails(qcoId, index, opName) {
            if (!qcoId) {
                console.warn("No QCO selected");
                return;
            }

            // Get button reference safely from event if available, or target by ID
            let btn = null;
            if (typeof event !== 'undefined' && event && event.target) {
                btn = event.target.closest('button');
            }

            console.log("Save initiated for:", opName, "Index:", index, "QCO ID:", qcoId);

            try {
                const deptEl = document.getElementById(`dept_${index}`);
                const remarksEl = document.getElementById(`remarks_${index}`);

                if (!deptEl || !remarksEl) {
                    throw new Error("Department or Remarks field not found in DOM");
                }

                const department = deptEl.value || '';
                const remarks = remarksEl.value || '';

                // Show loading state
                if (btn) {
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin w-4 h-4"></i>';
                    btn.disabled = true;
                }

                const docRef = db.collection('changeovers').doc(qcoId);
                const doc = await docRef.get();

                if (!doc.exists) throw new Error("QCO document not found");

                const timings = doc.data().operationTimings || {};
                const existing = timings[opName] || {};

                const fieldPath = new firebase.firestore.FieldPath('operationTimings', opName);

                await docRef.update(fieldPath, {
                    ...existing,
                    department: department,
                    remarks: remarks
                });

                // Success feedback
                if (btn) {
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                    btn.classList.remove('bg-slate-900');
                    btn.classList.add('bg-emerald-600');
                    lucide.createIcons();

                    setTimeout(() => {
                        btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i>';
                        btn.classList.remove('bg-emerald-600');
                        btn.classList.add('bg-slate-900');
                        btn.disabled = false;
                        lucide.createIcons();
                    }, 2000);
                }

                // Show success toast
                showToast("Update Saved Successfully", "success");

            } catch (e) {
                console.error("â Save failed:", e);
                showToast("Failed to save: " + e.message, "error");
                if (btn) {
                    btn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
                    btn.classList.add('bg-red-600');
                    lucide.createIcons();
                    setTimeout(() => {
                        btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i>';
                        btn.classList.remove('bg-red-600');
                        btn.disabled = false;
                        lucide.createIcons();
                    }, 2000);
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-emerald-600' : 'bg-rose-600';
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';

            toast.className = `fixed bottom-5 right-5 ${bgClass} text-white px-6 py-3 rounded-xl shadow-lg z-[100] transition-all duration-300 transform translate-y-10 opacity-0`;
            toast.innerHTML = `<i class="fas fa-${icon} mr-2"></i> ${message}`;
            document.body.appendChild(toast);

            // Animation
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function startOperation(qcoId, index, opName) {
            if (!qcoId) return;
            try {
                // Fetch current data to find the last operation's end time
                const doc = await db.collection('changeovers').doc(qcoId).get();
                const data = doc.data();
                const timings = data.operationTimings || {};

                let lastEndTime = null;
                let maxEndTimeMs = 0;

                // Iterate through all timings to find the latest end time
                Object.values(timings).forEach(timing => {
                    if (timing.end) {
                        const endTimeMs = new Date(timing.end).getTime();
                        if (!isNaN(endTimeMs) && endTimeMs > maxEndTimeMs) {
                            maxEndTimeMs = endTimeMs;
                            lastEndTime = timing.end;
                        }
                    }
                });

                // Use last end time if available, otherwise use current time
                // Ideally, if there's a last end time, we start EXACTLY then to account for idle time
                const timestamp = lastEndTime ? lastEndTime : new Date().toISOString();

                console.log(`Starting operation: ${opName}`);
                console.log(`Using start time: ${timestamp} (derived from ${lastEndTime ? 'previous operation end' : 'current time'})`);

                const fieldPath = new firebase.firestore.FieldPath('operationTimings', opName);

                await db.collection('changeovers').doc(qcoId).update(
                    fieldPath, { start: timestamp }
                );

                // Refresh data to update status
                loadData();
            } catch (e) {
                console.error("Error starting operation:", e);
                alert("Failed to start timer. Check connection.");
            }
        }

        async function endOperation(qcoId, index, opName, opSMV) {
            if (!qcoId) return;
            try {
                const endTimestamp = new Date().toISOString();

                // Get the start time from current data
                const doc = await db.collection('changeovers').doc(qcoId).get();
                const data = doc.data();
                const timing = data.operationTimings && data.operationTimings[opName];
                const startTimestamp = timing ? timing.start : null;

                if (!startTimestamp) {
                    alert("No start time found for this operation!");
                    return;
                }

                // Calculate actual time in minutes (2 decimals)
                // Use getNetDuration to account for breaks
                const netMinutes = getNetDuration(startTimestamp, endTimestamp, currentLineSchedule);
                const actualTimeMinutes = netMinutes.toFixed(2);

                // Calculate standard time (SMV Ã 10, 2 decimals)
                const standardTimeMinutes = opSMV !== null && opSMV !== undefined
                    ? (parseFloat(opSMV) * 10).toFixed(2)
                    : null;

                // Update Firebase with all timing data
                const fieldPath = new firebase.firestore.FieldPath('operationTimings', opName);
                await db.collection('changeovers').doc(qcoId).update(
                    fieldPath, {
                    start: startTimestamp,
                    end: endTimestamp,
                    actualTime: parseFloat(actualTimeMinutes),
                    standardTime: standardTimeMinutes ? parseFloat(standardTimeMinutes) : null
                }
                );

                loadData();
            } catch (e) {
                console.error("Error ending operation:", e);
                alert("Failed to end timer.");
            }
        }



        function updateTargetCOPTDisplay(qcoData) {
            // Get SMV - check multiple possible field names
            const smv = qcoData.upcomingSMV || qcoData.newStyleSMV || qcoData.upcomingStyleSMV || 0;

            // Get category (default to C)
            const category = qcoData.changeoverCategory || 'C';

            // Multiplier based on category
            const multipliers = { 'A': 7, 'B': 5, 'C': 3 };
            const multiplier = multipliers[category] || 3;

            // Calculate Target COPT
            const targetCOPT = smv > 0 ? Math.round(smv * multiplier) : 0;

            // Update UI
            document.getElementById('recorderTargetCOPT').textContent = targetCOPT > 0 ? targetCOPT : '-';
            document.getElementById('recorderCategory').textContent = `Category ${category}`;

            // Update section visibility/styling
            const section = document.getElementById('targetCOPTSection');
            if (targetCOPT > 0) {
                section.classList.remove('opacity-50');
            } else {
                section.classList.add('opacity-50');
            }
        }

        function clearAll() {
            if (confirm('Clear local view? (Database remains)')) {
                activities = [];
                renderList();
            }
        }

        let searchTimeout = null;

        function handleSearch(event) {
            const searchTerm = event.target.value.trim().toUpperCase();
            const statusEl = document.getElementById('searchStatus');
            const clearBtn = document.getElementById('clearSearchBtn');

            if (searchTerm) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            if (searchTimeout) clearTimeout(searchTimeout);

            if (!searchTerm) {
                statusEl.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(() => {
                const matchedQCO = allChangeovers.find(q => {
                    const qcoNumber = (q.qcoNumber || '').toUpperCase();
                    const upcomingStyle = (q.upcomingStyle || '').toUpperCase();
                    return qcoNumber === searchTerm ||
                        upcomingStyle === searchTerm ||
                        qcoNumber.includes(searchTerm) ||
                        upcomingStyle.includes(searchTerm);
                });

                if (matchedQCO) {
                    statusEl.textContent = `Found: ${matchedQCO.id || 'QCO'}`;
                    statusEl.classList.remove('hidden', 'text-red-500');
                    statusEl.classList.add('text-emerald-600');

                    const selector = document.getElementById('qcoSelector');
                    let optionExists = Array.from(selector.options).some(opt => opt.value === matchedQCO.id);

                    if (optionExists) {
                        selector.value = matchedQCO.id;
                        handleQCOChange(matchedQCO.id);
                    }
                } else {
                    statusEl.textContent = `No QCO found matching "${searchTerm}"`;
                    statusEl.classList.remove('hidden', 'text-emerald-600');
                    statusEl.classList.add('text-red-500');
                }
            }, 500);
        }

        function clearSearch() {
            document.getElementById('qcoSearch').value = '';
            document.getElementById('searchStatus').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
        }
    </script>


    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-[9000] hidden transition-opacity duration-300 opacity-0">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="editModalContent"
                class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300 scale-95">
                <div class="p-6 md:p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl md:text-2xl font-heading font-bold text-slate-900">Edit Operation</h3>
                        <button onclick="closeEditModal()"
                            class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                            <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                        </button>
                    </div>
                    <div class="space-y-4 md:space-y-5">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Operation</label>
                            <p id="editOpName"
                                class="text-sm md:text-base font-bold text-slate-900 bg-slate-50 p-3 rounded-xl border border-slate-100">
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Start
                                    Time</label>
                                <input type="datetime-local" id="editStartTime" step="1"
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">End
                                    Time</label>
                                <input type="datetime-local" id="editEndTime" step="1"
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Department</label>
                                <select id="editDept"
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all appearance-none">
                                    <option value="">Select Department...</option>
                                    <option value="Production">Production</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Quality">Quality</option>
                                    <option value="Engineering">Engineering</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Remarks</label>
                                <input type="text" id="editRemarks" placeholder="Add remarks..."
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex items-center justify-end gap-3">
                        <button onclick="closeEditModal()"
                            class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-100 transition-all">Cancel</button>
                        <button onclick="saveEditModal()"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-white bg-slate-900 hover:bg-slate-800 shadow-lg shadow-slate-900/20 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Break Timings Modal -->
    <div id="breakModal" class="fixed inset-0 z-[9000] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeBreakModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6">
            <div class="bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-heading font-bold text-slate-800" id="breakModalTitle">Line Schedule</h3>
                    <button onclick="closeBreakModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                        <i data-lucide="x" class="w-4 h-4 text-slate-500"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="breakListContainer"></div>
                    <div
                        class="mt-6 p-4 rounded-xl bg-amber-50 border border-amber-100 text-[10px] text-amber-700 leading-relaxed">
                        <i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i>
                        Note: Active durations are auto-deducted during these windows. Night shift breaks can be
                        recorded once defined.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete Confirmation Modal -->
    <div id="completeConfirmModal" class="fixed inset-0 z-[9000] hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeCompleteConfirmModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6">
            <div class="bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden">
                <div class="px-6 py-5 bg-gradient-to-r from-emerald-50 to-teal-50 border-b border-emerald-100">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                            <i data-lucide="check-circle-2" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-heading font-bold text-slate-900">Complete Changeover?</h3>
                            <p class="text-xs text-slate-500">This action cannot be undone</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4 mb-6">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <span class="text-sm text-slate-600">QCO Number</span>
                            <span class="font-bold text-slate-900" id="confirmQcoNumber">-</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <span class="text-sm text-slate-600">Style</span>
                            <span class="font-bold text-slate-900" id="confirmStyle">-</span>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                            <span class="text-sm text-emerald-700">Operations Completed</span>
                            <span class="font-bold text-emerald-700" id="confirmOpsCount">0/0</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mb-6">
                        <i data-lucide="alert-circle" class="w-3 h-3 inline-block mr-1"></i>
                        This will mark the changeover as completed and calculate final COPT metrics.
                    </p>
                    <div class="flex gap-3">
                        <button onclick="closeCompleteConfirmModal()"
                            class="flex-1 px-5 py-3 rounded-xl text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all">Cancel</button>
                        <button onclick="confirmMarkCompleted()" id="confirmCompleteBtn"
                            class="flex-1 px-5 py-3 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i> Complete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>